<!DOCTYPE html><html lang="en-US" ><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><meta name="generator" content="Jekyll v4.2.1" /><meta property="og:title" content="Making your first Bootable Operating System!" /><meta name="author" content="Mr. Rc" /><meta property="og:locale" content="en_US" /><meta name="description" content="Hey there, Mr. Rc here. Today in this blog, we are going to deep dive into the stuff that happens when you boot your computer and how can you make something like that." /><meta property="og:description" content="Hey there, Mr. Rc here. Today in this blog, we are going to deep dive into the stuff that happens when you boot your computer and how can you make something like that." /><link rel="canonical" href="/posts/Making-your-First-Bootable-Operating-System!/" /><meta property="og:url" content="/posts/Making-your-First-Bootable-Operating-System!/" /><meta property="og:site_name" content="Mr. Rc’s blog" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2021-03-30T09:03:00+05:30" /><meta name="twitter:card" content="summary" /><meta property="twitter:title" content="Making your first Bootable Operating System!" /><meta name="google-site-verification" content="google_meta_tag_verification" /> <script type="application/ld+json"> {"author":{"@type":"Person","name":"Mr. Rc"},"headline":"Making your first Bootable Operating System!","dateModified":"2021-03-30T09:03:00+05:30","datePublished":"2021-03-30T09:03:00+05:30","description":"Hey there, Mr. Rc here. Today in this blog, we are going to deep dive into the stuff that happens when you boot your computer and how can you make something like that.","url":"/posts/Making-your-First-Bootable-Operating-System!/","@type":"BlogPosting","mainEntityOfPage":{"@type":"WebPage","@id":"/posts/Making-your-First-Bootable-Operating-System!/"},"@context":"https://schema.org"}</script><title>Making your first Bootable Operating System! | Mr. Rc's blog</title><link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicons/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicons/favicon-16x16.png"><link rel="manifest" href="/assets/img/favicons/site.webmanifest"><link rel="shortcut icon" href="/assets/img/favicons/favicon.ico"><meta name="apple-mobile-web-app-title" content="Mr. Rc's blog"><meta name="application-name" content="Mr. Rc's blog"><meta name="msapplication-TileColor" content="#da532c"><meta name="msapplication-config" content="/assets/img/favicons/browserconfig.xml"><meta name="theme-color" content="#ffffff"><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://fonts.gstatic.com"><link rel="preconnect" href="https://www.google-analytics.com" crossorigin="use-credentials"><link rel="dns-prefetch" href="https://www.google-analytics.com"><link rel="preconnect" href="https://www.googletagmanager.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://www.googletagmanager.com"><link rel="preconnect" href="https://cdn.jsdelivr.net"><link rel="dns-prefetch" href="https://cdn.jsdelivr.net"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.0.0/dist/css/bootstrap.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.11.2/css/all.min.css"><link rel="stylesheet" href="/assets/css/style.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/magnific-popup@1.1.0/dist/magnific-popup.min.css"> <script src="https://cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script> <script data-ad-client="ca-pub-2858626085073914" async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script> <script defer src="https://cdn.jsdelivr.net/combine/npm/popper.js@1.15.0,npm/bootstrap@4/dist/js/bootstrap.min.js"></script> <script async src="https://cdn.jsdelivr.net/combine/npm/lozad/dist/lozad.min.js,npm/magnific-popup@1/dist/jquery.magnific-popup.min.js"></script> <script defer src="/assets/js/dist/post.min.js"></script> <script defer src="/app.js"></script> <script defer src="https://www.googletagmanager.com/gtag/js?id=UA-199874344-1"></script> <script> document.addEventListener("DOMContentLoaded", function(event) { window.dataLayer = window.dataLayer || []; function gtag(){dataLayer.push(arguments);} gtag('js', new Date()); gtag('config', 'UA-199874344-1'); }); </script><body data-spy="scroll" data-target="#toc"><div id="sidebar" class="d-flex flex-column align-items-end"><div class="profile-wrapper text-center"><div id="avatar"> <a href="/" alt="avatar" class="mx-auto"> <img src="https://i.ibb.co/6W31BDG/skull.jpg" alt="avatar" onerror="this.style.display='none'"> </a></div><div class="site-title mt-3"> <a href="/">Mr. Rc's blog</a></div><div class="site-subtitle font-italic">A collection of Mr. Rc's Blogs.</div></div><ul class="w-100"><li class="nav-item"> <a href="/" class="nav-link"> <i class="fa-fw fas fa-home ml-xl-3 mr-xl-3 unloaded"></i> <span>HOME</span> </a><li class="nav-item"> <a href="/categories/" class="nav-link"> <i class="fa-fw fas fa-stream ml-xl-3 mr-xl-3 unloaded"></i> <span>CATEGORIES</span> </a><li class="nav-item"> <a href="/tags/" class="nav-link"> <i class="fa-fw fas fa-tags ml-xl-3 mr-xl-3 unloaded"></i> <span>TAGS</span> </a><li class="nav-item"> <a href="/archives/" class="nav-link"> <i class="fa-fw fas fa-archive ml-xl-3 mr-xl-3 unloaded"></i> <span>ARCHIVES</span> </a><li class="nav-item"> <a href="/about/" class="nav-link"> <i class="fa-fw fas fa-info ml-xl-3 mr-xl-3 unloaded"></i> <span>ABOUT</span> </a></ul><div class="sidebar-bottom mt-auto d-flex flex-wrap justify-content-center"> <a href="https://github.com/HACKE-RC" aria-label="github" class="order-3" target="_blank" rel="noopener"> <i class="fab fa-github-alt"></i> </a> <a href="https://twitter.com/" aria-label="twitter" class="order-4" target="_blank" rel="noopener"> <i class="fab fa-twitter"></i> </a> <a href=" javascript:location.href = 'mailto:' + ['cr.retsim','gmail.com'].join('@')" aria-label="email" class="order-5" > <i class="fas fa-envelope"></i> </a> <a href="/feed.xml" aria-label="rss" class="order-6" > <i class="fas fa-rss"></i> </a> <span class="icon-border order-2"></span> <span id="mode-toggle-wrapper" class="order-1"> <i class="mode-toggle fas fa-adjust"></i> <script type="text/javascript"> class ModeToggle { static get MODE_KEY() { return "mode"; } static get DARK_MODE() { return "dark"; } static get LIGHT_MODE() { return "light"; } constructor() { if (this.hasMode) { if (this.isDarkMode) { if (!this.isSysDarkPrefer) { this.setDark(); } } else { if (this.isSysDarkPrefer) { this.setLight(); } } } var self = this; /* always follow the system prefers */ this.sysDarkPrefers.addListener(function() { if (self.hasMode) { if (self.isDarkMode) { if (!self.isSysDarkPrefer) { self.setDark(); } } else { if (self.isSysDarkPrefer) { self.setLight(); } } self.clearMode(); } self.updateMermaid(); }); } /* constructor() */ setDark() { $('html').attr(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE); } setLight() { $('html').attr(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE); } clearMode() { $('html').removeAttr(ModeToggle.MODE_KEY); sessionStorage.removeItem(ModeToggle.MODE_KEY); } get sysDarkPrefers() { return window.matchMedia("(prefers-color-scheme: dark)"); } get isSysDarkPrefer() { return this.sysDarkPrefers.matches; } get isDarkMode() { return this.mode == ModeToggle.DARK_MODE; } get isLightMode() { return this.mode == ModeToggle.LIGHT_MODE; } get hasMode() { return this.mode != null; } get mode() { return sessionStorage.getItem(ModeToggle.MODE_KEY); } /* get the current mode on screen */ get modeStatus() { if (this.isDarkMode || (!this.hasMode && this.isSysDarkPrefer) ) { return ModeToggle.DARK_MODE; } else { return ModeToggle.LIGHT_MODE; } } updateMermaid() { if (typeof mermaid !== "undefined") { let expectedTheme = (this.modeStatus === ModeToggle.DARK_MODE? "dark" : "default"); let config = { theme: expectedTheme }; /* re-render the SVG › <https://github.com/mermaid-js/mermaid/issues/311#issuecomment-332557344> */ $(".mermaid").each(function() { let svgCode = $(this).prev().children().html(); $(this).removeAttr("data-processed"); $(this).html(svgCode); }); mermaid.initialize(config); mermaid.init(undefined, ".mermaid"); } } flipMode() { if (this.hasMode) { if (this.isSysDarkPrefer) { if (this.isLightMode) { this.clearMode(); } else { this.setLight(); } } else { if (this.isDarkMode) { this.clearMode(); } else { this.setDark(); } } } else { if (this.isSysDarkPrefer) { this.setLight(); } else { this.setDark(); } } this.updateMermaid(); } /* flipMode() */ } /* ModeToggle */ let toggle = new ModeToggle(); $(".mode-toggle").click(function() { toggle.flipMode(); }); </script> </span></div></div><div id="topbar-wrapper" class="row justify-content-center topbar-down"><div id="topbar" class="col-11 d-flex h-100 align-items-center justify-content-between"> <span id="breadcrumb"> <span> <a href="/"> Posts </a> </span> <span>Making your first Bootable Operating System!</span> </span> <i id="sidebar-trigger" class="fas fa-bars fa-fw"></i><div id="topbar-title"> Post</div><i id="search-trigger" class="fas fa-search fa-fw"></i> <span id="search-wrapper" class="align-items-center"> <i class="fas fa-search fa-fw"></i> <input class="form-control" id="search-input" type="search" aria-label="search" autocomplete="off" placeholder="Search..."> <i class="fa fa-times-circle fa-fw" id="search-cleaner"></i> </span> <span id="search-cancel" >Cancel</span></div></div><div id="main-wrapper"><div id="main"><div class="row"><div id="post-wrapper" class="col-12 col-lg-11 col-xl-8"><div class="post pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><h1 data-toc-skip>Making your first Bootable Operating System!</h1><div class="post-meta text-muted d-flex flex-column"><div> <span class="semi-bold"> Mr. Rc </span> <span class="timeago " data-toggle="tooltip" data-placement="bottom" title="Tue, Mar 30, 2021, 9:03 AM +0530" prep="on" > Mar 30, 2021 <i class="unloaded">2021-03-30T09:03:00+05:30</i> </span></div><div> <span class="readtime" data-toggle="tooltip" data-placement="bottom" title="2748 words">15 min</span></div></div><div class="post-content"><p><strong>Hey there,</strong> <br /> <strong>Mr. Rc here. Today in this blog, we are going to deep dive into the stuff that happens when you boot your computer and how can you make something like that.</strong></p><h2 id="prerequisites">Prerequisites</h2><ul><li><strong>Basic understanding of BIOS and firmware.</strong><li><strong>Basic understanding of assembly language.</strong><li><strong>Basic understanding of stack.</strong></ul><h2 id="boot-sector">Boot sector</h2><blockquote><p>A boot sector is the sector of a persistent data storage device (e.g., hard disk, floppy disk, optical disc, etc.) which contains machine code to be loaded into random-access memory (RAM) and then executed by a computer system’s built-in firmware (e.g., the BIOS). Usually, the very first sector of the hard disk is the boot sector, regardless of sector size (512 or 4096 bytes) and partitioning flavor (MBR or GPT). The purpose of defining one particular sector as the boot sector is inter-operability between various firmwares and various operating systems. <em>~ Wikipedia</em></p></blockquote><h2 id="bootloader">Bootloader</h2><p><strong>At the very core of a computer booting is what we refer to as the boot loader. The boot loader physically reads the first sector or sector 0 from your HD or other media to ultimately bootstrap an OS. When the computer boots it reads the first sector which is exactly 0x200 bytes ( hex) or 512 bytes in decimal. The system that is reading this boot loader is what is referred to as BIOS which is a basic input output system and it loads in 16-bit mode. It does this to be compatible with older processors. Modern processors immediately switch to what we refer to as UEFI which is a more sophisticated IO system however we will focus on the very basics here with BIOS. ~ 0xInfection’s reversing for everyone course.</strong></p><h2 id="making-our-first-bootable-operating-system">Making our first bootable operating system.</h2><p>Before diving in, You should have <a href="https://www.nasm.us/pub/nasm/releasebuilds/2.15rc12/">nasm</a> and <a href="https://www.qemu.org/download/">qemu</a> installed in your machine. Both are available for Windows(not xp) and Linux systems.</p><p>In linux nasm and qemu can be installed through a single command:</p><div class="language-console highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="gp">$</span><span class="w"> </span><span class="nb">sudo </span>apt <span class="nb">install </span>nasm<span class="p">;</span> <span class="nb">sudo </span>apt <span class="nb">install </span>qemu-system-x86
</pre></table></code></div></div><p>As all the installation work is done, Lets starting coding ;) .</p><h2 id="coding-time">Coding time</h2><p>Lets make function that does nothing more than jumping to itself.</p><pre><code class="language-assembly">callme:
    jmp callme
</code></pre><p><strong>This isn’t the code for our operating system, I rather want you to how to use nasm and qemu and also I want to give you basics about opcodes. So create a file with this code then save it as bootsector.asm and then run this command</strong></p><div class="language-console highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="gp">$</span><span class="w"> </span>nasm bootsector.asm <span class="nt">-f</span> bin <span class="nt">-o</span> bootloder.bin
</pre></table></code></div></div><p>Before booting our Operating system, do you know what is a hex dump?</p><p>I think yes but if no then hexdump just means what its name says. <br /> Hex: Base 16 <br /> Dump: You already know that. <br /> <strong>In other words its just a utility that shows the content of a file in hexadecimal(base 16).</strong></p><p>One more and last question for you. Do you know what are opcodes in assembly? <br /> <strong>In the most simplest term I can say that opcodes are just a hex value for every assembly instruction.</strong> <br /> We will start by seeing the opcode of our instructions that we wrote in our bootsector.asm file. <br /> <strong>To do that you should have xxd(linux) or HXD(windows) installed.</strong> <br /> If you are with xxd, just type <code class="language-plaintext highlighter-rouge">xxd bootsector.bin</code> and here you will be able see it. If you are in HXD, just open the file and you will be able to see the hexdump.</p><p><strong>Hexdump</strong></p><div class="language-plaintext highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>00000000: ebfe                                     ..
</pre></table></code></div></div><p>Here we see some hex values. What are they? <br /> <strong>Let me explain</strong> <br /> Do you remember opcodes? <br /> <strong>This hex values are the opcodes of the instructions that we coded in the bootsector.asm file.</strong> <br /> Let’s dig deeper and find what does this means. <br /> Before that, do you know what is a nibble, a bit, a byte.</p><ul><li><strong>A bit = 0 or 1.</strong><li><strong>A nibble = 4 bits</strong><li><strong>A byte = 8 bits.</strong></ul><p>If you don’t know each hex digit represents 4 bits(a nibble). Here in this hexdump we can see two bytes: eb and fe. ebfe is a infinite loop in assembly, it just calls itself. eb is the opcode of jmp instruction and fe is the hex value of an immediate -2. So ebfe combined makes jmp -2. jmp -2 means jump to the current instruction pointer - 2.</p><h2 id="one-step-further">One step further</h2><p>As we have come this far and have learned many things, it’s time to learn more and then boot our first operating system!!</p><h3 id="more-coding">More coding</h3><p>Here is the code of bootsector.asm that we made, now we are going to do some more coding into this and then run our first operating system.</p><div class="language-plaintext highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre><td class="rouge-code"><pre>loop:
    jmp loop
</pre></table></code></div></div><p>Let’s add some more stuff to this piece of code.</p><div class="language-plaintext highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre><td class="rouge-code"><pre>loop:
    jmp loop

db 0x10
</pre></table></code></div></div><p>Save it and make a bin file of it. <code class="language-plaintext highlighter-rouge">nasm bootsector.asm -f bin -o bootsector.bin</code> <strong>Now, let’s look at the hexdump of this file. It looks like this</strong>:</p><div class="language-plaintext highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>00000000: ebfe 10                                  ...
</pre></table></code></div></div><p>If you don’t know <code class="language-plaintext highlighter-rouge">db(data byte)</code> instruction is used for allocate some space and fill it with some data. As a result we can see 10 in our hex dump.</p><p><strong>This isn’t enough. Let’s add your name to this file.</strong></p><div class="language-plaintext highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre><td class="rouge-code"><pre>loop:
    jmp loop

db 0x10
db 'Hello world, Mr. Rc on this side'
</pre></table></code></div></div><p>Let’s make a bin file again and look at the hexdump of this file.</p><div class="language-plaintext highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>nasm bootsector.asm -f bin -o bootsector.bin
</pre></table></code></div></div><p><strong>Hexdump</strong></p><div class="language-plaintext highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre><td class="rouge-code"><pre>00000000: ebfe 1048 656c 6c6f 2077 6f72 6c64 2c20  ...Hello world,
00000010: 4d72 2e20 5263 206f 6e20 7468 6973 2073  Mr. Rc on this s
00000020: 6964 65                                  ide
</pre></table></code></div></div><p><strong>We already know why is thee <code class="language-plaintext highlighter-rouge">eb</code> and <code class="language-plaintext highlighter-rouge">fe</code>, but why do we have that other hex values?</strong> <br /> If you look closely on the right side, you can see it is the ascii translation of what is in the center column. The first three dots indicate that it wasn’t able to find the character for those hex values or ascii values. After first 3 bytes you can see there is a 48. 48 in hex = 72 in decimal and 72 is the ascii value of capital H. 65 in decimal is 101 and 101 ascii = small e. It goes for every character to end.</p><h2 id="booting-time">Booting time</h2><p>Now that we have done coding and understood many things, we’re going to just add two lines to our code and then our first ever operating system will be able to boot.</p><h3 id="coding-time-1">Coding time</h3><p>Write this into your bootsector.asm file, I will explain the code later.</p><div class="language-plaintext highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
</pre><td class="rouge-code"><pre>loop:
    jmp loop
db 0x10
db 'Hello world, Mr. Rc on this side'

times 0x1fe-($-$$) db 0
dw 0xaa55
</pre></table></code></div></div><p>It’s ok if you don’t understand what this means. Let us understand what does this all means to us. <br /> <strong>We all already know what the first four lines means. Let us understand the last two lines.</strong><br /> <code class="language-plaintext highlighter-rouge">times 0x1fe-($-$$) db</code> This instruction will simply subtract the left bytes with 0x200 or 512 in decimal. But why 0x200 ? <br /> That’s because we already know</p><blockquote><p>When the computer boots it reads the first sector which is exactly 0x200 bytes ( hex) or 512 bytes in decimal. ~ Bootloader paragraph <br /> For this reason we have to pad the file with exactly 512 bytes and that’s why we are using that instruction.</p></blockquote><h3 id="magic-number">Magic number</h3><p>If you look at the code again, we have allocated space for 0xaa55. Why that? <br /> <strong>0xaa55 is a magic number which is a signature which a CPU looks to identify a boot sector.</strong></p><h3 id="hexdump-time">Hexdump time</h3><p>We are very close to booting our first operating system, but before that let’s just see how it’s hexdump looks like because there is something amazing to see. <br /> Make binary:</p><div class="language-plaintext highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>nasm bootsector.asm -f bin -o bootsector.bin
</pre></table></code></div></div><p>View the hexdump:</p><div class="language-plaintext highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>xxd bootsector.bin
</pre></table></code></div></div><p>Here is how it looks like:</p><div class="language-plaintext highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
</pre><td class="rouge-code"><pre>00000000: ebfe 1048 656c 6c6f 2077 6f72 6c64 2c20  ...Hello world,
00000010: 4d72 2e20 5263 206f 6e20 7468 6973 2073  Mr. Rc on this s
00000020: 6964 6500 0000 0000 0000 0000 0000 0000  ide.............
00000030: 0000 0000 0000 0000 0000 0000 0000 0000  ................
00000040: 0000 0000 0000 0000 0000 0000 0000 0000  ................
00000050: 0000 0000 0000 0000 0000 0000 0000 0000  ................
00000060: 0000 0000 0000 0000 0000 0000 0000 0000  ................
00000070: 0000 0000 0000 0000 0000 0000 0000 0000  ................
00000080: 0000 0000 0000 0000 0000 0000 0000 0000  ................
00000090: 0000 0000 0000 0000 0000 0000 0000 0000  ................
000000a0: 0000 0000 0000 0000 0000 0000 0000 0000  ................
000000b0: 0000 0000 0000 0000 0000 0000 0000 0000  ................
000000c0: 0000 0000 0000 0000 0000 0000 0000 0000  ................
000000d0: 0000 0000 0000 0000 0000 0000 0000 0000  ................
000000e0: 0000 0000 0000 0000 0000 0000 0000 0000  ................
000000f0: 0000 0000 0000 0000 0000 0000 0000 0000  ................
00000100: 0000 0000 0000 0000 0000 0000 0000 0000  ................
00000110: 0000 0000 0000 0000 0000 0000 0000 0000  ................
00000120: 0000 0000 0000 0000 0000 0000 0000 0000  ................
00000130: 0000 0000 0000 0000 0000 0000 0000 0000  ................
00000140: 0000 0000 0000 0000 0000 0000 0000 0000  ................
00000150: 0000 0000 0000 0000 0000 0000 0000 0000  ................
00000160: 0000 0000 0000 0000 0000 0000 0000 0000  ................
00000170: 0000 0000 0000 0000 0000 0000 0000 0000  ................
00000180: 0000 0000 0000 0000 0000 0000 0000 0000  ................
00000190: 0000 0000 0000 0000 0000 0000 0000 0000  ................
000001a0: 0000 0000 0000 0000 0000 0000 0000 0000  ................
000001b0: 0000 0000 0000 0000 0000 0000 0000 0000  ................
000001c0: 0000 0000 0000 0000 0000 0000 0000 0000  ................
000001d0: 0000 0000 0000 0000 0000 0000 0000 0000  ................
000001e0: 0000 0000 0000 0000 0000 0000 0000 0000  ................
000001f0: 0000 0000 0000 0000 0000 0000 0000 55aa  ..............U.
</pre></table></code></div></div><p>As we can see that the first some bytes that we already analysed are at their normal place and then our whole file is padded with zeros and at last we have that magic number. The last two bytes of this file are the reverse of what we coded. We coded <code class="language-plaintext highlighter-rouge">aa 55</code> and it became <code class="language-plaintext highlighter-rouge">55 aa</code>, if you have guessed it right then you’re serious with this post. It’s because of the endianness which is little endian at this time.</p><h2 id="booting-time-1">Booting time</h2><p>After learning and understanding so much things, finally we’re going to boot our Operating system. <br /> To boot it, make sure you have made a bin file of bootsector.asm. If you’ve not done that then run this command:</p><div class="language-plaintext highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>nasm bootsector.asm -f bin -o bootsector.bin
</pre></table></code></div></div><p>Then run this command to boot it:</p><div class="language-plaintext highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>qemu-system-x86_64 bootsector.bin
</pre></table></code></div></div><p><strong>This will run your operating system on the emulator but remember it willn’t show anything to us because it’s just running a infinite loop. However, We’ve made our first operating system and we’ll go a step further and make this more good.</strong></p><h2 id="making-our-os-more-awesome">Making our OS more awesome.</h2><p>You’ve came so far and I can admit it that you’re the one who has the capability of sticking with one thing until you fully understand it. Now it’s time for making a operating system that boots and asks for input. <br /> Here is the code that you’ll need to do make it happen. Don’t get scared by it, I try will explain every line to you.</p><div class="language-plaintext highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
</pre><td class="rouge-code"><pre>[org 0x7c00]

mov bp, 0xffff
mov sp, bp

call set_video_mode
call get_char_input

jmp $

set_video_mode:
	mov al, 0x03
	mov ah, 0x00
	int 0x10
	ret

get_char_input:
	xor ah, ah
	int 0x16

	mov ah, 0x0e
	int 0x10

	jmp get_char_input

times 0x1fe-($-$$) db 0
dw 0xaa55
</pre></table></code></div></div><h3 id="line-1">Line 1</h3><p>The first line is a bit scary but ofcourse we are working at very low level and we should see this kind of stuff let me explain its use. The first instruction will simply move our machine code to the address 0x7c00. 0x7c00 is the address which contains all the code that will be loaded into RAM by the bootloader firmware (firmware is simply code that runs before an OS runs like what we are doing).</p><h2 id="line-2-5">Line 2-5</h2><p><strong>On line 2, we are setting our base pointer. If you don’t know what is base pointer then In the simplest terms I can say that its kind of a CPU register that contains the address of the base of the stack. We set our base pointer to point at 0xffff and we set stack pointer to base pointer. 0xffff is just some free place to store data before our system boots like 0x7c00.</strong> <br /> On line 4 and 5, we call two different functions. The first one is <code class="language-plaintext highlighter-rouge">set_video_mode</code> and the other one is <code class="language-plaintext highlighter-rouge">get_char_input</code>.</p><p>Let’s look at the code of those functions and understand what they do.</p><div class="language-plaintext highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre><td class="rouge-code"><pre>set_video_mode:
	mov al, 0x03
	mov ah, 0x00
	int 0x10
	ret
</pre></table></code></div></div><p>The first line is just moving the immediate 0x03 to al, then we move 0x00 to ah register and the we use the int instruction with 0x10 value. Let me explain what’s this code is all about. If you’re familiar with calling conventions, you would quickly recognise that there is no calling convention there which takes arguments from al and ah registers but this isn’t a <code class="language-plaintext highlighter-rouge">call</code> it’s a <code class="language-plaintext highlighter-rouge">int</code> instruction. The INT n instruction is the general mnemonic for executing a software-generated call to an interrupt handler. Here we are calling it with 0x10. INT 0x10 instruction is used to setup the video mode when the system boots and as it’s not a normal call to a function the arguments should be stored in ah and al registers. In INT 10 instruction, we use al register to specify desired video mode. Here is the list of all the modes that we can use:</p><ul><li>AL=0x00 - text mode. 40x25. 16 colors. 8 pages.<li>AL=0x03 - text mode. 80x25. 16 colors. 8 pages.<li>AL=0x13 - graphical mode. 40x25. 256 colors. 320x200 pixels. 1 page.</ul><p>Also, we can specify different screen types by changing the values of registers to this values:</p><ul><li><strong>AH=0x00: Video mode.</strong><li><strong>AX=0x1003: Blinking mode</strong><li><strong>AH=0x13: Write string</strong><li><strong>AH=0x03: Get cursor position</strong></ul><p>Here we have set AH to 0x00 and al to 0x03. That means we have chosen the text mode with 80x25 screen size, which have 16 colors and also we are using the video mode.</p><p>Let’s dive into the second function(<code class="language-plaintext highlighter-rouge">get_char_input</code>). The first we are doing is xoring ah. When we xor a number by itself, the result is always zero. So, we’re just zeroing our ah register and then we call INT 0x16 instruction. INT 0x16 is used for controlling keyboard related stuff(i.e. reading keystrokes, etc.). Setting ah to 0 means that we want to read input from the keyboard. The next line <code class="language-plaintext highlighter-rouge">mov ah, 0x0e</code> is setting ah register to hex 0e or 14 decimal and then we called INT 0x10 but wait our register value is different this time. When the value of ah is 0e before it we call INT 0x10 it would work like print and it would print whatever the character. At the end we pad the file like we would normally do.</p><h2 id="booting-time-2">Booting time</h2><p>As we’ve understood everything that what’s going on, we can boot out first operating system. <br /> To do that we have to first make a bin file of our asm file. <code class="language-plaintext highlighter-rouge">nasm bootsector.asm -f bin -o bootloder.bin</code> Then run it with qemu: <code class="language-plaintext highlighter-rouge">qemu-system-x86_64 bootsector.bin</code> Now your operating system has been booted and you can type whatever you want. <img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="https://i.ibb.co/k9kR4GG/image.png" alt="image.png" /> It took a little but finally what we’ve done is amazing. Now it’s time to show this to your friends and twitter. If you read this much and you were able to make this then tag me on twitter, my username is coder_rc .</p><h1 id="conclusion">Conclusion</h1><p><strong>I learned so much and I hope you did too. I got the idea of writing this blog post when I was reading 0xinfection’s reversing for everyone book. One of it’s part was bootsector basics and after reading it, I was amazed and I thought it would be great if I would be able to teach this to others. I also learnt many things that I probably skipped in those chapters. It took me around 5-6 hour to write this I hope you learned something new.</strong></p></div><div class="post-tail-wrapper text-muted"><div class="post-meta mb-3"> <i class="far fa-folder-open fa-fw mr-1"></i> <a href='/categories/programming/'>Programming</a></div><div class="post-tags"> <i class="fa fa-tags fa-fw mr-1"></i> <a href="/tags/assembly/" class="post-tag no-text-decoration" >Assembly</a> <a href="/tags/operating-system/" class="post-tag no-text-decoration" >Operating system</a></div><div class="post-tail-bottom d-flex justify-content-between align-items-center mt-3 pt-5 pb-2"><div class="license-wrapper"> This post is licensed under <a href="https://creativecommons.org/licenses/by/4.0/">CC BY 4.0</a> by the author.</div><div class="share-wrapper"> <span class="share-label text-muted mr-1">Share</span> <span class="share-icons"> <a href="https://twitter.com/intent/tweet?text=Making your first Bootable Operating System! - Mr. Rc's blog&url=/posts/Making-your-First-Bootable-Operating-System!/" data-toggle="tooltip" data-placement="top" title="Twitter" target="_blank" rel="noopener" aria-label="Twitter"> <i class="fa-fw fab fa-twitter"></i> </a> <a href="https://www.facebook.com/sharer/sharer.php?title=Making your first Bootable Operating System! - Mr. Rc's blog&u=/posts/Making-your-First-Bootable-Operating-System!/" data-toggle="tooltip" data-placement="top" title="Facebook" target="_blank" rel="noopener" aria-label="Facebook"> <i class="fa-fw fab fa-facebook-square"></i> </a> <a href="https://telegram.me/share?text=Making your first Bootable Operating System! - Mr. Rc's blog&url=/posts/Making-your-First-Bootable-Operating-System!/" data-toggle="tooltip" data-placement="top" title="Telegram" target="_blank" rel="noopener" aria-label="Telegram"> <i class="fa-fw fab fa-telegram"></i> </a> <i class="fa-fw fas fa-link small" onclick="copyLink()" data-toggle="tooltip" data-placement="top" title="Copy link"></i> </span></div></div></div></div></div><div id="panel-wrapper" class="col-xl-3 pl-2 text-muted topbar-down"><div class="access"><div id="access-lastmod" class="post"> <span>Recent Update</span><ul class="post-content pl-0 pb-1 ml-1 mt-2"><li><a href="/posts/WinAPI-Using-Registry-Playing-With-Env-Variables/">Windows API - Let's use the register to change our Environment!</a><li><a href="/posts/WinAPI-Environment-Variables/">Windows API - Let's Play with the Windows Environment Variables!</a></ul></div><div id="access-tags"> <span>Trending Tags</span><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/windows/">Windows</a> <a class="post-tag" href="/tags/windows-api-series/">Windows API Series</a> <a class="post-tag" href="/tags/virtual-memory-management/">Virtual Memory Management</a> <a class="post-tag" href="/tags/heap-api/">Heap API</a> <a class="post-tag" href="/tags/assembly/">Assembly</a> <a class="post-tag" href="/tags/operating-system/">Operating system</a> <a class="post-tag" href="/tags/windows-registry/">Windows Registry</a></div></div></div><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.js"></script><div id="toc-wrapper" class="pl-0 pr-4 mb-5"> <span class="pl-3 pt-2 mb-2">Contents</span><nav id="toc" data-toggle="toc"></nav></div></div></div><div class="row"><div class="col-12 col-lg-11 col-xl-8"><div id="post-extend-wrapper" class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><div id="related-posts" class="mt-5 mb-2 mb-sm-4"><h3 class="pt-2 mt-1 mb-4 ml-1" data-toc-skip>Further Reading</h3><div class="card-deck mb-4"><div class="card"> <a href="/posts/Windows-API-Basics-of-Virtual-Memory-Management-API/"><div class="card-body"> <span class="timeago small" > Apr 15, 2021 <i class="unloaded">2021-04-15T09:03:00+05:30</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Windows API - Basics of Virtual Memory Management API.</h3><div class="text-muted small"><p> The Virtual Memory Manager in Windows (WMM) is available for user mode programs and can be used by the Win32 APIs to allocate memory and free them in the user space. From this blog, I am going to ...</p></div></div></a></div><div class="card"> <a href="/posts/Windows-API-More-on-Virtual-Memory/"><div class="card-body"> <span class="timeago small" > Apr 18, 2021 <i class="unloaded">2021-04-18T09:03:00+05:30</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Windows API - More on Virtual Memory.</h3><div class="text-muted small"><p> In this blog, we are going to have a look at some basic memory related things that we can do with the API functions that we learnt about in last blog post along with a new function VirtualQuery. B...</p></div></div></a></div><div class="card"> <a href="/posts/Windows-API-Heap-Functions/"><div class="card-body"> <span class="timeago small" > Apr 26, 2021 <i class="unloaded">2021-04-26T09:03:00+05:30</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Windows API - Let's learn about heap in deep!</h3><div class="text-muted small"><p> In this blog, We are continuing our series and going to study some Windows API functions related to Heap. We’ll see how to use this functions and how they can be useful to us with code examples and...</p></div></div></a></div></div></div><div class="post-navigation d-flex justify-content-between"> <span class="btn btn-outline-primary disabled" prompt="Older"><p>-</p></span> <a href="/posts/What's-inside-Windows/" class="btn btn-outline-primary" prompt="Newer"><p>What's inside Windows?</p></a></div></div></div></div><footer class="d-flex w-100 justify-content-center"><div class="d-flex justify-content-between align-items-center"><div class="footer-left"><p class="mb-0"> © 2022 <a href="https://twitter.com/coder_rc">Mr. Rc</a>. <span data-toggle="tooltip" data-placement="top" title="Except where otherwise noted, the blog posts on this site are licensed under the Creative Commons Attribution 4.0 International (CC BY 4.0) License by the author.">Some rights reserved.</span></p></div><div class="footer-right"><p class="mb-0"> Powered by <a href="https://jekyllrb.com" target="_blank" rel="noopener">Jekyll</a> with <a href="https://github.com/cotes2020/jekyll-theme-chirpy" target="_blank" rel="noopener">Chirpy</a> theme.</p></div></div></footer></div><div id="search-result-wrapper" class="d-flex justify-content-center unloaded"><div class="col-12 col-sm-11 post-content"><div id="search-hints"><h4 class="text-muted mb-4">Trending Tags</h4><a class="post-tag" href="/tags/windows/">Windows</a> <a class="post-tag" href="/tags/windows-api-series/">Windows API Series</a> <a class="post-tag" href="/tags/virtual-memory-management/">Virtual Memory Management</a> <a class="post-tag" href="/tags/heap-api/">Heap API</a> <a class="post-tag" href="/tags/assembly/">Assembly</a> <a class="post-tag" href="/tags/operating-system/">Operating system</a> <a class="post-tag" href="/tags/windows-registry/">Windows Registry</a></div><div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div></div></div></div><div id="mask"></div><a id="back-to-top" href="#" aria-label="back-to-top" class="btn btn-lg btn-box-shadow" role="button"> <i class="fas fa-angle-up"></i> </a> <script src="https://cdn.jsdelivr.net/npm/simple-jekyll-search@1.7.3/dest/simple-jekyll-search.min.js"></script> <script> SimpleJekyllSearch({ searchInput: document.getElementById('search-input'), resultsContainer: document.getElementById('search-results'), json: '/assets/js/data/search.json', searchResultTemplate: '<div class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-lg-4 pr-lg-4 pl-xl-0 pr-xl-0"> <a href="{url}">{title}</a><div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1"> {categories} {tags}</div><p>{snippet}</p></div>', noResultsText: '<p class="mt-5">Oops! No result founds.</p>', templateMiddleware: function(prop, value, template) { if (prop === 'categories') { if (value === '') { return `${value}`; } else { return `<div class="mr-sm-4"><i class="far fa-folder fa-fw"></i>${value}</div>`; } } if (prop === 'tags') { if (value === '') { return `${value}`; } else { return `<div><i class="fa fa-tag fa-fw"></i>${value}</div>`; } } } }); </script>
