<!DOCTYPE html><html lang="en-US" ><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><meta name="generator" content="Jekyll v4.2.1" /><meta property="og:title" content="Windows API - Let’s learn about heap in deep!" /><meta name="author" content="Mr. Rc" /><meta property="og:locale" content="en_US" /><meta name="description" content="In this blog, We are continuing our series and going to study some Windows API functions related to Heap. We’ll see how to use this functions and how they can be useful to us with code examples and explanation of each function. Let’s get started!" /><meta property="og:description" content="In this blog, We are continuing our series and going to study some Windows API functions related to Heap. We’ll see how to use this functions and how they can be useful to us with code examples and explanation of each function. Let’s get started!" /><link rel="canonical" href="/posts/Windows-API-Heap-Functions/" /><meta property="og:url" content="/posts/Windows-API-Heap-Functions/" /><meta property="og:site_name" content="Mr. Rc’s blog" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2021-04-26T09:03:00+05:30" /><meta name="twitter:card" content="summary" /><meta property="twitter:title" content="Windows API - Let’s learn about heap in deep!" /><meta name="google-site-verification" content="google_meta_tag_verification" /> <script type="application/ld+json"> {"author":{"@type":"Person","name":"Mr. Rc"},"headline":"Windows API - Let’s learn about heap in deep!","dateModified":"2021-04-26T09:03:00+05:30","datePublished":"2021-04-26T09:03:00+05:30","description":"In this blog, We are continuing our series and going to study some Windows API functions related to Heap. We’ll see how to use this functions and how they can be useful to us with code examples and explanation of each function. Let’s get started!","url":"/posts/Windows-API-Heap-Functions/","@type":"BlogPosting","mainEntityOfPage":{"@type":"WebPage","@id":"/posts/Windows-API-Heap-Functions/"},"@context":"https://schema.org"}</script><title>Windows API - Let's learn about heap in deep! | Mr. Rc's blog</title><link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicons/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicons/favicon-16x16.png"><link rel="manifest" href="/assets/img/favicons/site.webmanifest"><link rel="shortcut icon" href="/assets/img/favicons/favicon.ico"><meta name="apple-mobile-web-app-title" content="Mr. Rc's blog"><meta name="application-name" content="Mr. Rc's blog"><meta name="msapplication-TileColor" content="#da532c"><meta name="msapplication-config" content="/assets/img/favicons/browserconfig.xml"><meta name="theme-color" content="#ffffff"><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://fonts.gstatic.com"><link rel="preconnect" href="https://www.google-analytics.com" crossorigin="use-credentials"><link rel="dns-prefetch" href="https://www.google-analytics.com"><link rel="preconnect" href="https://www.googletagmanager.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://www.googletagmanager.com"><link rel="preconnect" href="https://cdn.jsdelivr.net"><link rel="dns-prefetch" href="https://cdn.jsdelivr.net"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.0.0/dist/css/bootstrap.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.11.2/css/all.min.css"><link rel="stylesheet" href="/assets/css/style.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/magnific-popup@1.1.0/dist/magnific-popup.min.css"> <script src="https://cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script> <script data-ad-client="ca-pub-2858626085073914" async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script> <script defer src="https://cdn.jsdelivr.net/combine/npm/popper.js@1.15.0,npm/bootstrap@4/dist/js/bootstrap.min.js"></script> <script async src="https://cdn.jsdelivr.net/combine/npm/lozad/dist/lozad.min.js,npm/magnific-popup@1/dist/jquery.magnific-popup.min.js"></script> <script defer src="/assets/js/dist/post.min.js"></script> <script defer src="/app.js"></script> <script defer src="https://www.googletagmanager.com/gtag/js?id=UA-199874344-1"></script> <script> document.addEventListener("DOMContentLoaded", function(event) { window.dataLayer = window.dataLayer || []; function gtag(){dataLayer.push(arguments);} gtag('js', new Date()); gtag('config', 'UA-199874344-1'); }); </script><body data-spy="scroll" data-target="#toc"><div id="sidebar" class="d-flex flex-column align-items-end"><div class="profile-wrapper text-center"><div id="avatar"> <a href="/" alt="avatar" class="mx-auto"> <img src="https://i.ibb.co/6W31BDG/skull.jpg" alt="avatar" onerror="this.style.display='none'"> </a></div><div class="site-title mt-3"> <a href="/">Mr. Rc's blog</a></div><div class="site-subtitle font-italic">A collection of Mr. Rc's Blogs.</div></div><ul class="w-100"><li class="nav-item"> <a href="/" class="nav-link"> <i class="fa-fw fas fa-home ml-xl-3 mr-xl-3 unloaded"></i> <span>HOME</span> </a><li class="nav-item"> <a href="/categories/" class="nav-link"> <i class="fa-fw fas fa-stream ml-xl-3 mr-xl-3 unloaded"></i> <span>CATEGORIES</span> </a><li class="nav-item"> <a href="/tags/" class="nav-link"> <i class="fa-fw fas fa-tags ml-xl-3 mr-xl-3 unloaded"></i> <span>TAGS</span> </a><li class="nav-item"> <a href="/archives/" class="nav-link"> <i class="fa-fw fas fa-archive ml-xl-3 mr-xl-3 unloaded"></i> <span>ARCHIVES</span> </a><li class="nav-item"> <a href="/about/" class="nav-link"> <i class="fa-fw fas fa-info ml-xl-3 mr-xl-3 unloaded"></i> <span>ABOUT</span> </a></ul><div class="sidebar-bottom mt-auto d-flex flex-wrap justify-content-center"> <a href="https://github.com/HACKE-RC" aria-label="github" class="order-3" target="_blank" rel="noopener"> <i class="fab fa-github-alt"></i> </a> <a href="https://twitter.com/" aria-label="twitter" class="order-4" target="_blank" rel="noopener"> <i class="fab fa-twitter"></i> </a> <a href=" javascript:location.href = 'mailto:' + ['cr.retsim','gmail.com'].join('@')" aria-label="email" class="order-5" > <i class="fas fa-envelope"></i> </a> <a href="/feed.xml" aria-label="rss" class="order-6" > <i class="fas fa-rss"></i> </a> <span class="icon-border order-2"></span> <span id="mode-toggle-wrapper" class="order-1"> <i class="mode-toggle fas fa-adjust"></i> <script type="text/javascript"> class ModeToggle { static get MODE_KEY() { return "mode"; } static get DARK_MODE() { return "dark"; } static get LIGHT_MODE() { return "light"; } constructor() { if (this.hasMode) { if (this.isDarkMode) { if (!this.isSysDarkPrefer) { this.setDark(); } } else { if (this.isSysDarkPrefer) { this.setLight(); } } } var self = this; /* always follow the system prefers */ this.sysDarkPrefers.addListener(function() { if (self.hasMode) { if (self.isDarkMode) { if (!self.isSysDarkPrefer) { self.setDark(); } } else { if (self.isSysDarkPrefer) { self.setLight(); } } self.clearMode(); } self.updateMermaid(); }); } /* constructor() */ setDark() { $('html').attr(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE); } setLight() { $('html').attr(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE); } clearMode() { $('html').removeAttr(ModeToggle.MODE_KEY); sessionStorage.removeItem(ModeToggle.MODE_KEY); } get sysDarkPrefers() { return window.matchMedia("(prefers-color-scheme: dark)"); } get isSysDarkPrefer() { return this.sysDarkPrefers.matches; } get isDarkMode() { return this.mode == ModeToggle.DARK_MODE; } get isLightMode() { return this.mode == ModeToggle.LIGHT_MODE; } get hasMode() { return this.mode != null; } get mode() { return sessionStorage.getItem(ModeToggle.MODE_KEY); } /* get the current mode on screen */ get modeStatus() { if (this.isDarkMode || (!this.hasMode && this.isSysDarkPrefer) ) { return ModeToggle.DARK_MODE; } else { return ModeToggle.LIGHT_MODE; } } updateMermaid() { if (typeof mermaid !== "undefined") { let expectedTheme = (this.modeStatus === ModeToggle.DARK_MODE? "dark" : "default"); let config = { theme: expectedTheme }; /* re-render the SVG › <https://github.com/mermaid-js/mermaid/issues/311#issuecomment-332557344> */ $(".mermaid").each(function() { let svgCode = $(this).prev().children().html(); $(this).removeAttr("data-processed"); $(this).html(svgCode); }); mermaid.initialize(config); mermaid.init(undefined, ".mermaid"); } } flipMode() { if (this.hasMode) { if (this.isSysDarkPrefer) { if (this.isLightMode) { this.clearMode(); } else { this.setLight(); } } else { if (this.isDarkMode) { this.clearMode(); } else { this.setDark(); } } } else { if (this.isSysDarkPrefer) { this.setLight(); } else { this.setDark(); } } this.updateMermaid(); } /* flipMode() */ } /* ModeToggle */ let toggle = new ModeToggle(); $(".mode-toggle").click(function() { toggle.flipMode(); }); </script> </span></div></div><div id="topbar-wrapper" class="row justify-content-center topbar-down"><div id="topbar" class="col-11 d-flex h-100 align-items-center justify-content-between"> <span id="breadcrumb"> <span> <a href="/"> Posts </a> </span> <span>Windows API - Let's learn about heap in deep!</span> </span> <i id="sidebar-trigger" class="fas fa-bars fa-fw"></i><div id="topbar-title"> Post</div><i id="search-trigger" class="fas fa-search fa-fw"></i> <span id="search-wrapper" class="align-items-center"> <i class="fas fa-search fa-fw"></i> <input class="form-control" id="search-input" type="search" aria-label="search" autocomplete="off" placeholder="Search..."> <i class="fa fa-times-circle fa-fw" id="search-cleaner"></i> </span> <span id="search-cancel" >Cancel</span></div></div><div id="main-wrapper"><div id="main"><div class="row"><div id="post-wrapper" class="col-12 col-lg-11 col-xl-8"><div class="post pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><h1 data-toc-skip>Windows API - Let's learn about heap in deep!</h1><div class="post-meta text-muted d-flex flex-column"><div> <span class="semi-bold"> Mr. Rc </span> <span class="timeago " data-toggle="tooltip" data-placement="bottom" title="Mon, Apr 26, 2021, 9:03 AM +0530" prep="on" > Apr 26, 2021 <i class="unloaded">2021-04-26T09:03:00+05:30</i> </span></div><div> <span class="readtime" data-toggle="tooltip" data-placement="bottom" title="1693 words">9 min</span></div></div><div class="post-content"><p>In this blog, We are continuing our series and going to study some Windows API functions related to Heap. We’ll see how to use this functions and how they can be useful to us with code examples and explanation of each function. Let’s get started!</p><h1 id="1-heapcreate">1. HeapCreate</h1><p><code class="language-plaintext highlighter-rouge">HeapCreate</code> function is used to create the heap at the runtime. After the heap is created, we can use other functions to do things on this allocated heap. We will see that later. For now, let’s look at the syntax of this function.</p><p>Here it is:</p><div class="language-c highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre><td class="rouge-code"><pre><span class="n">HANDLE</span> <span class="nf">HeapCreate</span><span class="p">(</span>
  <span class="n">DWORD</span>  <span class="n">flOptions</span><span class="p">,</span>
  <span class="n">SIZE_T</span> <span class="n">dwInitialSize</span><span class="p">,</span>
  <span class="n">SIZE_T</span> <span class="n">dwMaximumSize</span>
<span class="p">);</span>
</pre></table></code></div></div><p>As you can see, the type of this function is <code class="language-plaintext highlighter-rouge">HANDLE</code>, <code class="language-plaintext highlighter-rouge">HANDLE</code> type is just a pointer to some memory in heap. So this means that this function will return a memory address from the heap and that’s what we expect from after creating heap. Now, let’s have a look at the arguments.</p><p>The first arguments is <code class="language-plaintext highlighter-rouge">flOption</code>. This argument is used to specify the heap allocation options. This are the valid parameter for this argument:</p><p><a href="https://ibb.co/2jNWXqR"><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="https://i.ibb.co/HrdBm7R/options.png" alt="options" /></a></p><p>If you don’t want to use any of these options, you can specify 0 that will not use any of these options.</p><p>The second argument is <code class="language-plaintext highlighter-rouge">dwInitialSize</code>. This argument is used to specify the size of heap <em>in bytes</em>. This is the initial size of the created heap and this can be expanded more by specifying the next argument. If you specify 0 as the third argument, the function will allocate a whole page.</p><p>The third and last argument is <code class="language-plaintext highlighter-rouge">dwMaximumSize</code>. This is used to specify the maximum size of heap. If this value is too big, this values will be rounded to the maximum page size of the machine.</p><h2 id="return-value">Return Value</h2><p>The function returns a handle to the created heap region when it succeeds. The function returns a <code class="language-plaintext highlighter-rouge">NULL</code> if the function fails.</p><p>Now, we have created heap. The next thing to do is to Allocate the created heap. For creating heap, we have a function from the Windows API called <code class="language-plaintext highlighter-rouge">HeapAlloc</code>. Now, let’s look at this function.</p><h1 id="2-heapalloc">2. HeapAlloc</h1><p>This function is used to allocate heap on the created heap. The function syntax looks like this:</p><div class="language-c highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre><td class="rouge-code"><pre><span class="n">DECLSPEC_ALLOCATOR</span> <span class="n">LPVOID</span> <span class="nf">HeapAlloc</span><span class="p">(</span>
  <span class="n">HANDLE</span> <span class="n">hHeap</span><span class="p">,</span>
  <span class="n">DWORD</span>  <span class="n">dwFlags</span><span class="p">,</span>
  <span class="n">SIZE_T</span> <span class="n">dwBytes</span>
<span class="p">);</span>
</pre></table></code></div></div><p>Forget about the <code class="language-plaintext highlighter-rouge">DECLSPEC_ALLOCATOR</code> type of the function. The actual type of the function is <code class="language-plaintext highlighter-rouge">LPVOID</code>, if you read my blogs you probably already know what this type means. <code class="language-plaintext highlighter-rouge">LPVOID</code> is just a pointer to a void object, so we can expect this function to return a pointer that will point to the start of the the heap that we are going to allocate. Now, let’s look at the function arguments.</p><p>The first argument is <code class="language-plaintext highlighter-rouge">hHeap</code> which is a handle to heap that we allocated. The heap handle is just the return value from <code class="language-plaintext highlighter-rouge">HeapAlloc</code> function.</p><p>The second argument is <code class="language-plaintext highlighter-rouge">dwFlags</code>. This argument is almost same as the <code class="language-plaintext highlighter-rouge">flOptions</code> argument in the <code class="language-plaintext highlighter-rouge">HeapCreate</code> function. If you specify any option that is different from the option that you specified in the <code class="language-plaintext highlighter-rouge">HeapCreate</code> function, it’ll be overwritten and the argument that you passed into <code class="language-plaintext highlighter-rouge">dwFlags</code> will be used. This are the valid parameters for <code class="language-plaintext highlighter-rouge">dwFlags</code>:</p><p><a href="https://ibb.co/2jNWXqR"><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="https://i.ibb.co/HrdBm7R/options.png" alt="options" /></a></p><p>The third and last argument is <code class="language-plaintext highlighter-rouge">dwBytes</code>, This is the amount of bytes to be allocated.</p><h2 id="return-value-1">Return Value</h2><p>If the function succeeds, it will return a pointer to the memory block that is allocated on the heap. If the function fails and you have not specified <code class="language-plaintext highlighter-rouge">HEAP_GENERATE_EXCEPTIONS</code> in the <code class="language-plaintext highlighter-rouge">dwFlag</code> argument, the function will return <code class="language-plaintext highlighter-rouge">NULL</code>. If you have specified <code class="language-plaintext highlighter-rouge">HEAP_GENERATE_EXCEPTIONS</code> in <code class="language-plaintext highlighter-rouge">dwFlags</code>, it will return an exception code that we can use to get more information about the error like we do with the function <code class="language-plaintext highlighter-rouge">GetLastError</code> but we will use the function <code class="language-plaintext highlighter-rouge">GetExceptionCode</code> instead.</p><p>Now let’s look at the last important function which we will use to free this memory region that we have allocated.</p><h1 id="3-heapfree">3. HeapFree</h1><p>As the name suggests, we will use this function to free heap that we allocated using <code class="language-plaintext highlighter-rouge">HeapAllocate</code>.</p><p>One thing to note is that when we free a heap block, it is just freed, it is not destroyed. It can be allocated again until we destroy that heap. We will see how to destroy heap in the next part of this series, for now let’s focus on freeing the memory.</p><p>This is the function syntax:</p><div class="language-c highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre><td class="rouge-code"><pre><span class="n">BOOL</span> <span class="nf">HeapFree</span><span class="p">(</span>
  <span class="n">HANDLE</span>                 <span class="n">hHeap</span><span class="p">,</span>
  <span class="n">DWORD</span>                  <span class="n">dwFlags</span><span class="p">,</span>
  <span class="n">_Frees_ptr_opt_</span> <span class="n">LPVOID</span> <span class="n">lpMem</span>
<span class="p">);</span>
</pre></table></code></div></div><p>The function type is <code class="language-plaintext highlighter-rouge">BOOL</code> so we can expect this function to return a Boolean value that will tell us whether the function was successful or not. Let’s look at the arguments then we will move to code examples.</p><p>The first argument is <code class="language-plaintext highlighter-rouge">hHeap</code>. I guess you already know what we have to specify here, it’s just the handle returned from <code class="language-plaintext highlighter-rouge">HeapCreate</code>.</p><p>The next argument is <code class="language-plaintext highlighter-rouge">dwFlags</code>. This is used to specify the options while freeing the heap. This is the valid parameters for <code class="language-plaintext highlighter-rouge">dwFlags</code> argument:</p><p><a href="https://ibb.co/fNPk5MB"><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="https://i.ibb.co/bv8sZ1q/options.png" alt="options" /></a></p><p>Well yes, this argument has only one parameter, you can specify 0 if you don’t want to use this parameter.</p><p>The third and last parameter is <code class="language-plaintext highlighter-rouge">lpMem</code>. This should be the memory address returned by <code class="language-plaintext highlighter-rouge">HeapAlloc</code>.</p><p>Now as we have learnt about this functions, this is the time to write some code by using this functions.</p><h1 id="code-example---1">Code Example - 1</h1><p>Now let’s make a program with all this functions, which will first create some heap and then we will allocate the heap then we will free it. You can try making this yourself. Here is the code that I made</p><div class="language-c highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
</pre><td class="rouge-code"><pre><span class="cp">#include &lt;stdio.h&gt;
#include &lt;Windows.h&gt;
</span>
<span class="kt">int</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
    <span class="kt">int</span><span class="o">*</span> <span class="n">heap_handle</span> <span class="o">=</span> <span class="n">HeapCreate</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">16</span><span class="p">);</span> <span class="c1">// Created heap of maximum size 16 bytes</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">heap_handle</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">printf</span><span class="p">(</span><span class="s">"Was not able to create heap!!</span><span class="se">\n</span><span class="s">Error code: %d</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">GetLastError</span><span class="p">());</span>
        <span class="n">exit</span><span class="p">(</span><span class="n">GetLastError</span><span class="p">());</span>
    <span class="p">}</span>

    <span class="n">printf</span><span class="p">(</span><span class="s">"The handle of heap created is %x</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">heap_handle</span><span class="p">);</span>
    <span class="kt">int</span><span class="o">*</span> <span class="n">heap</span> <span class="o">=</span> <span class="n">HeapAlloc</span><span class="p">(</span><span class="n">heap_handle</span><span class="p">,</span> <span class="n">HEAP_ZERO_MEMORY</span><span class="p">,</span> <span class="mi">8</span><span class="p">);</span>

    <span class="n">printf</span><span class="p">(</span><span class="s">"The base address of heap allocated is %x</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">heap_handle</span><span class="p">);</span>

    <span class="kt">int</span> <span class="n">freed</span> <span class="o">=</span> <span class="n">HeapFree</span><span class="p">(</span><span class="n">heap_handle</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">heap</span><span class="p">);</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">freed</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">printf</span><span class="p">(</span><span class="s">"The memory has been freed successfully!</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="n">printf</span><span class="p">(</span><span class="s">"Was not able to free heap!!"</span><span class="p">);</span>
        <span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</pre></table></code></div></div><p>Let me explain the code. First we created heap using <code class="language-plaintext highlighter-rouge">HeapCreate</code> function, then we gave the first argument a 0, which means we don’t want to use any parameter in place of the first argument then again we supplied 0 as the second argument which means it will allocate a whole page. Then we passed 16 as the third argument which means the maximum size of heap that can be allocated in this heap region is 16 <em>in bytes</em>.</p><p>After that we printed the memory address of the created heap handle, then we used the <code class="language-plaintext highlighter-rouge">HeapAlloc</code> function to allocate heap on the heap that we created. The first argument required was the handle to the created heap, we specified it by specifying the <code class="language-plaintext highlighter-rouge">heap_handle</code> variable. Then we specified the second argument as <code class="language-plaintext highlighter-rouge">HEAP_ZERO_MEMORY</code>, which means the memory allocated should be initialised as 0 by default. At last, we specified 8 as the third argument, which means we want to allocate 8 bytes in heap.</p><p>Afterwards, we printed the memory address returned by <code class="language-plaintext highlighter-rouge">HeapAlloc</code>, then we used the <code class="language-plaintext highlighter-rouge">HeapFree</code> function with the first argument <code class="language-plaintext highlighter-rouge">heap_handle</code>, which we already know is a handle to the memory address created heap block. We then passed 0, by passing a 0 we meant to say that we don’t want to use any special options while freeing the memory and at last, we specified the memory address of the heap that we allocated and at last we checked if it freed or not.</p><p>Let’s run the program and see what it outputs! Here is the output of the code:</p><div class="language-c highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre><td class="rouge-code"><pre><span class="o">**</span><span class="n">The</span> <span class="n">handle</span> <span class="n">of</span> <span class="n">heap</span> <span class="n">created</span> <span class="n">is</span> <span class="mi">1</span><span class="n">b0000</span>
<span class="n">The</span> <span class="n">base</span> <span class="n">address</span> <span class="n">of</span> <span class="n">heap</span> <span class="n">allocated</span> <span class="n">is</span> <span class="mi">1</span><span class="n">b0000</span>
<span class="n">The</span> <span class="n">memory</span> <span class="n">has</span> <span class="n">been</span> <span class="n">freed</span> <span class="n">successfully</span><span class="o">!**</span>
</pre></table></code></div></div><p>and indeed, the code worked as expected.</p><p>Now, as we have allocated some Heap, let’s make some code to put some data on the heap and use it!</p><h1 id="code-example---2">Code Example - 2</h1><p>In this example, we are going to use the <code class="language-plaintext highlighter-rouge">memmove</code> function to copy data to the memory address returned by <code class="language-plaintext highlighter-rouge">HeapAlloc</code>. The syntax of <code class="language-plaintext highlighter-rouge">memmove</code> looks like this:</p><div class="language-c highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre><td class="rouge-code"><pre><span class="kt">void</span> <span class="o">*</span><span class="n">memmove</span><span class="p">(</span>
	<span class="kt">void</span> <span class="o">*</span><span class="n">dest</span><span class="p">,</span>
	<span class="k">const</span> <span class="kt">void</span> <span class="o">*</span><span class="n">source</span><span class="p">,</span>
	<span class="kt">size_t</span> <span class="n">n</span>
<span class="p">)</span>
</pre></table></code></div></div><p>The first argument for this function is the address of the destination, the second argument is the source from where we want to copy data and the last and third argument is the size of data that we want to move. After implementing this, our code looks like this:</p><div class="language-c highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
</pre><td class="rouge-code"><pre><span class="cp">#include &lt;stdio.h&gt;
</span>
<span class="cp">#include &lt;Windows.h&gt;
</span>
<span class="kt">int</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
    <span class="kt">int</span> <span class="o">*</span> <span class="n">heap_handle</span> <span class="o">=</span> <span class="n">HeapCreate</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">16</span><span class="p">);</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">heap_handle</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">printf</span><span class="p">(</span><span class="s">"Was not able to create heap!!</span><span class="se">\n</span><span class="s">Error code: %d</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">GetLastError</span><span class="p">());</span>
        <span class="n">exit</span><span class="p">(</span><span class="n">GetLastError</span><span class="p">());</span>
    <span class="p">}</span>

    <span class="n">printf</span><span class="p">(</span><span class="s">"The handle of heap created is %x</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">heap_handle</span><span class="p">);</span>
    <span class="kt">int</span> <span class="o">*</span> <span class="n">heap</span> <span class="o">=</span> <span class="n">HeapAlloc</span><span class="p">(</span><span class="n">heap_handle</span><span class="p">,</span> <span class="n">HEAP_ZERO_MEMORY</span><span class="p">,</span> <span class="mi">8</span><span class="p">);</span>
    <span class="n">printf</span><span class="p">(</span><span class="s">"The base address of heap allocated is %x</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">heap_handle</span><span class="p">);</span>

    <span class="n">memmove</span><span class="p">(</span><span class="n">heap</span><span class="p">,</span> <span class="p">(</span><span class="k">const</span> <span class="kt">void</span> <span class="o">*</span> <span class="p">)</span><span class="s">"Hello heap!"</span><span class="p">,</span> <span class="mi">11</span><span class="p">);</span>
    <span class="n">printf</span><span class="p">(</span><span class="s">"The data stored in heap is: %s</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">heap</span><span class="p">);</span>

    <span class="kt">int</span> <span class="n">freed</span> <span class="o">=</span> <span class="n">HeapFree</span><span class="p">(</span><span class="n">heap_handle</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">heap</span><span class="p">);</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">freed</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">printf</span><span class="p">(</span><span class="s">"The memory has been freed successfully!</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="n">printf</span><span class="p">(</span><span class="s">"Was not able to free heap!!"</span><span class="p">);</span>
        <span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</pre></table></code></div></div><p>The code is almost same, we just added the <code class="language-plaintext highlighter-rouge">memmove</code> function and copied the string <code class="language-plaintext highlighter-rouge">"Hello heap!"</code> to the memory address returned by <code class="language-plaintext highlighter-rouge">HeapAlloc</code>. and then we printed it.</p><p>Let’s run the code and see the output:</p><div class="language-c highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre><td class="rouge-code"><pre><span class="n">The</span> <span class="n">handle</span> <span class="n">of</span> <span class="n">heap</span> <span class="n">created</span> <span class="n">is</span> <span class="mi">6</span><span class="n">b0000</span>
<span class="n">The</span> <span class="n">base</span> <span class="n">address</span> <span class="n">of</span> <span class="n">heap</span> <span class="n">allocated</span> <span class="n">is</span> <span class="mi">6</span><span class="n">b0000</span>
<span class="n">The</span> <span class="n">data</span> <span class="n">stored</span> <span class="n">in</span> <span class="n">heap</span> <span class="n">is</span><span class="o">:</span> <span class="n">Hello</span> <span class="n">heap</span><span class="o">!</span>
<span class="n">The</span> <span class="n">memory</span> <span class="n">has</span> <span class="n">been</span> <span class="n">freed</span> <span class="n">successfully</span><span class="o">!</span>
</pre></table></code></div></div><p>Voila!!, We got our expected results. It felt really cool when I did this and I recommend you to make something with this functions!!</p><p>This was all for this one, meet you in the next one!</p></div><div class="post-tail-wrapper text-muted"><div class="post-meta mb-3"> <i class="far fa-folder-open fa-fw mr-1"></i> <a href='/categories/programming/'>Programming</a>, <a href='/categories/windows/'>Windows</a>, <a href='/categories/windows-internals/'>Windows Internals</a>, <a href='/categories/winapi/'>WinAPI</a></div><div class="post-tags"> <i class="fa fa-tags fa-fw mr-1"></i> <a href="/tags/windows/" class="post-tag no-text-decoration" >Windows</a> <a href="/tags/windows-api-series/" class="post-tag no-text-decoration" >Windows API Series</a> <a href="/tags/heap-api/" class="post-tag no-text-decoration" >Heap API</a></div><div class="post-tail-bottom d-flex justify-content-between align-items-center mt-3 pt-5 pb-2"><div class="license-wrapper"> This post is licensed under <a href="https://creativecommons.org/licenses/by/4.0/">CC BY 4.0</a> by the author.</div><div class="share-wrapper"> <span class="share-label text-muted mr-1">Share</span> <span class="share-icons"> <a href="https://twitter.com/intent/tweet?text=Windows API - Let's learn about heap in deep! - Mr. Rc's blog&url=/posts/Windows-API-Heap-Functions/" data-toggle="tooltip" data-placement="top" title="Twitter" target="_blank" rel="noopener" aria-label="Twitter"> <i class="fa-fw fab fa-twitter"></i> </a> <a href="https://www.facebook.com/sharer/sharer.php?title=Windows API - Let's learn about heap in deep! - Mr. Rc's blog&u=/posts/Windows-API-Heap-Functions/" data-toggle="tooltip" data-placement="top" title="Facebook" target="_blank" rel="noopener" aria-label="Facebook"> <i class="fa-fw fab fa-facebook-square"></i> </a> <a href="https://telegram.me/share?text=Windows API - Let's learn about heap in deep! - Mr. Rc's blog&url=/posts/Windows-API-Heap-Functions/" data-toggle="tooltip" data-placement="top" title="Telegram" target="_blank" rel="noopener" aria-label="Telegram"> <i class="fa-fw fab fa-telegram"></i> </a> <i class="fa-fw fas fa-link small" onclick="copyLink()" data-toggle="tooltip" data-placement="top" title="Copy link"></i> </span></div></div></div></div></div><div id="panel-wrapper" class="col-xl-3 pl-2 text-muted topbar-down"><div class="access"><div id="access-lastmod" class="post"> <span>Recent Update</span><ul class="post-content pl-0 pb-1 ml-1 mt-2"><li><a href="/posts/WinAPI-Using-Registry-Playing-With-Env-Variables/">Windows API - Let's use the register to change our Environment!</a><li><a href="/posts/WinAPI-Environment-Variables/">Windows API - Let's Play with the Windows Environment Variables!</a></ul></div><div id="access-tags"> <span>Trending Tags</span><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/windows/">Windows</a> <a class="post-tag" href="/tags/windows-api-series/">Windows API Series</a> <a class="post-tag" href="/tags/virtual-memory-management/">Virtual Memory Management</a> <a class="post-tag" href="/tags/heap-api/">Heap API</a> <a class="post-tag" href="/tags/assembly/">Assembly</a> <a class="post-tag" href="/tags/operating-system/">Operating system</a> <a class="post-tag" href="/tags/windows-registry/">Windows Registry</a></div></div></div><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.js"></script><div id="toc-wrapper" class="pl-0 pr-4 mb-5"> <span class="pl-3 pt-2 mb-2">Contents</span><nav id="toc" data-toggle="toc"></nav></div></div></div><div class="row"><div class="col-12 col-lg-11 col-xl-8"><div id="post-extend-wrapper" class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><div id="related-posts" class="mt-5 mb-2 mb-sm-4"><h3 class="pt-2 mt-1 mb-4 ml-1" data-toc-skip>Further Reading</h3><div class="card-deck mb-4"><div class="card"> <a href="/posts/Heap-Chapter-End/"><div class="card-body"> <span class="timeago small" > May 29, 2021 <i class="unloaded">2021-05-29T09:03:00+05:30</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Windows API - Let's end the Heap Chapter!</h3><div class="text-muted small"><p> Welcome to the last blog post on the HeapAPI functions from the Windows API series, this post willn’t be the last blog post for the whole Windows API series but it will be the last blog post for th...</p></div></div></a></div><div class="card"> <a href="/posts/Windows-API-Basics-of-Virtual-Memory-Management-API/"><div class="card-body"> <span class="timeago small" > Apr 15, 2021 <i class="unloaded">2021-04-15T09:03:00+05:30</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Windows API - Basics of Virtual Memory Management API.</h3><div class="text-muted small"><p> The Virtual Memory Manager in Windows (WMM) is available for user mode programs and can be used by the Win32 APIs to allocate memory and free them in the user space. From this blog, I am going to ...</p></div></div></a></div><div class="card"> <a href="/posts/Windows-API-More-on-Virtual-Memory/"><div class="card-body"> <span class="timeago small" > Apr 18, 2021 <i class="unloaded">2021-04-18T09:03:00+05:30</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Windows API - More on Virtual Memory.</h3><div class="text-muted small"><p> In this blog, we are going to have a look at some basic memory related things that we can do with the API functions that we learnt about in last blog post along with a new function VirtualQuery. B...</p></div></div></a></div></div></div><div class="post-navigation d-flex justify-content-between"> <a href="/posts/Windows-API-More-on-Virtual-Memory/" class="btn btn-outline-primary" prompt="Older"><p>Windows API - More on Virtual Memory.</p></a> <a href="/posts/Heap-Chapter-End/" class="btn btn-outline-primary" prompt="Newer"><p>Windows API - Let's end the Heap Chapter!</p></a></div></div></div></div><footer class="d-flex w-100 justify-content-center"><div class="d-flex justify-content-between align-items-center"><div class="footer-left"><p class="mb-0"> © 2022 <a href="https://twitter.com/coder_rc">Mr. Rc</a>. <span data-toggle="tooltip" data-placement="top" title="Except where otherwise noted, the blog posts on this site are licensed under the Creative Commons Attribution 4.0 International (CC BY 4.0) License by the author.">Some rights reserved.</span></p></div><div class="footer-right"><p class="mb-0"> Powered by <a href="https://jekyllrb.com" target="_blank" rel="noopener">Jekyll</a> with <a href="https://github.com/cotes2020/jekyll-theme-chirpy" target="_blank" rel="noopener">Chirpy</a> theme.</p></div></div></footer></div><div id="search-result-wrapper" class="d-flex justify-content-center unloaded"><div class="col-12 col-sm-11 post-content"><div id="search-hints"><h4 class="text-muted mb-4">Trending Tags</h4><a class="post-tag" href="/tags/windows/">Windows</a> <a class="post-tag" href="/tags/windows-api-series/">Windows API Series</a> <a class="post-tag" href="/tags/virtual-memory-management/">Virtual Memory Management</a> <a class="post-tag" href="/tags/heap-api/">Heap API</a> <a class="post-tag" href="/tags/assembly/">Assembly</a> <a class="post-tag" href="/tags/operating-system/">Operating system</a> <a class="post-tag" href="/tags/windows-registry/">Windows Registry</a></div><div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div></div></div></div><div id="mask"></div><a id="back-to-top" href="#" aria-label="back-to-top" class="btn btn-lg btn-box-shadow" role="button"> <i class="fas fa-angle-up"></i> </a> <script src="https://cdn.jsdelivr.net/npm/simple-jekyll-search@1.7.3/dest/simple-jekyll-search.min.js"></script> <script> SimpleJekyllSearch({ searchInput: document.getElementById('search-input'), resultsContainer: document.getElementById('search-results'), json: '/assets/js/data/search.json', searchResultTemplate: '<div class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-lg-4 pr-lg-4 pl-xl-0 pr-xl-0"> <a href="{url}">{title}</a><div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1"> {categories} {tags}</div><p>{snippet}</p></div>', noResultsText: '<p class="mt-5">Oops! No result founds.</p>', templateMiddleware: function(prop, value, template) { if (prop === 'categories') { if (value === '') { return `${value}`; } else { return `<div class="mr-sm-4"><i class="far fa-folder fa-fw"></i>${value}</div>`; } } if (prop === 'tags') { if (value === '') { return `${value}`; } else { return `<div><i class="fa fa-tag fa-fw"></i>${value}</div>`; } } } }); </script>
