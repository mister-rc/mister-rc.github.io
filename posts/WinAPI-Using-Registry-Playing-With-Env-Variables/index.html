<!DOCTYPE html><html lang="en-US" ><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><meta name="generator" content="Jekyll v4.2.1" /><meta property="og:title" content="Windows API - Let’s use the register to change our Environment!" /><meta name="author" content="Mr. Rc" /><meta property="og:locale" content="en_US" /><meta name="description" content="In this blog, we are going to have a look at some Windows API’s Windows Registry Functions that will help us to manipulate the data inside the Windows Registry and as we know that our Environment Variables reside inside Windows Registry, so it will also help us to modify the Environment Variables in our system." /><meta property="og:description" content="In this blog, we are going to have a look at some Windows API’s Windows Registry Functions that will help us to manipulate the data inside the Windows Registry and as we know that our Environment Variables reside inside Windows Registry, so it will also help us to modify the Environment Variables in our system." /><link rel="canonical" href="/posts/WinAPI-Using-Registry-Playing-With-Env-Variables/" /><meta property="og:url" content="/posts/WinAPI-Using-Registry-Playing-With-Env-Variables/" /><meta property="og:site_name" content="Mr. Rc’s blog" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2021-08-05T09:03:00+05:30" /><meta name="twitter:card" content="summary" /><meta property="twitter:title" content="Windows API - Let’s use the register to change our Environment!" /><meta name="google-site-verification" content="google_meta_tag_verification" /> <script type="application/ld+json"> {"author":{"@type":"Person","name":"Mr. Rc"},"headline":"Windows API - Let’s use the register to change our Environment!","dateModified":"2021-08-05T22:33:10+05:30","datePublished":"2021-08-05T09:03:00+05:30","description":"In this blog, we are going to have a look at some Windows API’s Windows Registry Functions that will help us to manipulate the data inside the Windows Registry and as we know that our Environment Variables reside inside Windows Registry, so it will also help us to modify the Environment Variables in our system.","url":"/posts/WinAPI-Using-Registry-Playing-With-Env-Variables/","@type":"BlogPosting","mainEntityOfPage":{"@type":"WebPage","@id":"/posts/WinAPI-Using-Registry-Playing-With-Env-Variables/"},"@context":"https://schema.org"}</script><title>Windows API - Let's use the register to change our Environment! | Mr. Rc's blog</title><link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicons/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicons/favicon-16x16.png"><link rel="manifest" href="/assets/img/favicons/site.webmanifest"><link rel="shortcut icon" href="/assets/img/favicons/favicon.ico"><meta name="apple-mobile-web-app-title" content="Mr. Rc's blog"><meta name="application-name" content="Mr. Rc's blog"><meta name="msapplication-TileColor" content="#da532c"><meta name="msapplication-config" content="/assets/img/favicons/browserconfig.xml"><meta name="theme-color" content="#ffffff"><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://fonts.gstatic.com"><link rel="preconnect" href="https://www.google-analytics.com" crossorigin="use-credentials"><link rel="dns-prefetch" href="https://www.google-analytics.com"><link rel="preconnect" href="https://www.googletagmanager.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://www.googletagmanager.com"><link rel="preconnect" href="https://cdn.jsdelivr.net"><link rel="dns-prefetch" href="https://cdn.jsdelivr.net"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.0.0/dist/css/bootstrap.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.11.2/css/all.min.css"><link rel="stylesheet" href="/assets/css/style.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/magnific-popup@1.1.0/dist/magnific-popup.min.css"> <script src="https://cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script> <script data-ad-client="ca-pub-2858626085073914" async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script> <script defer src="https://cdn.jsdelivr.net/combine/npm/popper.js@1.15.0,npm/bootstrap@4/dist/js/bootstrap.min.js"></script> <script async src="https://cdn.jsdelivr.net/combine/npm/lozad/dist/lozad.min.js,npm/magnific-popup@1/dist/jquery.magnific-popup.min.js"></script> <script defer src="/assets/js/dist/post.min.js"></script> <script defer src="/app.js"></script> <script defer src="https://www.googletagmanager.com/gtag/js?id=UA-199874344-1"></script> <script> document.addEventListener("DOMContentLoaded", function(event) { window.dataLayer = window.dataLayer || []; function gtag(){dataLayer.push(arguments);} gtag('js', new Date()); gtag('config', 'UA-199874344-1'); }); </script><body data-spy="scroll" data-target="#toc"><div id="sidebar" class="d-flex flex-column align-items-end"><div class="profile-wrapper text-center"><div id="avatar"> <a href="/" alt="avatar" class="mx-auto"> <img src="https://i.ibb.co/6W31BDG/skull.jpg" alt="avatar" onerror="this.style.display='none'"> </a></div><div class="site-title mt-3"> <a href="/">Mr. Rc's blog</a></div><div class="site-subtitle font-italic">A collection of Mr. Rc's Blogs.</div></div><ul class="w-100"><li class="nav-item"> <a href="/" class="nav-link"> <i class="fa-fw fas fa-home ml-xl-3 mr-xl-3 unloaded"></i> <span>HOME</span> </a><li class="nav-item"> <a href="/categories/" class="nav-link"> <i class="fa-fw fas fa-stream ml-xl-3 mr-xl-3 unloaded"></i> <span>CATEGORIES</span> </a><li class="nav-item"> <a href="/tags/" class="nav-link"> <i class="fa-fw fas fa-tags ml-xl-3 mr-xl-3 unloaded"></i> <span>TAGS</span> </a><li class="nav-item"> <a href="/archives/" class="nav-link"> <i class="fa-fw fas fa-archive ml-xl-3 mr-xl-3 unloaded"></i> <span>ARCHIVES</span> </a><li class="nav-item"> <a href="/about/" class="nav-link"> <i class="fa-fw fas fa-info ml-xl-3 mr-xl-3 unloaded"></i> <span>ABOUT</span> </a></ul><div class="sidebar-bottom mt-auto d-flex flex-wrap justify-content-center"> <a href="https://github.com/HACKE-RC" aria-label="github" class="order-3" target="_blank" rel="noopener"> <i class="fab fa-github-alt"></i> </a> <a href="https://twitter.com/" aria-label="twitter" class="order-4" target="_blank" rel="noopener"> <i class="fab fa-twitter"></i> </a> <a href=" javascript:location.href = 'mailto:' + ['cr.retsim','gmail.com'].join('@')" aria-label="email" class="order-5" > <i class="fas fa-envelope"></i> </a> <a href="/feed.xml" aria-label="rss" class="order-6" > <i class="fas fa-rss"></i> </a> <span class="icon-border order-2"></span> <span id="mode-toggle-wrapper" class="order-1"> <i class="mode-toggle fas fa-adjust"></i> <script type="text/javascript"> class ModeToggle { static get MODE_KEY() { return "mode"; } static get DARK_MODE() { return "dark"; } static get LIGHT_MODE() { return "light"; } constructor() { if (this.hasMode) { if (this.isDarkMode) { if (!this.isSysDarkPrefer) { this.setDark(); } } else { if (this.isSysDarkPrefer) { this.setLight(); } } } var self = this; /* always follow the system prefers */ this.sysDarkPrefers.addListener(function() { if (self.hasMode) { if (self.isDarkMode) { if (!self.isSysDarkPrefer) { self.setDark(); } } else { if (self.isSysDarkPrefer) { self.setLight(); } } self.clearMode(); } self.updateMermaid(); }); } /* constructor() */ setDark() { $('html').attr(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE); } setLight() { $('html').attr(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE); } clearMode() { $('html').removeAttr(ModeToggle.MODE_KEY); sessionStorage.removeItem(ModeToggle.MODE_KEY); } get sysDarkPrefers() { return window.matchMedia("(prefers-color-scheme: dark)"); } get isSysDarkPrefer() { return this.sysDarkPrefers.matches; } get isDarkMode() { return this.mode == ModeToggle.DARK_MODE; } get isLightMode() { return this.mode == ModeToggle.LIGHT_MODE; } get hasMode() { return this.mode != null; } get mode() { return sessionStorage.getItem(ModeToggle.MODE_KEY); } /* get the current mode on screen */ get modeStatus() { if (this.isDarkMode || (!this.hasMode && this.isSysDarkPrefer) ) { return ModeToggle.DARK_MODE; } else { return ModeToggle.LIGHT_MODE; } } updateMermaid() { if (typeof mermaid !== "undefined") { let expectedTheme = (this.modeStatus === ModeToggle.DARK_MODE? "dark" : "default"); let config = { theme: expectedTheme }; /* re-render the SVG › <https://github.com/mermaid-js/mermaid/issues/311#issuecomment-332557344> */ $(".mermaid").each(function() { let svgCode = $(this).prev().children().html(); $(this).removeAttr("data-processed"); $(this).html(svgCode); }); mermaid.initialize(config); mermaid.init(undefined, ".mermaid"); } } flipMode() { if (this.hasMode) { if (this.isSysDarkPrefer) { if (this.isLightMode) { this.clearMode(); } else { this.setLight(); } } else { if (this.isDarkMode) { this.clearMode(); } else { this.setDark(); } } } else { if (this.isSysDarkPrefer) { this.setLight(); } else { this.setDark(); } } this.updateMermaid(); } /* flipMode() */ } /* ModeToggle */ let toggle = new ModeToggle(); $(".mode-toggle").click(function() { toggle.flipMode(); }); </script> </span></div></div><div id="topbar-wrapper" class="row justify-content-center topbar-down"><div id="topbar" class="col-11 d-flex h-100 align-items-center justify-content-between"> <span id="breadcrumb"> <span> <a href="/"> Posts </a> </span> <span>Windows API - Let's use the register to change our Environment!</span> </span> <i id="sidebar-trigger" class="fas fa-bars fa-fw"></i><div id="topbar-title"> Post</div><i id="search-trigger" class="fas fa-search fa-fw"></i> <span id="search-wrapper" class="align-items-center"> <i class="fas fa-search fa-fw"></i> <input class="form-control" id="search-input" type="search" aria-label="search" autocomplete="off" placeholder="Search..."> <i class="fa fa-times-circle fa-fw" id="search-cleaner"></i> </span> <span id="search-cancel" >Cancel</span></div></div><div id="main-wrapper"><div id="main"><div class="row"><div id="post-wrapper" class="col-12 col-lg-11 col-xl-8"><div class="post pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><h1 data-toc-skip>Windows API - Let's use the register to change our Environment!</h1><div class="post-meta text-muted d-flex flex-column"><div> <span class="semi-bold"> Mr. Rc </span> <span class="timeago " data-toggle="tooltip" data-placement="bottom" title="Thu, Aug 5, 2021, 9:03 AM +0530" prep="on" > Aug 5, 2021 <i class="unloaded">2021-08-05T09:03:00+05:30</i> </span></div><div> <span> <span class="timeago lastmod" data-toggle="tooltip" data-placement="bottom" title="Thu, Aug 5, 2021, 10:33 PM +0530" prefix="Updated " > Aug 5, 2021 <i class="unloaded">2021-08-05T22:33:10+05:30</i> </span> </span> <span class="readtime" data-toggle="tooltip" data-placement="bottom" title="1931 words">10 min</span></div></div><div class="post-content"><p>In this blog, we are going to have a look at some Windows API’s Windows Registry Functions that will help us to manipulate the data inside the Windows Registry and as we know that our Environment Variables reside inside Windows Registry, so it will also help us to modify the Environment Variables in our system.</p><p>The three functions that we are going to use are <code class="language-plaintext highlighter-rouge">RegCreateKey</code>, <code class="language-plaintext highlighter-rouge">RegSetValueEx</code>, <code class="language-plaintext highlighter-rouge">RegGetValueA</code>. This functions are from the <code class="language-plaintext highlighter-rouge">winreg.h</code> header file.</p><h1 id="some-important-terms-of-the-windows-registry">Some Important terms of The Windows Registry</h1><p>As we are going to manipulate the Windows Registry using Windows API functions, we will understand some important terms of the Windows Registry.</p><p>The first things you should know about is <code class="language-plaintext highlighter-rouge">Keys</code>, <code class="language-plaintext highlighter-rouge">SubKeys</code> and <code class="language-plaintext highlighter-rouge">Values</code>.</p><p>You can understand them from the following example:</p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="http://www.onlinecmag.com/wp-content/uploads/2014/10/understanding-the-various-aspects-of-registry-registry-root-keys.png" alt="http://www.onlinecmag.com/wp-content/uploads/2014/10/understanding-the-various-aspects-of-registry-registry-root-keys.png" /></p><p>In our case, the path of the registry key where the User Environment Variables are stored is <code class="language-plaintext highlighter-rouge">HKEY_CURRENT_USER\Environment</code>. Here <code class="language-plaintext highlighter-rouge">HKEY_CURRENT_USER</code> is the Key, <code class="language-plaintext highlighter-rouge">Environment</code> is the <code class="language-plaintext highlighter-rouge">Sub Key</code> and all the Environment Variables inside the registry <code class="language-plaintext highlighter-rouge">Key</code> are the <code class="language-plaintext highlighter-rouge">Values</code>.</p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="https://i.ibb.co/2Sn0gtw/registry-example.png" alt="https://i.ibb.co/2Sn0gtw/registry-example.png" /></p><p>If you want to learn about Windows Registry, you can read some stuff here:</p><p><a href="https://docs.microsoft.com/en-us/troubleshoot/windows-server/performance/windows-registry-advanced-users">Windows registry for advanced users - Windows Server</a></p><h1 id="1-regcreatekey">1. RegCreateKey</h1><p>This Function is used to Create a Registry Key. It opens the Registry Key if it already exists.</p><p>The Function’s signature looks like this:</p><div class="language-c highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre><td class="rouge-code"><pre><span class="n">LSTATUS</span> <span class="nf">RegCreateKeyA</span><span class="p">(</span>
  <span class="n">HKEY</span>   <span class="n">hKey</span><span class="p">,</span>
  <span class="n">LPCSTR</span> <span class="n">lpSubKey</span><span class="p">,</span>
  <span class="n">PHKEY</span>  <span class="n">phkResult</span>
<span class="p">);</span>
</pre></table></code></div></div><p>The return type of this function is <code class="language-plaintext highlighter-rouge">LPSTATUS</code>, which means it just returns a <code class="language-plaintext highlighter-rouge">long</code> integer which is an error code.</p><p>The first parameter for this function is <code class="language-plaintext highlighter-rouge">hKey</code> which is of <code class="language-plaintext highlighter-rouge">HKEY</code> data type. The <code class="language-plaintext highlighter-rouge">HKEY</code> data type is just a <code class="language-plaintext highlighter-rouge">HANDLE</code> to an open registry key.</p><p>If we don’t have a <code class="language-plaintext highlighter-rouge">HANDLE</code>, we can use this predefined keys:</p><ul><li>HKEY_CLASSES_ROOT<li>HKEY_CURRENT_CONFIG<li>HKEY_CURRENT_USER<li>HKEY_LOCAL_MACHINE<li>HKEY_USERS</ul><p>The second parameter of this function is <code class="language-plaintext highlighter-rouge">lpSubKey</code> of <code class="language-plaintext highlighter-rouge">LPCSTR</code> data type, which is just a <code class="language-plaintext highlighter-rouge">const char</code> pointer to the string that contains the name of the <code class="language-plaintext highlighter-rouge">Sub Key</code> that we want to Create / Open.</p><p>The last and third argument is <code class="language-plaintext highlighter-rouge">phkResult</code>, this argument will contain the pointer to a variable which will receive the <code class="language-plaintext highlighter-rouge">HANDLE</code> of the registry <code class="language-plaintext highlighter-rouge">Key</code> that this function will Create / Open. This variable will be of type <code class="language-plaintext highlighter-rouge">HKEY</code>.</p><p>This function return <code class="language-plaintext highlighter-rouge">ERROR_SUCCESS</code> if it succeeds.</p><p>If the function fails, the return value is a nonzero error code defined in <code class="language-plaintext highlighter-rouge">winerror.h</code>.</p><h1 id="2-regsetvalueex">2. RegSetValueEx</h1><p>This function is used to modify a registry <code class="language-plaintext highlighter-rouge">Value</code> after opening a <code class="language-plaintext highlighter-rouge">HANDLE</code> of it.</p><p>The function syntax looks like this:</p><div class="language-c highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
</pre><td class="rouge-code"><pre><span class="n">LSTATUS</span> <span class="nf">RegSetValueExA</span><span class="p">(</span>
  <span class="n">HKEY</span>       <span class="n">hKey</span><span class="p">,</span>
  <span class="n">LPCSTR</span>     <span class="n">lpValueName</span><span class="p">,</span>
  <span class="n">DWORD</span>      <span class="n">Reserved</span><span class="p">,</span>
  <span class="n">DWORD</span>      <span class="n">dwType</span><span class="p">,</span>
  <span class="k">const</span> <span class="n">BYTE</span> <span class="o">*</span><span class="n">lpData</span><span class="p">,</span>
  <span class="n">DWORD</span>      <span class="n">cbData</span>
<span class="p">);</span>
</pre></table></code></div></div><p>The return type of this function is same as the last one.</p><p>The first parameter is <code class="language-plaintext highlighter-rouge">hKey</code> and this will be the handle to an Open registry <code class="language-plaintext highlighter-rouge">Key</code>. This <code class="language-plaintext highlighter-rouge">HANDLE</code> will be returned by <code class="language-plaintext highlighter-rouge">RegCreateKey</code> function(in our case).</p><p>The second parameter is <code class="language-plaintext highlighter-rouge">lpValueName</code>, the data type of this function is <code class="language-plaintext highlighter-rouge">LPCSTR</code> which is just a pointer to a char array. This parameter stores the Name of the <code class="language-plaintext highlighter-rouge">Value</code> that you want to change in The Registry. In our case, this will be the name of the Environment Variable that we want to modify.</p><p>The third parameter is <code class="language-plaintext highlighter-rouge">Reserved</code>, it’s a reserved parameter and we are supposed to leave it as 0.</p><p>The fourth parameter is <code class="language-plaintext highlighter-rouge">dwType</code>. This parameter contains the type of data pointer by the <code class="language-plaintext highlighter-rouge">lpData</code> parameter. This type should be <code class="language-plaintext highlighter-rouge">REG_SZ</code>, as we just want to store a null-terminated string as the value of <code class="language-plaintext highlighter-rouge">REG_SZ</code>. You can read about every type here:</p><p><a href="https://docs.microsoft.com/en-us/windows/win32/sysinfo/registry-value-types">Registry Value Types - Win32 apps</a></p><p>The fifth parameter is <code class="language-plaintext highlighter-rouge">lpData</code>. This variable contains the string that we want to store into our Registry <code class="language-plaintext highlighter-rouge">Value</code>. This string should be a null-terminated string.</p><p>If you are going to choose the <code class="language-plaintext highlighter-rouge">REG_MULTI_SZ</code> type, the string must be terminated with two null characters.</p><p>The sixth parameter is <code class="language-plaintext highlighter-rouge">cbData</code>. This parameter contains the size of the string in the fifth argument plus the size of the null-terminator which will be 1.</p><p>This function return <code class="language-plaintext highlighter-rouge">ERROR_SUCCESS</code> if it succeeds.</p><p>If the function fails, the return value is a nonzero error code defined in <code class="language-plaintext highlighter-rouge">winerror.h</code>.</p><h1 id="3-reggetvaluea">3. RegGetValueA</h1><p>Our next and last function is <code class="language-plaintext highlighter-rouge">RegGetValueA</code>. We use this function to read the data stored in a <code class="language-plaintext highlighter-rouge">Value</code>.</p><p>The function signature looks like this:</p><div class="language-c highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
</pre><td class="rouge-code"><pre><span class="n">LSTATUS</span> <span class="nf">RegGetValueA</span><span class="p">(</span>
  <span class="n">HKEY</span>    <span class="n">hkey</span><span class="p">,</span>
  <span class="n">LPCSTR</span>  <span class="n">lpSubKey</span><span class="p">,</span>
  <span class="n">LPCSTR</span>  <span class="n">lpValue</span><span class="p">,</span>
  <span class="n">DWORD</span>   <span class="n">dwFlags</span><span class="p">,</span>
  <span class="n">LPDWORD</span> <span class="n">pdwType</span><span class="p">,</span>
  <span class="n">PVOID</span>   <span class="n">pvData</span><span class="p">,</span>
  <span class="n">LPDWORD</span> <span class="n">pcbData</span>
<span class="p">);</span>
</pre></table></code></div></div><p>The first parameter is <code class="language-plaintext highlighter-rouge">hkey</code>. It’s same as the first parameter in the last function.</p><p>The second parameter is <code class="language-plaintext highlighter-rouge">lpSubKey</code>. This parameter is used to pass the <code class="language-plaintext highlighter-rouge">Sub Key</code> name whose <code class="language-plaintext highlighter-rouge">Value</code> we want to access.</p><p>Because we want to access the Environment variables, we will use <code class="language-plaintext highlighter-rouge">Environment</code> as the argument to this function.</p><p>The third parameter is <code class="language-plaintext highlighter-rouge">lpValue</code>. This parameter is used to pass the name of the <code class="language-plaintext highlighter-rouge">Value</code> whose data we want to query. This will be the name of our Environment variable whose data we want to query.</p><p>The fourth parameter is <code class="language-plaintext highlighter-rouge">dwFlags</code>. This parameter is used to pass the data type of the <code class="language-plaintext highlighter-rouge">Value</code> <em>**</em>that we want to access.</p><p>This are the available options for this parameteter:</p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="https://i.ibb.co/VYPXx2G/type-of-registry-keys.png" alt="https://i.ibb.co/VYPXx2G/type-of-registry-keys.png" /></p><p>The fifth parameter is <code class="language-plaintext highlighter-rouge">pdwType</code>. This parameter is used to pass a pointer to a variable which will get the data type of the data stored in the <code class="language-plaintext highlighter-rouge">Value</code> that we are accessing. This parameter is mostly used for verifying the data type that the function returned. We can just ignore the use of this function by passing <code class="language-plaintext highlighter-rouge">NULL</code> as an argument to this function.</p><p>The sixth parameter is <strong><code class="language-plaintext highlighter-rouge">pvData</code>.</strong> This parameter is used to pass a pointer to a variable that will store the data from the Registry value. We can also pass <code class="language-plaintext highlighter-rouge">NULL</code> as an argument incase we just want to check if the registry value exists or not. This all will make sense later if it doesn’t right now.</p><p>The seventh parameter is <code class="language-plaintext highlighter-rouge">pcbData</code>. This parameter is used to pass a pointer to variable that will store the size of the buffer pointed by <code class="language-plaintext highlighter-rouge">pvData</code> parameter. We can also pass <code class="language-plaintext highlighter-rouge">NULL</code> as an argument in this function. This parameter can only be <code class="language-plaintext highlighter-rouge">NULL</code> if the <code class="language-plaintext highlighter-rouge">pvData</code> parameter is <code class="language-plaintext highlighter-rouge">NULL</code>.</p><p>If the function succeeds, the return value is ERROR_SUCCESS.</p><p>If the function fails, the return value is a <a href="https://docs.microsoft.com/en-us/windows/desktop/Debug/system-error-codes">system error code</a>.</p><h1 id="code-example">Code Example</h1><p>As said in the last blog post, we will be making a wrapper that will modify Environment variables for us.</p><p>Here’s the code of the one that I made:</p><div class="language-c highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
</pre><td class="rouge-code"><pre><span class="cp">#include &lt;stdio.h&gt;
#include &lt;stdlib.h&gt;
#include &lt;windows.h&gt;
</span>
<span class="c1">// defining status values to use later in the functions. You can modify them on your own.</span>
<span class="cp">#define STATUS_UNSUCCESSFUL 0x00000001
#define STATUS_SUCCESS 0x00000000 
</span>
<span class="c1">// Predefining our wrapper function.</span>
<span class="n">NTSTATUS</span> <span class="nf">SetEnvironmentVariableR</span><span class="p">(</span><span class="n">LPCSTR</span> <span class="n">lpName</span><span class="p">,</span> <span class="n">LPCSTR</span> <span class="n">lpValue</span><span class="p">);</span>

<span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span><span class="o">*</span> <span class="n">argv</span><span class="p">[]){</span>
    <span class="kt">char</span> <span class="n">lpName</span><span class="p">[</span><span class="mi">500</span><span class="p">];</span> <span class="c1">// this variable will store the name of the environment variable.</span>
    <span class="kt">char</span> <span class="n">lpValue</span><span class="p">[</span><span class="mi">500</span><span class="p">];</span> <span class="c1">// this variable will store the value of the environment variable.</span>

    <span class="c1">// We are going to ask the user for the name of the environment variable.    </span>
    <span class="n">puts</span><span class="p">(</span><span class="s">"Enter the Environment Variable: "</span><span class="p">);</span>
    <span class="n">scanf</span><span class="p">(</span><span class="s">"%s"</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">lpName</span><span class="p">);</span>
    <span class="n">getchar</span><span class="p">();</span> <span class="c1">// getchar to avoid a new line.</span>
    <span class="n">puts</span><span class="p">(</span><span class="s">"Enter the value for the Environment Variable: "</span><span class="p">);</span>
    <span class="n">scanf</span><span class="p">(</span><span class="s">"%[^</span><span class="se">\n</span><span class="s">]s"</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">lpValue</span><span class="p">);</span>

    <span class="c1">// calling our wrapper function.</span>
    <span class="n">NTSTATUS</span> <span class="n">Status</span> <span class="o">=</span> <span class="n">SetEnvironmentVariableR</span><span class="p">(</span><span class="n">lpName</span><span class="p">,</span> <span class="n">lpValue</span><span class="p">);</span>
       
    <span class="k">if</span> <span class="p">(</span><span class="n">Status</span> <span class="o">==</span> <span class="n">STATUS_SUCCESS</span><span class="p">){</span> 
        <span class="n">printf</span><span class="p">(</span><span class="s">"Environment Variable was successfully modified!"</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="c1">// function to set a environment variable globally by editing the registry keys.</span>
<span class="n">NTSTATUS</span> <span class="nf">SetEnvironmentVariableR</span><span class="p">(</span><span class="n">LPCSTR</span> <span class="n">lpName</span><span class="p">,</span> <span class="n">LPCSTR</span> <span class="n">lpValue</span><span class="p">){</span>
    <span class="n">HKEY</span> <span class="n">hKey</span><span class="p">;</span> <span class="c1">// this will hold the handle to the registry key.</span>
    
    <span class="c1">// We are going to open the registry key for HKEY_CURRENT_USER\Environment.</span>
    <span class="n">RegCreateKey</span><span class="p">(</span><span class="n">HKEY_CURRENT_USER</span><span class="p">,</span> <span class="s">"Environment"</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hKey</span><span class="p">);</span>
    
    <span class="c1">// Error check.</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">hKey</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">printf</span><span class="p">(</span><span class="s">"RegCreateKey failed</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
        <span class="n">printf</span><span class="p">(</span><span class="s">"Error code: %d"</span><span class="p">,</span> <span class="n">GetLastError</span><span class="p">());</span>
        <span class="k">return</span> <span class="n">STATUS_UNSUCCESSFUL</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="c1">// Now we are going to set the value of the environment variable.</span>
    <span class="n">RegSetValueEx</span><span class="p">(</span><span class="n">hKey</span><span class="p">,</span> <span class="n">lpName</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">REG_SZ</span><span class="p">,</span> <span class="n">lpValue</span><span class="p">,</span> <span class="n">lstrlen</span><span class="p">(</span><span class="n">lpValue</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span><span class="p">);</span>

    <span class="c1">// Checking if the operation was successful by checking if the registry key actually exists.</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">RegGetValueA</span><span class="p">(</span><span class="n">hKey</span><span class="p">,</span> <span class="s">"Environment"</span><span class="p">,</span> <span class="n">lpValue</span><span class="p">,</span> <span class="n">RRF_RT_REG_SZ</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">)){</span>
        <span class="n">printf</span><span class="p">(</span><span class="s">"RegSetValueEx unsuccessful!"</span><span class="p">);</span>
        <span class="n">printf</span><span class="p">(</span><span class="s">"Error code: %d"</span><span class="p">,</span> <span class="n">GetLastError</span><span class="p">());</span>
        <span class="k">return</span> <span class="n">STATUS_UNSUCCESSFUL</span><span class="p">;</span>
    <span class="p">}</span>
    
    <span class="k">return</span> <span class="n">STATUS_SUCCESS</span><span class="p">;</span>
<span class="p">}</span>
</pre></table></code></div></div><p>I feel like the comments are enough but I’m still going to make you understand everything!</p><p>First of all I defined some constants, I have used them as status codes later in the program. You can change them as you want.</p><p>Then I predefined our wrapper function, whose name is <code class="language-plaintext highlighter-rouge">SetEnvironmentVariableR</code>, the type of this function is <code class="language-plaintext highlighter-rouge">NTSTATUS</code> which means this function will return a status code.</p><p>The function signature looks like this:</p><div class="language-c highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre><td class="rouge-code"><pre><span class="n">NTSTATUS</span> <span class="nf">SetEnvironmentVariableR</span><span class="p">(</span>
	<span class="n">LPCSTR</span> <span class="n">lpName</span><span class="p">,</span>
	<span class="n">LPCSTR</span> <span class="n">lpValue</span>
<span class="p">);</span>
</pre></table></code></div></div><p>The first parameter of this function is <code class="language-plaintext highlighter-rouge">lpName</code>. This parameter will be used to pass the name of the Environment variable that we want to modify.</p><p>The second parameter is <code class="language-plaintext highlighter-rouge">lpValue</code>. This parameter will be used to pass the value of the Environment variable that we want to store in <code class="language-plaintext highlighter-rouge">lpName</code>.</p><p>The we move on the <code class="language-plaintext highlighter-rouge">main</code> function.</p><p>First we defined some variables to store our stuff and then we asked the user for input then we called our wrapper function.</p><p>Then in the <code class="language-plaintext highlighter-rouge">SetEnvironmentVariableR</code> function, I have first Initialized the <code class="language-plaintext highlighter-rouge">HANDLE</code> that we will use later, then I called the <code class="language-plaintext highlighter-rouge">RegCreateKey</code> function to open the <code class="language-plaintext highlighter-rouge">HANDLE</code> of the registry key at <code class="language-plaintext highlighter-rouge">HKEY_CURRENT_USER\Environment</code> by specifying <code class="language-plaintext highlighter-rouge">HKEY_CURRENT_USER</code> as the first argument and <code class="language-plaintext highlighter-rouge">Environment</code> as the second one.</p><p>Then after some error checking, I have called the <code class="language-plaintext highlighter-rouge">RegSetValueEx</code> function to set the value (Environment variable) from the user input to the string that the user specified.</p><p>And then I have called the <code class="language-plaintext highlighter-rouge">RegGetValueA</code> function to check if the Registry value that we just created exists or not. I tried to make a better error checking where I tried to check the value of the Environment Variable after updating it but because the Registry values will not get refreshed just after we change them.</p><p>In the end, we return <code class="language-plaintext highlighter-rouge">STATUS_SUCCESS</code> to tell the caller that the function was successful.</p><p>That was the explanation of the whole program, now let’s run it and see how it looks in action!</p><h1 id="the-result">The result</h1><p>Here is the output of the program where I gave <code class="language-plaintext highlighter-rouge">works</code> as the Variable name and <code class="language-plaintext highlighter-rouge">yes</code> as the value of the Environment Variable.</p><p>(Using a screenshot from <a href="http://carbon.now.sh">carbon.now.sh</a> for better representation)</p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="https://i.ibb.co/MBhLPZL/reg-environment.png" alt="https://i.ibb.co/MBhLPZL/reg-environment.png" /></p><p>Now, Let’s check the Environment Variable by searching “edit environment variable” in the Windows search and opening the application to see if there is a Environment Variable named <code class="language-plaintext highlighter-rouge">works</code>.</p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="https://i.ibb.co/8nkH7FF/env-variables.png" alt="https://i.ibb.co/8nkH7FF/env-variables.png" /></p><p>Perfect!, It works as expected :D</p><h1 id="summary">Summary</h1><p>In this blog, we learnt about basic registry terms such as <code class="language-plaintext highlighter-rouge">Keys</code>, <code class="language-plaintext highlighter-rouge">Sub Keys</code> and <code class="language-plaintext highlighter-rouge">Values</code>. We also learnt to use some of the Windows API functions that allows us to play with The Windows Registry.</p><p>The functions were:</p><ol><li><code class="language-plaintext highlighter-rouge">RegCreateKey</code><li><code class="language-plaintext highlighter-rouge">RegSetValueEx</code><li><code class="language-plaintext highlighter-rouge">RegGetValueA</code></ol><p>If you have read this blog till now, I hope you learnt something new from this blog post and I hope you will surely read the upcoming blogs too.</p><p>I thought of including the part where I play with the system environment variables too but that would have made the blog too large and boring. If you wanna play with them on yourself, you can just change the <code class="language-plaintext highlighter-rouge">HKEY_CURRENT_USER</code> to <code class="language-plaintext highlighter-rouge">HKEY_LOCAL_MACHINE</code> and make sure to run the program from administrator PowerShell or cmd.</p><p>That’s all for this one, I’ll meet you in the next one ;)</p></div><div class="post-tail-wrapper text-muted"><div class="post-meta mb-3"> <i class="far fa-folder-open fa-fw mr-1"></i> <a href='/categories/programming/'>Programming</a>, <a href='/categories/windows/'>Windows</a>, <a href='/categories/windows-internals/'>Windows Internals</a>, <a href='/categories/winapi/'>WinAPI</a>, <a href='/categories/windows-registry/'>Windows Registry</a></div><div class="post-tags"> <i class="fa fa-tags fa-fw mr-1"></i> <a href="/tags/windows/" class="post-tag no-text-decoration" >Windows</a> <a href="/tags/windows-api-series/" class="post-tag no-text-decoration" >Windows API Series</a> <a href="/tags/windows-registry/" class="post-tag no-text-decoration" >Windows Registry</a></div><div class="post-tail-bottom d-flex justify-content-between align-items-center mt-3 pt-5 pb-2"><div class="license-wrapper"> This post is licensed under <a href="https://creativecommons.org/licenses/by/4.0/">CC BY 4.0</a> by the author.</div><div class="share-wrapper"> <span class="share-label text-muted mr-1">Share</span> <span class="share-icons"> <a href="https://twitter.com/intent/tweet?text=Windows API - Let's use the register to change our Environment! - Mr. Rc's blog&url=/posts/WinAPI-Using-Registry-Playing-With-Env-Variables/" data-toggle="tooltip" data-placement="top" title="Twitter" target="_blank" rel="noopener" aria-label="Twitter"> <i class="fa-fw fab fa-twitter"></i> </a> <a href="https://www.facebook.com/sharer/sharer.php?title=Windows API - Let's use the register to change our Environment! - Mr. Rc's blog&u=/posts/WinAPI-Using-Registry-Playing-With-Env-Variables/" data-toggle="tooltip" data-placement="top" title="Facebook" target="_blank" rel="noopener" aria-label="Facebook"> <i class="fa-fw fab fa-facebook-square"></i> </a> <a href="https://telegram.me/share?text=Windows API - Let's use the register to change our Environment! - Mr. Rc's blog&url=/posts/WinAPI-Using-Registry-Playing-With-Env-Variables/" data-toggle="tooltip" data-placement="top" title="Telegram" target="_blank" rel="noopener" aria-label="Telegram"> <i class="fa-fw fab fa-telegram"></i> </a> <i class="fa-fw fas fa-link small" onclick="copyLink()" data-toggle="tooltip" data-placement="top" title="Copy link"></i> </span></div></div></div></div></div><div id="panel-wrapper" class="col-xl-3 pl-2 text-muted topbar-down"><div class="access"><div id="access-lastmod" class="post"> <span>Recent Update</span><ul class="post-content pl-0 pb-1 ml-1 mt-2"><li><a href="/posts/WinAPI-Using-Registry-Playing-With-Env-Variables/">Windows API - Let's use the register to change our Environment!</a><li><a href="/posts/WinAPI-Environment-Variables/">Windows API - Let's Play with the Windows Environment Variables!</a></ul></div><div id="access-tags"> <span>Trending Tags</span><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/windows/">Windows</a> <a class="post-tag" href="/tags/windows-api-series/">Windows API Series</a> <a class="post-tag" href="/tags/virtual-memory-management/">Virtual Memory Management</a> <a class="post-tag" href="/tags/heap-api/">Heap API</a> <a class="post-tag" href="/tags/assembly/">Assembly</a> <a class="post-tag" href="/tags/operating-system/">Operating system</a> <a class="post-tag" href="/tags/windows-registry/">Windows Registry</a></div></div></div></div></div><div class="row"><div class="col-12 col-lg-11 col-xl-8"><div id="post-extend-wrapper" class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><div id="related-posts" class="mt-5 mb-2 mb-sm-4"><h3 class="pt-2 mt-1 mb-4 ml-1" data-toc-skip>Further Reading</h3><div class="card-deck mb-4"><div class="card"> <a href="/posts/Windows-API-Basics-of-Virtual-Memory-Management-API/"><div class="card-body"> <span class="timeago small" > Apr 15, 2021 <i class="unloaded">2021-04-15T09:03:00+05:30</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Windows API - Basics of Virtual Memory Management API.</h3><div class="text-muted small"><p> The Virtual Memory Manager in Windows (WMM) is available for user mode programs and can be used by the Win32 APIs to allocate memory and free them in the user space. From this blog, I am going to ...</p></div></div></a></div><div class="card"> <a href="/posts/Windows-API-More-on-Virtual-Memory/"><div class="card-body"> <span class="timeago small" > Apr 18, 2021 <i class="unloaded">2021-04-18T09:03:00+05:30</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Windows API - More on Virtual Memory.</h3><div class="text-muted small"><p> In this blog, we are going to have a look at some basic memory related things that we can do with the API functions that we learnt about in last blog post along with a new function VirtualQuery. B...</p></div></div></a></div><div class="card"> <a href="/posts/Windows-API-Heap-Functions/"><div class="card-body"> <span class="timeago small" > Apr 26, 2021 <i class="unloaded">2021-04-26T09:03:00+05:30</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Windows API - Let's learn about heap in deep!</h3><div class="text-muted small"><p> In this blog, We are continuing our series and going to study some Windows API functions related to Heap. We’ll see how to use this functions and how they can be useful to us with code examples and...</p></div></div></a></div></div></div><div class="post-navigation d-flex justify-content-between"> <a href="/posts/WinAPI-Environment-Variables/" class="btn btn-outline-primary" prompt="Older"><p>Windows API - Let's Play with the Windows Environment Variables!</p></a> <span class="btn btn-outline-primary disabled" prompt="Newer"><p>-</p></span></div></div></div></div><footer class="d-flex w-100 justify-content-center"><div class="d-flex justify-content-between align-items-center"><div class="footer-left"><p class="mb-0"> © 2022 <a href="https://twitter.com/coder_rc">Mr. Rc</a>. <span data-toggle="tooltip" data-placement="top" title="Except where otherwise noted, the blog posts on this site are licensed under the Creative Commons Attribution 4.0 International (CC BY 4.0) License by the author.">Some rights reserved.</span></p></div><div class="footer-right"><p class="mb-0"> Powered by <a href="https://jekyllrb.com" target="_blank" rel="noopener">Jekyll</a> with <a href="https://github.com/cotes2020/jekyll-theme-chirpy" target="_blank" rel="noopener">Chirpy</a> theme.</p></div></div></footer></div><div id="search-result-wrapper" class="d-flex justify-content-center unloaded"><div class="col-12 col-sm-11 post-content"><div id="search-hints"><h4 class="text-muted mb-4">Trending Tags</h4><a class="post-tag" href="/tags/windows/">Windows</a> <a class="post-tag" href="/tags/windows-api-series/">Windows API Series</a> <a class="post-tag" href="/tags/virtual-memory-management/">Virtual Memory Management</a> <a class="post-tag" href="/tags/heap-api/">Heap API</a> <a class="post-tag" href="/tags/assembly/">Assembly</a> <a class="post-tag" href="/tags/operating-system/">Operating system</a> <a class="post-tag" href="/tags/windows-registry/">Windows Registry</a></div><div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div></div></div></div><div id="mask"></div><a id="back-to-top" href="#" aria-label="back-to-top" class="btn btn-lg btn-box-shadow" role="button"> <i class="fas fa-angle-up"></i> </a> <script src="https://cdn.jsdelivr.net/npm/simple-jekyll-search@1.7.3/dest/simple-jekyll-search.min.js"></script> <script> SimpleJekyllSearch({ searchInput: document.getElementById('search-input'), resultsContainer: document.getElementById('search-results'), json: '/assets/js/data/search.json', searchResultTemplate: '<div class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-lg-4 pr-lg-4 pl-xl-0 pr-xl-0"> <a href="{url}">{title}</a><div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1"> {categories} {tags}</div><p>{snippet}</p></div>', noResultsText: '<p class="mt-5">Oops! No result founds.</p>', templateMiddleware: function(prop, value, template) { if (prop === 'categories') { if (value === '') { return `${value}`; } else { return `<div class="mr-sm-4"><i class="far fa-folder fa-fw"></i>${value}</div>`; } } if (prop === 'tags') { if (value === '') { return `${value}`; } else { return `<div><i class="fa fa-tag fa-fw"></i>${value}</div>`; } } } }); </script>
