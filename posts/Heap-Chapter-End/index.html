<!DOCTYPE html><html lang="en-US" ><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><meta name="generator" content="Jekyll v4.2.1" /><meta property="og:title" content="Windows API - Let’s end the Heap Chapter!" /><meta name="author" content="Mr. Rc" /><meta property="og:locale" content="en_US" /><meta name="description" content="Welcome to the last blog post on the HeapAPI functions from the Windows API series, this post willn’t be the last blog post for the whole Windows API series but it will be the last blog post for the HeapAPI functions. In this blog, we will play with some more heap functions with some code examples. Let’s start! 1. GetProcessHeap If you remember from the last blog, I told you that Every process has a heap already when it’s created. The function GetProcessHeap is used to get the Handle of the default heap of the process. The function’s syntax looks like this: 1 HANDLE GetProcessHeap(); We don’t need any arguments because it will return the Handle of current process. And that’s pretty much everything you need to know about this function. 2. HeapLock and HeapUnlock Before I start telling you about this function, you need to understand critical object aka critical section in operating systems. 2.1 Critical section The critical section is a code segment where the shared variables can be accessed. An atomic action is required in a critical section i.e. only one process can execute in its critical section at a time. All the other processes have to wait to execute in their critical sections. 2.2 HeapLock This function attempts to acquire the critical section object, or lock, of a specified heap. In simplest terms, If this function successfully acquires the critical section of a heap, then only the function will be able to use it until it unlocks it. The syntax of HeapLock function looks like this: 1 2 3 BOOL HeapLock( HANDLE hHeap ); We just have to pass the Handle of heap which is returned by GetProcessHeap or CreateHeap function as the first and only argument. To unlock the heap, we have to use the HeapUnlock function. The syntax of HeapUnlock looks like this: 1 2 3 BOOL HeapUnlock( HANDLE hHeap ); Same as HeapLock, we just have to pass the Handle to the Heap and it will unlock the critical section. 3. HeapDestroy As the name says, HeapDestroy function is used to destroy a heap. If you remember from the last blog post, I told that when we free a memory region, we can reallocate it. The Heap doesn’t gets destroyed when use HeapFree function. To completely destroy the Heap, we use the HeapDestroy the function. Remember, we can’t delete the heap that we get by default for our process which we get by calling GetCurrentHeap function. The function syntax of HeapDestroy looks like this: 1 2 3 BOOL HeapDestroy( HANDLE hHeap ); Same as all the other functions, we just have to supply the Handle to the Heap and the Handle shouldn’t be Nothing complex, right! Now, let’s make use of these functions and make a program. Code Example In this first example, I have only used the GetCurrentHeap. We will use the 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 #include &lt;stdio.h&gt; #include &lt;Windows.h&gt; #include &lt;string.h&gt; int main() { int heap_size; char data_to_store[2000]; char choice[20]; int* current_heap = GetProcessHeap(); // Getting the Handle of default Heap. printf(&quot;How much heap do you want to allocate? (int bytes): &quot;); scanf(&quot;%d&quot;, &amp;heap_size); int* heap = HeapAlloc(current_heap, HEAP_ZERO_MEMORY, heap_size); // Allocating heap of the user supplied size. Filled with zero by default. printf(&quot;The handle of heap of this program is %x\n&quot;, current_heap); printf(&quot;Enter the data you want to store in the heap: &quot;); scanf(&quot;%s&quot;, &amp;data_to_store); memmove(heap, (const void*)data_to_store, strlen(data_to_store)); // Moving the user supplied data into the allocated heap. printf(&quot;The data stored in heap is: %s\n&quot;, heap); int freed = HeapFree(current_heap, 0, heap); // Free()&#39;ing the heap. if (freed) { printf(&quot;The memory has been freed successfully!\n&quot;); } else { printf(&quot;Was not able to free heap!!&quot;); exit(1); } return 0; } The code is very simple and straight-forward. We first get the Handle of the default heap by calling the GetCurrentHeap function. The well allocate the amount of heap that user supplied then we ask the user to input the data that they want to move into the allocated heap, then it frees the heap. Let’s run this program and see the output. The output looks like this: 1 2 3 4 5 How much heap do you want to allocate? (int bytes): 8 The handle of heap of this program is 760000 Enter the data you want to store in the heap: hello The data stored in heap is: hello The memory has been freed successfully! Perfect!… I guess this is all you need to know about Heap functions in Windows API, I hope you liked this post. This was all for this one, meet you in the next one!" /><meta property="og:description" content="Welcome to the last blog post on the HeapAPI functions from the Windows API series, this post willn’t be the last blog post for the whole Windows API series but it will be the last blog post for the HeapAPI functions. In this blog, we will play with some more heap functions with some code examples. Let’s start! 1. GetProcessHeap If you remember from the last blog, I told you that Every process has a heap already when it’s created. The function GetProcessHeap is used to get the Handle of the default heap of the process. The function’s syntax looks like this: 1 HANDLE GetProcessHeap(); We don’t need any arguments because it will return the Handle of current process. And that’s pretty much everything you need to know about this function. 2. HeapLock and HeapUnlock Before I start telling you about this function, you need to understand critical object aka critical section in operating systems. 2.1 Critical section The critical section is a code segment where the shared variables can be accessed. An atomic action is required in a critical section i.e. only one process can execute in its critical section at a time. All the other processes have to wait to execute in their critical sections. 2.2 HeapLock This function attempts to acquire the critical section object, or lock, of a specified heap. In simplest terms, If this function successfully acquires the critical section of a heap, then only the function will be able to use it until it unlocks it. The syntax of HeapLock function looks like this: 1 2 3 BOOL HeapLock( HANDLE hHeap ); We just have to pass the Handle of heap which is returned by GetProcessHeap or CreateHeap function as the first and only argument. To unlock the heap, we have to use the HeapUnlock function. The syntax of HeapUnlock looks like this: 1 2 3 BOOL HeapUnlock( HANDLE hHeap ); Same as HeapLock, we just have to pass the Handle to the Heap and it will unlock the critical section. 3. HeapDestroy As the name says, HeapDestroy function is used to destroy a heap. If you remember from the last blog post, I told that when we free a memory region, we can reallocate it. The Heap doesn’t gets destroyed when use HeapFree function. To completely destroy the Heap, we use the HeapDestroy the function. Remember, we can’t delete the heap that we get by default for our process which we get by calling GetCurrentHeap function. The function syntax of HeapDestroy looks like this: 1 2 3 BOOL HeapDestroy( HANDLE hHeap ); Same as all the other functions, we just have to supply the Handle to the Heap and the Handle shouldn’t be Nothing complex, right! Now, let’s make use of these functions and make a program. Code Example In this first example, I have only used the GetCurrentHeap. We will use the 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 #include &lt;stdio.h&gt; #include &lt;Windows.h&gt; #include &lt;string.h&gt; int main() { int heap_size; char data_to_store[2000]; char choice[20]; int* current_heap = GetProcessHeap(); // Getting the Handle of default Heap. printf(&quot;How much heap do you want to allocate? (int bytes): &quot;); scanf(&quot;%d&quot;, &amp;heap_size); int* heap = HeapAlloc(current_heap, HEAP_ZERO_MEMORY, heap_size); // Allocating heap of the user supplied size. Filled with zero by default. printf(&quot;The handle of heap of this program is %x\n&quot;, current_heap); printf(&quot;Enter the data you want to store in the heap: &quot;); scanf(&quot;%s&quot;, &amp;data_to_store); memmove(heap, (const void*)data_to_store, strlen(data_to_store)); // Moving the user supplied data into the allocated heap. printf(&quot;The data stored in heap is: %s\n&quot;, heap); int freed = HeapFree(current_heap, 0, heap); // Free()&#39;ing the heap. if (freed) { printf(&quot;The memory has been freed successfully!\n&quot;); } else { printf(&quot;Was not able to free heap!!&quot;); exit(1); } return 0; } The code is very simple and straight-forward. We first get the Handle of the default heap by calling the GetCurrentHeap function. The well allocate the amount of heap that user supplied then we ask the user to input the data that they want to move into the allocated heap, then it frees the heap. Let’s run this program and see the output. The output looks like this: 1 2 3 4 5 How much heap do you want to allocate? (int bytes): 8 The handle of heap of this program is 760000 Enter the data you want to store in the heap: hello The data stored in heap is: hello The memory has been freed successfully! Perfect!… I guess this is all you need to know about Heap functions in Windows API, I hope you liked this post. This was all for this one, meet you in the next one!" /><link rel="canonical" href="/posts/Heap-Chapter-End/" /><meta property="og:url" content="/posts/Heap-Chapter-End/" /><meta property="og:site_name" content="Mr. Rc’s blog" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2021-05-29T09:03:00+05:30" /><meta name="twitter:card" content="summary" /><meta property="twitter:title" content="Windows API - Let’s end the Heap Chapter!" /><meta name="google-site-verification" content="google_meta_tag_verification" /> <script type="application/ld+json"> {"author":{"@type":"Person","name":"Mr. Rc"},"headline":"Windows API - Let’s end the Heap Chapter!","dateModified":"2021-05-29T09:03:00+05:30","datePublished":"2021-05-29T09:03:00+05:30","description":"Welcome to the last blog post on the HeapAPI functions from the Windows API series, this post willn’t be the last blog post for the whole Windows API series but it will be the last blog post for the HeapAPI functions. In this blog, we will play with some more heap functions with some code examples. Let’s start! 1. GetProcessHeap If you remember from the last blog, I told you that Every process has a heap already when it’s created. The function GetProcessHeap is used to get the Handle of the default heap of the process. The function’s syntax looks like this: 1 HANDLE GetProcessHeap(); We don’t need any arguments because it will return the Handle of current process. And that’s pretty much everything you need to know about this function. 2. HeapLock and HeapUnlock Before I start telling you about this function, you need to understand critical object aka critical section in operating systems. 2.1 Critical section The critical section is a code segment where the shared variables can be accessed. An atomic action is required in a critical section i.e. only one process can execute in its critical section at a time. All the other processes have to wait to execute in their critical sections. 2.2 HeapLock This function attempts to acquire the critical section object, or lock, of a specified heap. In simplest terms, If this function successfully acquires the critical section of a heap, then only the function will be able to use it until it unlocks it. The syntax of HeapLock function looks like this: 1 2 3 BOOL HeapLock( HANDLE hHeap ); We just have to pass the Handle of heap which is returned by GetProcessHeap or CreateHeap function as the first and only argument. To unlock the heap, we have to use the HeapUnlock function. The syntax of HeapUnlock looks like this: 1 2 3 BOOL HeapUnlock( HANDLE hHeap ); Same as HeapLock, we just have to pass the Handle to the Heap and it will unlock the critical section. 3. HeapDestroy As the name says, HeapDestroy function is used to destroy a heap. If you remember from the last blog post, I told that when we free a memory region, we can reallocate it. The Heap doesn’t gets destroyed when use HeapFree function. To completely destroy the Heap, we use the HeapDestroy the function. Remember, we can’t delete the heap that we get by default for our process which we get by calling GetCurrentHeap function. The function syntax of HeapDestroy looks like this: 1 2 3 BOOL HeapDestroy( HANDLE hHeap ); Same as all the other functions, we just have to supply the Handle to the Heap and the Handle shouldn’t be Nothing complex, right! Now, let’s make use of these functions and make a program. Code Example In this first example, I have only used the GetCurrentHeap. We will use the 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 #include &lt;stdio.h&gt; #include &lt;Windows.h&gt; #include &lt;string.h&gt; int main() { int heap_size; char data_to_store[2000]; char choice[20]; int* current_heap = GetProcessHeap(); // Getting the Handle of default Heap. printf(&quot;How much heap do you want to allocate? (int bytes): &quot;); scanf(&quot;%d&quot;, &amp;heap_size); int* heap = HeapAlloc(current_heap, HEAP_ZERO_MEMORY, heap_size); // Allocating heap of the user supplied size. Filled with zero by default. printf(&quot;The handle of heap of this program is %x\\n&quot;, current_heap); printf(&quot;Enter the data you want to store in the heap: &quot;); scanf(&quot;%s&quot;, &amp;data_to_store); memmove(heap, (const void*)data_to_store, strlen(data_to_store)); // Moving the user supplied data into the allocated heap. printf(&quot;The data stored in heap is: %s\\n&quot;, heap); int freed = HeapFree(current_heap, 0, heap); // Free()&#39;ing the heap. if (freed) { printf(&quot;The memory has been freed successfully!\\n&quot;); } else { printf(&quot;Was not able to free heap!!&quot;); exit(1); } return 0; } The code is very simple and straight-forward. We first get the Handle of the default heap by calling the GetCurrentHeap function. The well allocate the amount of heap that user supplied then we ask the user to input the data that they want to move into the allocated heap, then it frees the heap. Let’s run this program and see the output. The output looks like this: 1 2 3 4 5 How much heap do you want to allocate? (int bytes): 8 The handle of heap of this program is 760000 Enter the data you want to store in the heap: hello The data stored in heap is: hello The memory has been freed successfully! Perfect!… I guess this is all you need to know about Heap functions in Windows API, I hope you liked this post. This was all for this one, meet you in the next one!","url":"/posts/Heap-Chapter-End/","@type":"BlogPosting","mainEntityOfPage":{"@type":"WebPage","@id":"/posts/Heap-Chapter-End/"},"@context":"https://schema.org"}</script><title>Windows API - Let's end the Heap Chapter! | Mr. Rc's blog</title><link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicons/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicons/favicon-16x16.png"><link rel="manifest" href="/assets/img/favicons/site.webmanifest"><link rel="shortcut icon" href="/assets/img/favicons/favicon.ico"><meta name="apple-mobile-web-app-title" content="Mr. Rc's blog"><meta name="application-name" content="Mr. Rc's blog"><meta name="msapplication-TileColor" content="#da532c"><meta name="msapplication-config" content="/assets/img/favicons/browserconfig.xml"><meta name="theme-color" content="#ffffff"><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://fonts.gstatic.com"><link rel="preconnect" href="https://www.google-analytics.com" crossorigin="use-credentials"><link rel="dns-prefetch" href="https://www.google-analytics.com"><link rel="preconnect" href="https://www.googletagmanager.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://www.googletagmanager.com"><link rel="preconnect" href="https://cdn.jsdelivr.net"><link rel="dns-prefetch" href="https://cdn.jsdelivr.net"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.0.0/dist/css/bootstrap.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.11.2/css/all.min.css"><link rel="stylesheet" href="/assets/css/style.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/magnific-popup@1.1.0/dist/magnific-popup.min.css"> <script src="https://cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script> <script data-ad-client="ca-pub-2858626085073914" async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script> <script defer src="https://cdn.jsdelivr.net/combine/npm/popper.js@1.15.0,npm/bootstrap@4/dist/js/bootstrap.min.js"></script> <script async src="https://cdn.jsdelivr.net/combine/npm/lozad/dist/lozad.min.js,npm/magnific-popup@1/dist/jquery.magnific-popup.min.js"></script> <script defer src="/assets/js/dist/post.min.js"></script> <script defer src="/app.js"></script> <script defer src="https://www.googletagmanager.com/gtag/js?id=UA-199874344-1"></script> <script> document.addEventListener("DOMContentLoaded", function(event) { window.dataLayer = window.dataLayer || []; function gtag(){dataLayer.push(arguments);} gtag('js', new Date()); gtag('config', 'UA-199874344-1'); }); </script><body data-spy="scroll" data-target="#toc"><div id="sidebar" class="d-flex flex-column align-items-end"><div class="profile-wrapper text-center"><div id="avatar"> <a href="/" alt="avatar" class="mx-auto"> <img src="https://i.ibb.co/6W31BDG/skull.jpg" alt="avatar" onerror="this.style.display='none'"> </a></div><div class="site-title mt-3"> <a href="/">Mr. Rc's blog</a></div><div class="site-subtitle font-italic">A collection of Mr. Rc's Blogs.</div></div><ul class="w-100"><li class="nav-item"> <a href="/" class="nav-link"> <i class="fa-fw fas fa-home ml-xl-3 mr-xl-3 unloaded"></i> <span>HOME</span> </a><li class="nav-item"> <a href="/categories/" class="nav-link"> <i class="fa-fw fas fa-stream ml-xl-3 mr-xl-3 unloaded"></i> <span>CATEGORIES</span> </a><li class="nav-item"> <a href="/tags/" class="nav-link"> <i class="fa-fw fas fa-tags ml-xl-3 mr-xl-3 unloaded"></i> <span>TAGS</span> </a><li class="nav-item"> <a href="/archives/" class="nav-link"> <i class="fa-fw fas fa-archive ml-xl-3 mr-xl-3 unloaded"></i> <span>ARCHIVES</span> </a><li class="nav-item"> <a href="/about/" class="nav-link"> <i class="fa-fw fas fa-info ml-xl-3 mr-xl-3 unloaded"></i> <span>ABOUT</span> </a></ul><div class="sidebar-bottom mt-auto d-flex flex-wrap justify-content-center"> <a href="https://github.com/HACKE-RC" aria-label="github" class="order-3" target="_blank" rel="noopener"> <i class="fab fa-github-alt"></i> </a> <a href="https://twitter.com/" aria-label="twitter" class="order-4" target="_blank" rel="noopener"> <i class="fab fa-twitter"></i> </a> <a href=" javascript:location.href = 'mailto:' + ['cr.retsim','gmail.com'].join('@')" aria-label="email" class="order-5" > <i class="fas fa-envelope"></i> </a> <a href="/feed.xml" aria-label="rss" class="order-6" > <i class="fas fa-rss"></i> </a> <span class="icon-border order-2"></span> <span id="mode-toggle-wrapper" class="order-1"> <i class="mode-toggle fas fa-adjust"></i> <script type="text/javascript"> class ModeToggle { static get MODE_KEY() { return "mode"; } static get DARK_MODE() { return "dark"; } static get LIGHT_MODE() { return "light"; } constructor() { if (this.hasMode) { if (this.isDarkMode) { if (!this.isSysDarkPrefer) { this.setDark(); } } else { if (this.isSysDarkPrefer) { this.setLight(); } } } var self = this; /* always follow the system prefers */ this.sysDarkPrefers.addListener(function() { if (self.hasMode) { if (self.isDarkMode) { if (!self.isSysDarkPrefer) { self.setDark(); } } else { if (self.isSysDarkPrefer) { self.setLight(); } } self.clearMode(); } self.updateMermaid(); }); } /* constructor() */ setDark() { $('html').attr(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE); } setLight() { $('html').attr(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE); } clearMode() { $('html').removeAttr(ModeToggle.MODE_KEY); sessionStorage.removeItem(ModeToggle.MODE_KEY); } get sysDarkPrefers() { return window.matchMedia("(prefers-color-scheme: dark)"); } get isSysDarkPrefer() { return this.sysDarkPrefers.matches; } get isDarkMode() { return this.mode == ModeToggle.DARK_MODE; } get isLightMode() { return this.mode == ModeToggle.LIGHT_MODE; } get hasMode() { return this.mode != null; } get mode() { return sessionStorage.getItem(ModeToggle.MODE_KEY); } /* get the current mode on screen */ get modeStatus() { if (this.isDarkMode || (!this.hasMode && this.isSysDarkPrefer) ) { return ModeToggle.DARK_MODE; } else { return ModeToggle.LIGHT_MODE; } } updateMermaid() { if (typeof mermaid !== "undefined") { let expectedTheme = (this.modeStatus === ModeToggle.DARK_MODE? "dark" : "default"); let config = { theme: expectedTheme }; /* re-render the SVG › <https://github.com/mermaid-js/mermaid/issues/311#issuecomment-332557344> */ $(".mermaid").each(function() { let svgCode = $(this).prev().children().html(); $(this).removeAttr("data-processed"); $(this).html(svgCode); }); mermaid.initialize(config); mermaid.init(undefined, ".mermaid"); } } flipMode() { if (this.hasMode) { if (this.isSysDarkPrefer) { if (this.isLightMode) { this.clearMode(); } else { this.setLight(); } } else { if (this.isDarkMode) { this.clearMode(); } else { this.setDark(); } } } else { if (this.isSysDarkPrefer) { this.setLight(); } else { this.setDark(); } } this.updateMermaid(); } /* flipMode() */ } /* ModeToggle */ let toggle = new ModeToggle(); $(".mode-toggle").click(function() { toggle.flipMode(); }); </script> </span></div></div><div id="topbar-wrapper" class="row justify-content-center topbar-down"><div id="topbar" class="col-11 d-flex h-100 align-items-center justify-content-between"> <span id="breadcrumb"> <span> <a href="/"> Posts </a> </span> <span>Windows API - Let's end the Heap Chapter!</span> </span> <i id="sidebar-trigger" class="fas fa-bars fa-fw"></i><div id="topbar-title"> Post</div><i id="search-trigger" class="fas fa-search fa-fw"></i> <span id="search-wrapper" class="align-items-center"> <i class="fas fa-search fa-fw"></i> <input class="form-control" id="search-input" type="search" aria-label="search" autocomplete="off" placeholder="Search..."> <i class="fa fa-times-circle fa-fw" id="search-cleaner"></i> </span> <span id="search-cancel" >Cancel</span></div></div><div id="main-wrapper"><div id="main"><div class="row"><div id="post-wrapper" class="col-12 col-lg-11 col-xl-8"><div class="post pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><h1 data-toc-skip>Windows API - Let's end the Heap Chapter!</h1><div class="post-meta text-muted d-flex flex-column"><div> <span class="semi-bold"> Mr. Rc </span> <span class="timeago " data-toggle="tooltip" data-placement="bottom" title="Sat, May 29, 2021, 9:03 AM +0530" prep="on" > May 29, 2021 <i class="unloaded">2021-05-29T09:03:00+05:30</i> </span></div><div> <span class="readtime" data-toggle="tooltip" data-placement="bottom" title="799 words">4 min</span></div></div><div class="post-content"><p>Welcome to the last blog post on the HeapAPI functions from the Windows API series, this post willn’t be the last blog post for the whole Windows API series but it will be the last blog post for the HeapAPI functions.</p><p>In this blog, we will play with some more heap functions with some code examples. Let’s start!</p><h1 id="1-getprocessheap">1. GetProcessHeap</h1><p>If you remember from the last blog, I told you that <strong>Every process has a heap already when it’s created. The function <code class="language-plaintext highlighter-rouge">GetProcessHeap</code> is used to get the Handle of the default heap of the process.</strong> <br /> The function’s syntax looks like this:</p><div class="language-c highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="n">HANDLE</span> <span class="nf">GetProcessHeap</span><span class="p">();</span>    
</pre></table></code></div></div><p>We don’t need any arguments because it will return the Handle of current process. <br /> And that’s pretty much everything you need to know about this function.</p><h1 id="2-heaplock-and-heapunlock">2. HeapLock and HeapUnlock</h1><p>Before I start telling you about this function, you need to understand <code class="language-plaintext highlighter-rouge">critical object</code> aka <code class="language-plaintext highlighter-rouge">critical section</code> in operating systems.</p><h2 id="21-critical-section">2.1 Critical section</h2><p>The critical section is a code segment where the shared variables can be accessed. An atomic action is required in a critical section i.e. <strong>only one process can execute in its critical section at a time. All the other processes have to wait to execute in their critical sections</strong>.</p><h2 id="22-heaplock">2.2 HeapLock</h2><p>This function <strong>attempts to acquire the critical section object, or lock, of a specified heap</strong>. <br /> In simplest terms, <strong>If this function successfully acquires the critical section of a heap, then only the function will be able to use it until it unlocks it</strong>. <br /> The syntax of <code class="language-plaintext highlighter-rouge">HeapLock</code> function looks like this:</p><div class="language-c highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre><td class="rouge-code"><pre><span class="n">BOOL</span> <span class="nf">HeapLock</span><span class="p">(</span>    
  <span class="n">HANDLE</span> <span class="n">hHeap</span>    
<span class="p">);</span> 
</pre></table></code></div></div><p>We just have to pass the Handle of heap which is returned by <code class="language-plaintext highlighter-rouge">GetProcessHeap</code> or <code class="language-plaintext highlighter-rouge">CreateHeap</code> function as the first and only argument.</p><p>To unlock the heap, we have to use the <code class="language-plaintext highlighter-rouge">HeapUnlock</code> function. The syntax of <code class="language-plaintext highlighter-rouge">HeapUnlock</code> looks like this:</p><div class="language-c highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre><td class="rouge-code"><pre><span class="n">BOOL</span> <span class="nf">HeapUnlock</span><span class="p">(</span>    
  <span class="n">HANDLE</span> <span class="n">hHeap</span>    
<span class="p">);</span>    
</pre></table></code></div></div><p>Same as <code class="language-plaintext highlighter-rouge">HeapLock</code>, we just have to pass the Handle to the Heap and it will unlock the critical section.</p><h1 id="3-heapdestroy">3. HeapDestroy</h1><p>As the name says, <code class="language-plaintext highlighter-rouge">HeapDestroy</code> function is used to destroy a heap. If you remember from the last blog post, I told that when we free a memory region, we can reallocate it. The Heap doesn’t gets destroyed when use <code class="language-plaintext highlighter-rouge">HeapFree</code> function. To completely destroy the Heap, we use the <code class="language-plaintext highlighter-rouge">HeapDestroy</code> the function. Remember, we can’t delete the heap that we get by default for our process which we get by calling <code class="language-plaintext highlighter-rouge">GetCurrentHeap</code> function.</p><p>The function syntax of <code class="language-plaintext highlighter-rouge">HeapDestroy</code> looks like this:</p><div class="language-c highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre><td class="rouge-code"><pre><span class="n">BOOL</span> <span class="nf">HeapDestroy</span><span class="p">(</span>    
  <span class="n">HANDLE</span> <span class="n">hHeap</span>    
<span class="p">);</span>    
</pre></table></code></div></div><p>Same as all the other functions, we just have to supply the Handle to the Heap and the Handle shouldn’t be</p><p>Nothing complex, right! <br /> Now, let’s make use of these functions and make a program.</p><h1 id="code-example">Code Example</h1><p>In this first example, I have only used the <code class="language-plaintext highlighter-rouge">GetCurrentHeap</code>. We will use the</p><div class="language-c highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
</pre><td class="rouge-code"><pre><span class="cp">#include &lt;stdio.h&gt;    
#include &lt;Windows.h&gt;    
#include &lt;string.h&gt;    
</span>    
<span class="kt">int</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>    
    <span class="kt">int</span> <span class="n">heap_size</span><span class="p">;</span>    
    <span class="kt">char</span> <span class="n">data_to_store</span><span class="p">[</span><span class="mi">2000</span><span class="p">];</span>    
    <span class="kt">char</span> <span class="n">choice</span><span class="p">[</span><span class="mi">20</span><span class="p">];</span>    
    <span class="kt">int</span><span class="o">*</span> <span class="n">current_heap</span> <span class="o">=</span> <span class="n">GetProcessHeap</span><span class="p">();</span> <span class="c1">// Getting the Handle of default Heap.    </span>
    
    <span class="n">printf</span><span class="p">(</span><span class="s">"How much heap do you want to allocate? (int bytes): "</span><span class="p">);</span>    
    <span class="n">scanf</span><span class="p">(</span><span class="s">"%d"</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">heap_size</span><span class="p">);</span>    
    
    <span class="kt">int</span><span class="o">*</span> <span class="n">heap</span> <span class="o">=</span> <span class="n">HeapAlloc</span><span class="p">(</span><span class="n">current_heap</span><span class="p">,</span> <span class="n">HEAP_ZERO_MEMORY</span><span class="p">,</span> <span class="n">heap_size</span><span class="p">);</span> <span class="c1">// Allocating heap of the user supplied size. Filled with zero by default.    </span>
    <span class="n">printf</span><span class="p">(</span><span class="s">"The handle of heap of this program is %x</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">current_heap</span><span class="p">);</span>    
    
    <span class="n">printf</span><span class="p">(</span><span class="s">"Enter the data you want to store in the heap: "</span><span class="p">);</span>    
    <span class="n">scanf</span><span class="p">(</span><span class="s">"%s"</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">data_to_store</span><span class="p">);</span>    
    <span class="n">memmove</span><span class="p">(</span><span class="n">heap</span><span class="p">,</span> <span class="p">(</span><span class="k">const</span> <span class="kt">void</span><span class="o">*</span><span class="p">)</span><span class="n">data_to_store</span><span class="p">,</span> <span class="n">strlen</span><span class="p">(</span><span class="n">data_to_store</span><span class="p">));</span> <span class="c1">// Moving the user supplied data into the allocated heap.    </span>
        
    <span class="n">printf</span><span class="p">(</span><span class="s">"The data stored in heap is: %s</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">heap</span><span class="p">);</span>    
    
    <span class="kt">int</span> <span class="n">freed</span> <span class="o">=</span> <span class="n">HeapFree</span><span class="p">(</span><span class="n">current_heap</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">heap</span><span class="p">);</span> <span class="c1">// Free()'ing the heap.    </span>
    
    <span class="k">if</span> <span class="p">(</span><span class="n">freed</span><span class="p">)</span> <span class="p">{</span>    
        <span class="n">printf</span><span class="p">(</span><span class="s">"The memory has been freed successfully!</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>    
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>    
        <span class="n">printf</span><span class="p">(</span><span class="s">"Was not able to free heap!!"</span><span class="p">);</span>    
        <span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>    
    <span class="p">}</span>    
        
    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>    
<span class="p">}</span>    
</pre></table></code></div></div><p>The code is very simple and straight-forward.</p><p>We first get the Handle of the default heap by calling the <code class="language-plaintext highlighter-rouge">GetCurrentHeap</code> function. The well allocate the amount of heap that user supplied then we ask the user to input the data that they want to move into the allocated heap, then it frees the heap.</p><p>Let’s run this program and see the output.</p><p>The output looks like this:</p><div class="language-plaintext highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre><td class="rouge-code"><pre>How much heap do you want to allocate? (int bytes): 8    
The handle of heap of this program is 760000      
Enter the data you want to store in the heap: hello    
The data stored in heap is: hello          
The memory has been freed successfully!    
</pre></table></code></div></div><p>Perfect!…</p><p>I guess this is all you need to know about Heap functions in Windows API, I hope you liked this post.</p><p>This was all for this one, meet you in the next one!</p></div><div class="post-tail-wrapper text-muted"><div class="post-meta mb-3"> <i class="far fa-folder-open fa-fw mr-1"></i> <a href='/categories/windows/'>Windows</a>, <a href='/categories/windows-internals/'>Windows Internals</a>, <a href='/categories/winapi/'>WinAPI</a></div><div class="post-tags"> <i class="fa fa-tags fa-fw mr-1"></i> <a href="/tags/windows/" class="post-tag no-text-decoration" >Windows</a> <a href="/tags/windows-api-series/" class="post-tag no-text-decoration" >Windows API Series</a> <a href="/tags/heap-api/" class="post-tag no-text-decoration" >Heap API</a></div><div class="post-tail-bottom d-flex justify-content-between align-items-center mt-3 pt-5 pb-2"><div class="license-wrapper"> This post is licensed under <a href="https://creativecommons.org/licenses/by/4.0/">CC BY 4.0</a> by the author.</div><div class="share-wrapper"> <span class="share-label text-muted mr-1">Share</span> <span class="share-icons"> <a href="https://twitter.com/intent/tweet?text=Windows API - Let's end the Heap Chapter! - Mr. Rc's blog&url=/posts/Heap-Chapter-End/" data-toggle="tooltip" data-placement="top" title="Twitter" target="_blank" rel="noopener" aria-label="Twitter"> <i class="fa-fw fab fa-twitter"></i> </a> <a href="https://www.facebook.com/sharer/sharer.php?title=Windows API - Let's end the Heap Chapter! - Mr. Rc's blog&u=/posts/Heap-Chapter-End/" data-toggle="tooltip" data-placement="top" title="Facebook" target="_blank" rel="noopener" aria-label="Facebook"> <i class="fa-fw fab fa-facebook-square"></i> </a> <a href="https://telegram.me/share?text=Windows API - Let's end the Heap Chapter! - Mr. Rc's blog&url=/posts/Heap-Chapter-End/" data-toggle="tooltip" data-placement="top" title="Telegram" target="_blank" rel="noopener" aria-label="Telegram"> <i class="fa-fw fab fa-telegram"></i> </a> <i class="fa-fw fas fa-link small" onclick="copyLink()" data-toggle="tooltip" data-placement="top" title="Copy link"></i> </span></div></div></div></div></div><div id="panel-wrapper" class="col-xl-3 pl-2 text-muted topbar-down"><div class="access"><div id="access-lastmod" class="post"> <span>Recent Update</span><ul class="post-content pl-0 pb-1 ml-1 mt-2"><li><a href="/posts/WinAPI-Using-Registry-Playing-With-Env-Variables/">Windows API - Let's use the register to change our Environment!</a><li><a href="/posts/WinAPI-Environment-Variables/">Windows API - Let's Play with the Windows Environment Variables!</a></ul></div><div id="access-tags"> <span>Trending Tags</span><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/windows/">Windows</a> <a class="post-tag" href="/tags/windows-api-series/">Windows API Series</a> <a class="post-tag" href="/tags/virtual-memory-management/">Virtual Memory Management</a> <a class="post-tag" href="/tags/heap-api/">Heap API</a> <a class="post-tag" href="/tags/assembly/">Assembly</a> <a class="post-tag" href="/tags/operating-system/">Operating system</a> <a class="post-tag" href="/tags/windows-registry/">Windows Registry</a></div></div></div><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.js"></script><div id="toc-wrapper" class="pl-0 pr-4 mb-5"> <span class="pl-3 pt-2 mb-2">Contents</span><nav id="toc" data-toggle="toc"></nav></div></div></div><div class="row"><div class="col-12 col-lg-11 col-xl-8"><div id="post-extend-wrapper" class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><div id="related-posts" class="mt-5 mb-2 mb-sm-4"><h3 class="pt-2 mt-1 mb-4 ml-1" data-toc-skip>Further Reading</h3><div class="card-deck mb-4"><div class="card"> <a href="/posts/Windows-API-Heap-Functions/"><div class="card-body"> <span class="timeago small" > Apr 26, 2021 <i class="unloaded">2021-04-26T09:03:00+05:30</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Windows API - Let's learn about heap in deep!</h3><div class="text-muted small"><p> In this blog, We are continuing our series and going to study some Windows API functions related to Heap. We’ll see how to use this functions and how they can be useful to us with code examples and...</p></div></div></a></div><div class="card"> <a href="/posts/Windows-API-Basics-of-Virtual-Memory-Management-API/"><div class="card-body"> <span class="timeago small" > Apr 15, 2021 <i class="unloaded">2021-04-15T09:03:00+05:30</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Windows API - Basics of Virtual Memory Management API.</h3><div class="text-muted small"><p> The Virtual Memory Manager in Windows (WMM) is available for user mode programs and can be used by the Win32 APIs to allocate memory and free them in the user space. From this blog, I am going to ...</p></div></div></a></div><div class="card"> <a href="/posts/Windows-API-More-on-Virtual-Memory/"><div class="card-body"> <span class="timeago small" > Apr 18, 2021 <i class="unloaded">2021-04-18T09:03:00+05:30</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Windows API - More on Virtual Memory.</h3><div class="text-muted small"><p> In this blog, we are going to have a look at some basic memory related things that we can do with the API functions that we learnt about in last blog post along with a new function VirtualQuery. B...</p></div></div></a></div></div></div><div class="post-navigation d-flex justify-content-between"> <a href="/posts/Windows-API-Heap-Functions/" class="btn btn-outline-primary" prompt="Older"><p>Windows API - Let's learn about heap in deep!</p></a> <a href="/posts/WinAPI-Environment-Variables/" class="btn btn-outline-primary" prompt="Newer"><p>Windows API - Let's Play with the Windows Environment Variables!</p></a></div></div></div></div><footer class="d-flex w-100 justify-content-center"><div class="d-flex justify-content-between align-items-center"><div class="footer-left"><p class="mb-0"> © 2022 <a href="https://twitter.com/coder_rc">Mr. Rc</a>. <span data-toggle="tooltip" data-placement="top" title="Except where otherwise noted, the blog posts on this site are licensed under the Creative Commons Attribution 4.0 International (CC BY 4.0) License by the author.">Some rights reserved.</span></p></div><div class="footer-right"><p class="mb-0"> Powered by <a href="https://jekyllrb.com" target="_blank" rel="noopener">Jekyll</a> with <a href="https://github.com/cotes2020/jekyll-theme-chirpy" target="_blank" rel="noopener">Chirpy</a> theme.</p></div></div></footer></div><div id="search-result-wrapper" class="d-flex justify-content-center unloaded"><div class="col-12 col-sm-11 post-content"><div id="search-hints"><h4 class="text-muted mb-4">Trending Tags</h4><a class="post-tag" href="/tags/windows/">Windows</a> <a class="post-tag" href="/tags/windows-api-series/">Windows API Series</a> <a class="post-tag" href="/tags/virtual-memory-management/">Virtual Memory Management</a> <a class="post-tag" href="/tags/heap-api/">Heap API</a> <a class="post-tag" href="/tags/assembly/">Assembly</a> <a class="post-tag" href="/tags/operating-system/">Operating system</a> <a class="post-tag" href="/tags/windows-registry/">Windows Registry</a></div><div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div></div></div></div><div id="mask"></div><a id="back-to-top" href="#" aria-label="back-to-top" class="btn btn-lg btn-box-shadow" role="button"> <i class="fas fa-angle-up"></i> </a> <script src="https://cdn.jsdelivr.net/npm/simple-jekyll-search@1.7.3/dest/simple-jekyll-search.min.js"></script> <script> SimpleJekyllSearch({ searchInput: document.getElementById('search-input'), resultsContainer: document.getElementById('search-results'), json: '/assets/js/data/search.json', searchResultTemplate: '<div class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-lg-4 pr-lg-4 pl-xl-0 pr-xl-0"> <a href="{url}">{title}</a><div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1"> {categories} {tags}</div><p>{snippet}</p></div>', noResultsText: '<p class="mt-5">Oops! No result founds.</p>', templateMiddleware: function(prop, value, template) { if (prop === 'categories') { if (value === '') { return `${value}`; } else { return `<div class="mr-sm-4"><i class="far fa-folder fa-fw"></i>${value}</div>`; } } if (prop === 'tags') { if (value === '') { return `${value}`; } else { return `<div><i class="fa fa-tag fa-fw"></i>${value}</div>`; } } } }); </script>
