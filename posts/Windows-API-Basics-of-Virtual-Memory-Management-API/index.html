<!DOCTYPE html><html lang="en-US" ><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><meta name="generator" content="Jekyll v4.2.1" /><meta property="og:title" content="Windows API - Basics of Virtual Memory Management API." /><meta name="author" content="Mr. Rc" /><meta property="og:locale" content="en_US" /><meta name="description" content="The Virtual Memory Manager in Windows (WMM) is available for user mode programs and can be used by the Win32 APIs to allocate memory and free them in the user space. From this blog, I am going to start a series on Windows API where we will explore some windows API functions and play with them. In this particular blog I have covered two functions from the Windows Memory Management API which are VirtualAlloc and VirtualFree in deep." /><meta property="og:description" content="The Virtual Memory Manager in Windows (WMM) is available for user mode programs and can be used by the Win32 APIs to allocate memory and free them in the user space. From this blog, I am going to start a series on Windows API where we will explore some windows API functions and play with them. In this particular blog I have covered two functions from the Windows Memory Management API which are VirtualAlloc and VirtualFree in deep." /><link rel="canonical" href="/posts/Windows-API-Basics-of-Virtual-Memory-Management-API/" /><meta property="og:url" content="/posts/Windows-API-Basics-of-Virtual-Memory-Management-API/" /><meta property="og:site_name" content="Mr. Rc’s blog" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2021-04-15T09:03:00+05:30" /><meta name="twitter:card" content="summary" /><meta property="twitter:title" content="Windows API - Basics of Virtual Memory Management API." /><meta name="google-site-verification" content="google_meta_tag_verification" /> <script type="application/ld+json"> {"author":{"@type":"Person","name":"Mr. Rc"},"headline":"Windows API - Basics of Virtual Memory Management API.","dateModified":"2021-04-15T09:03:00+05:30","datePublished":"2021-04-15T09:03:00+05:30","description":"The Virtual Memory Manager in Windows (WMM) is available for user mode programs and can be used by the Win32 APIs to allocate memory and free them in the user space. From this blog, I am going to start a series on Windows API where we will explore some windows API functions and play with them. In this particular blog I have covered two functions from the Windows Memory Management API which are VirtualAlloc and VirtualFree in deep.","url":"/posts/Windows-API-Basics-of-Virtual-Memory-Management-API/","@type":"BlogPosting","mainEntityOfPage":{"@type":"WebPage","@id":"/posts/Windows-API-Basics-of-Virtual-Memory-Management-API/"},"@context":"https://schema.org"}</script><title>Windows API - Basics of Virtual Memory Management API. | Mr. Rc's blog</title><link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicons/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicons/favicon-16x16.png"><link rel="manifest" href="/assets/img/favicons/site.webmanifest"><link rel="shortcut icon" href="/assets/img/favicons/favicon.ico"><meta name="apple-mobile-web-app-title" content="Mr. Rc's blog"><meta name="application-name" content="Mr. Rc's blog"><meta name="msapplication-TileColor" content="#da532c"><meta name="msapplication-config" content="/assets/img/favicons/browserconfig.xml"><meta name="theme-color" content="#ffffff"><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://fonts.gstatic.com"><link rel="preconnect" href="https://www.google-analytics.com" crossorigin="use-credentials"><link rel="dns-prefetch" href="https://www.google-analytics.com"><link rel="preconnect" href="https://www.googletagmanager.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://www.googletagmanager.com"><link rel="preconnect" href="https://cdn.jsdelivr.net"><link rel="dns-prefetch" href="https://cdn.jsdelivr.net"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.0.0/dist/css/bootstrap.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.11.2/css/all.min.css"><link rel="stylesheet" href="/assets/css/style.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/magnific-popup@1.1.0/dist/magnific-popup.min.css"> <script src="https://cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script> <script data-ad-client="ca-pub-2858626085073914" async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script> <script defer src="https://cdn.jsdelivr.net/combine/npm/popper.js@1.15.0,npm/bootstrap@4/dist/js/bootstrap.min.js"></script> <script async src="https://cdn.jsdelivr.net/combine/npm/lozad/dist/lozad.min.js,npm/magnific-popup@1/dist/jquery.magnific-popup.min.js"></script> <script defer src="/assets/js/dist/post.min.js"></script> <script defer src="/app.js"></script> <script defer src="https://www.googletagmanager.com/gtag/js?id=UA-199874344-1"></script> <script> document.addEventListener("DOMContentLoaded", function(event) { window.dataLayer = window.dataLayer || []; function gtag(){dataLayer.push(arguments);} gtag('js', new Date()); gtag('config', 'UA-199874344-1'); }); </script><body data-spy="scroll" data-target="#toc"><div id="sidebar" class="d-flex flex-column align-items-end"><div class="profile-wrapper text-center"><div id="avatar"> <a href="/" alt="avatar" class="mx-auto"> <img src="https://i.ibb.co/6W31BDG/skull.jpg" alt="avatar" onerror="this.style.display='none'"> </a></div><div class="site-title mt-3"> <a href="/">Mr. Rc's blog</a></div><div class="site-subtitle font-italic">A collection of Mr. Rc's Blogs.</div></div><ul class="w-100"><li class="nav-item"> <a href="/" class="nav-link"> <i class="fa-fw fas fa-home ml-xl-3 mr-xl-3 unloaded"></i> <span>HOME</span> </a><li class="nav-item"> <a href="/categories/" class="nav-link"> <i class="fa-fw fas fa-stream ml-xl-3 mr-xl-3 unloaded"></i> <span>CATEGORIES</span> </a><li class="nav-item"> <a href="/tags/" class="nav-link"> <i class="fa-fw fas fa-tags ml-xl-3 mr-xl-3 unloaded"></i> <span>TAGS</span> </a><li class="nav-item"> <a href="/archives/" class="nav-link"> <i class="fa-fw fas fa-archive ml-xl-3 mr-xl-3 unloaded"></i> <span>ARCHIVES</span> </a><li class="nav-item"> <a href="/about/" class="nav-link"> <i class="fa-fw fas fa-info ml-xl-3 mr-xl-3 unloaded"></i> <span>ABOUT</span> </a></ul><div class="sidebar-bottom mt-auto d-flex flex-wrap justify-content-center"> <a href="https://github.com/HACKE-RC" aria-label="github" class="order-3" target="_blank" rel="noopener"> <i class="fab fa-github-alt"></i> </a> <a href="https://twitter.com/" aria-label="twitter" class="order-4" target="_blank" rel="noopener"> <i class="fab fa-twitter"></i> </a> <a href=" javascript:location.href = 'mailto:' + ['cr.retsim','gmail.com'].join('@')" aria-label="email" class="order-5" > <i class="fas fa-envelope"></i> </a> <a href="/feed.xml" aria-label="rss" class="order-6" > <i class="fas fa-rss"></i> </a> <span class="icon-border order-2"></span> <span id="mode-toggle-wrapper" class="order-1"> <i class="mode-toggle fas fa-adjust"></i> <script type="text/javascript"> class ModeToggle { static get MODE_KEY() { return "mode"; } static get DARK_MODE() { return "dark"; } static get LIGHT_MODE() { return "light"; } constructor() { if (this.hasMode) { if (this.isDarkMode) { if (!this.isSysDarkPrefer) { this.setDark(); } } else { if (this.isSysDarkPrefer) { this.setLight(); } } } var self = this; /* always follow the system prefers */ this.sysDarkPrefers.addListener(function() { if (self.hasMode) { if (self.isDarkMode) { if (!self.isSysDarkPrefer) { self.setDark(); } } else { if (self.isSysDarkPrefer) { self.setLight(); } } self.clearMode(); } self.updateMermaid(); }); } /* constructor() */ setDark() { $('html').attr(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE); } setLight() { $('html').attr(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE); } clearMode() { $('html').removeAttr(ModeToggle.MODE_KEY); sessionStorage.removeItem(ModeToggle.MODE_KEY); } get sysDarkPrefers() { return window.matchMedia("(prefers-color-scheme: dark)"); } get isSysDarkPrefer() { return this.sysDarkPrefers.matches; } get isDarkMode() { return this.mode == ModeToggle.DARK_MODE; } get isLightMode() { return this.mode == ModeToggle.LIGHT_MODE; } get hasMode() { return this.mode != null; } get mode() { return sessionStorage.getItem(ModeToggle.MODE_KEY); } /* get the current mode on screen */ get modeStatus() { if (this.isDarkMode || (!this.hasMode && this.isSysDarkPrefer) ) { return ModeToggle.DARK_MODE; } else { return ModeToggle.LIGHT_MODE; } } updateMermaid() { if (typeof mermaid !== "undefined") { let expectedTheme = (this.modeStatus === ModeToggle.DARK_MODE? "dark" : "default"); let config = { theme: expectedTheme }; /* re-render the SVG › <https://github.com/mermaid-js/mermaid/issues/311#issuecomment-332557344> */ $(".mermaid").each(function() { let svgCode = $(this).prev().children().html(); $(this).removeAttr("data-processed"); $(this).html(svgCode); }); mermaid.initialize(config); mermaid.init(undefined, ".mermaid"); } } flipMode() { if (this.hasMode) { if (this.isSysDarkPrefer) { if (this.isLightMode) { this.clearMode(); } else { this.setLight(); } } else { if (this.isDarkMode) { this.clearMode(); } else { this.setDark(); } } } else { if (this.isSysDarkPrefer) { this.setLight(); } else { this.setDark(); } } this.updateMermaid(); } /* flipMode() */ } /* ModeToggle */ let toggle = new ModeToggle(); $(".mode-toggle").click(function() { toggle.flipMode(); }); </script> </span></div></div><div id="topbar-wrapper" class="row justify-content-center topbar-down"><div id="topbar" class="col-11 d-flex h-100 align-items-center justify-content-between"> <span id="breadcrumb"> <span> <a href="/"> Posts </a> </span> <span>Windows API - Basics of Virtual Memory Management API.</span> </span> <i id="sidebar-trigger" class="fas fa-bars fa-fw"></i><div id="topbar-title"> Post</div><i id="search-trigger" class="fas fa-search fa-fw"></i> <span id="search-wrapper" class="align-items-center"> <i class="fas fa-search fa-fw"></i> <input class="form-control" id="search-input" type="search" aria-label="search" autocomplete="off" placeholder="Search..."> <i class="fa fa-times-circle fa-fw" id="search-cleaner"></i> </span> <span id="search-cancel" >Cancel</span></div></div><div id="main-wrapper"><div id="main"><div class="row"><div id="post-wrapper" class="col-12 col-lg-11 col-xl-8"><div class="post pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><h1 data-toc-skip>Windows API - Basics of Virtual Memory Management API.</h1><div class="post-meta text-muted d-flex flex-column"><div> <span class="semi-bold"> Mr. Rc </span> <span class="timeago " data-toggle="tooltip" data-placement="bottom" title="Thu, Apr 15, 2021, 9:03 AM +0530" prep="on" > Apr 15, 2021 <i class="unloaded">2021-04-15T09:03:00+05:30</i> </span></div><div> <span class="readtime" data-toggle="tooltip" data-placement="bottom" title="1757 words">9 min</span></div></div><div class="post-content"><p>The Virtual Memory Manager in Windows (WMM) is available for user mode programs and can be used by the Win32 APIs to allocate memory and free them in the user space. From this blog, I am going to start a series on Windows API where we will explore some windows API functions and play with them. In this particular blog I have covered two functions from the Windows Memory Management API which are <code class="language-plaintext highlighter-rouge">VirtualAlloc</code> and <code class="language-plaintext highlighter-rouge">VirtualFree</code> in deep.</p><h1 id="1-virtualalloc">1. VirtualAlloc</h1><p>The <code class="language-plaintext highlighter-rouge">VirtualAlloc</code> function is used to allocate large private memory blocks and manage them in the user mode. The term Private memory blocks means that the memory region allocated by this function is private to the process that created it. By default, when we locate a memory block by using this function, it is initialized as zero.</p><p>Let’s take a deeper look into this function and create a C program to use it.</p><p>This is the function syntax according to the Microsoft documentation.</p><pre><code class="language-C">LPVOID VirtualAlloc(
  LPVOID lpAddress,
  SIZE_T dwSize,
  DWORD  flAllocationType,
  DWORD  flProtect
);
</code></pre><p>If you look closely, you’ll see that the function type is <code class="language-plaintext highlighter-rouge">LPVOID</code>, <code class="language-plaintext highlighter-rouge">LPVOID</code> is a pointer to a void object. <code class="language-plaintext highlighter-rouge">LPVOID</code> is just <code class="language-plaintext highlighter-rouge">typedef void* LPVOID</code> in the Windef.h. In simple words, <code class="language-plaintext highlighter-rouge">LPVOID</code> is an alias for <code class="language-plaintext highlighter-rouge">void *</code>. <code class="language-plaintext highlighter-rouge">LP</code> in <code class="language-plaintext highlighter-rouge">LPVOID</code> stands for long pointer.</p><p>The first argument required for the function is <code class="language-plaintext highlighter-rouge">lpAddress</code>. It is used to specify the starting address of the memory region to allocate. If you don’t know where to allocate memory, you can simply specify <code class="language-plaintext highlighter-rouge">NULL</code> and the system will decide where to allocate the memory. If the address that you specified is from a memory region that you don’t have access to or if it’s an invalid address to allocate the function will fail with ERROR_INVALID_ADDRESS error.</p><p>The second argument is <code class="language-plaintext highlighter-rouge">dwSize</code>. It is used to specify the size of the memory region that you want to allocate in <em>bytes</em>. If the <code class="language-plaintext highlighter-rouge">lpAddress</code> argument was specified as <code class="language-plaintext highlighter-rouge">NULL</code> then this value will be rounded up to the next page boundary.</p><p>The third argument is <code class="language-plaintext highlighter-rouge">fAllocationType</code>. It is used to specify which type of memory allocation we need. Here are valid types as defined in the Microsoft documentation for <code class="language-plaintext highlighter-rouge">fAllocationType</code>: <a href="https://www.notion.so/a8e846fdb9a346d38a6fdc116bbe61b4?v=4dd087bea5cd4bd0bda480e1df654438">Read here</a></p><p>If you are confused about the hex digits which are written after every value, it is the actual value that will be translated to if you will use the value. If you use <code class="language-plaintext highlighter-rouge">MEM_COMMIT</code> it will be replaced with <code class="language-plaintext highlighter-rouge">0x00001000</code> and same with all other values.</p><p>There are some other arguments also that can be used with this which are not so useful to us and not commonly used, if you want to read about them here:</p><p><a href="https://docs.microsoft.com/en-us/windows/win32/api/memoryapi/nf-memoryapi-virtualalloc#arguments">VirtualAlloc function (memoryapi.h) - Win32 apps</a></p><p>Our last argument is <code class="language-plaintext highlighter-rouge">flProtect</code>, this is used to specify the memory protection for the memory region that we are allocating. This are the values that we can specify in <code class="language-plaintext highlighter-rouge">flProtect</code>:</p><ul><li>PAGE_NOACCESS<li>PAGE_GUARD<li>PAGE_NOCACHE<li>PAGE_WRITECOMBINE</ul><p>This is how we can use this values: Note: Pages and memory regions words are used both referring to the memory region that is being allocated. As we’re allocating Virtual memory, the memory regions will be created with their pages so I think they can be used interchangeably.</p><p><a href="https://www.notion.so/6e58799af3f941d681bd31a299aa8957">Some memory protection constants that can be used</a></p><p>This are just a small number of examples of constants, you can read about many more here :</p><p><a href="https://docs.microsoft.com/en-us/windows/win32/memory/memory-protection-constants">Memory Protection Constants (WinNT.h) - Win32 apps</a></p><h2 id="return-value">Return value</h2><p>If the function succeeds, it will return the starting address of the memory region that we specified or left <code class="language-plaintext highlighter-rouge">NULL</code>. If the function fails, it will return <code class="language-plaintext highlighter-rouge">NULL</code>.</p><h1 id="2-virtualfree">2. VirtualFree</h1><p>As we have learnt to Allocate memory, we will now see how to free it. It’s pretty simple but necessary to learn.</p><p>This is the syntax for <code class="language-plaintext highlighter-rouge">VirtualMemory</code> according to the Microsoft documentation:</p><div class="language-jsx highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre><td class="rouge-code"><pre><span class="nx">BOOL</span> <span class="nx">VirtualFree</span><span class="p">(</span>
  <span class="nx">LPVOID</span> <span class="nx">lpAddress</span><span class="p">,</span>
  <span class="nx">SIZE_T</span> <span class="nx">dwSize</span><span class="p">,</span>
  <span class="nx">DWORD</span>  <span class="nx">dwFreeType</span>
<span class="p">);</span>
</pre></table></code></div></div><p>As you can see, the type of this function is <code class="language-plaintext highlighter-rouge">BOOL</code>, it means that it will either return true or false. It depends on the result of the operation that we are doing.</p><p>The first argument to this function is <code class="language-plaintext highlighter-rouge">lpAddress</code>. We already know that this argument is used to pass the base address of the memory region with which we want to play. If you’re confused, don’t worry we will see the code examples and it will eventually clear your doubts.</p><p>The second argument is <code class="language-plaintext highlighter-rouge">dwSize</code>. We also know about this argument, it is used to pass the size in <em>bytes</em> of the memory region which we want to play with. Here, we will use it specify the size of the memory region that we want to free.</p><p>The last argument is <code class="language-plaintext highlighter-rouge">dwFreeType</code>. It is used to specify the type which we want to use to free the memory. You may be little bit confused but you will not be once you see the valid free types.</p><p><a href="https://www.notion.so/771971f5e05341babefcb2750aee6207">Valid dwFreeTypes</a></p><h2 id="return-value-1">Return value</h2><p>If the function does its job successfully, it returns nonzero.</p><p>If the function fails, it will return a zero (0).</p><h1 id="code-examples">Code examples</h1><p>As we have looked into all the things, now it’s time to write some code and clear all the doubts.</p><h2 id="example-1---virtualalloc">Example 1 - VirtualAlloc</h2><p>Let’s start with taking example of <code class="language-plaintext highlighter-rouge">VirtualAlloc</code>. We will write some code which will commit 8 bytes of virtual memory. Let’s first include the <code class="language-plaintext highlighter-rouge">memoryapi.h</code> file, this file contains almost all the utilities that we need in the user mode to use Virtual Memory related functions:</p><div class="language-c highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre><td class="rouge-code"><pre><span class="cp">#include &lt;stdio.h&gt;
#include &lt;memoryapi.h&gt;
</span></pre></table></code></div></div><p>Now let’s define a main function that will use the <code class="language-plaintext highlighter-rouge">VirtualAlloc</code> function and commit 8 bytes of Virtual Memory. We will specify the <code class="language-plaintext highlighter-rouge">lpAddress</code> argument as <code class="language-plaintext highlighter-rouge">NULL</code> so that the system will determine from where to allocate the memory. Here is how the code looks like:</p><div class="language-c highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
</pre><td class="rouge-code"><pre><span class="cp">#include &lt;stdio.h&gt;
#include &lt;memoryapi.h&gt;
</span>
<span class="kt">int</span> <span class="nf">main</span><span class="p">(){</span>
	<span class="kt">int</span> <span class="o">*</span><span class="n">pointer_to_memory</span> <span class="o">=</span> <span class="n">VirtualAlloc</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="n">MEM_COMMIT</span><span class="p">,</span> <span class="n">PAGE_NOCACHE</span><span class="p">);</span>
	<span class="n">printf</span><span class="p">(</span><span class="s">"%x"</span><span class="p">,</span> <span class="n">pointer_to_memory</span><span class="p">);</span>
<span class="p">}</span>
</pre></table></code></div></div><p>If you wonder why I used <code class="language-plaintext highlighter-rouge">PAGE_NOCACHE</code>, if you remember the valid types for the argument <code class="language-plaintext highlighter-rouge">flProtect</code>, <code class="language-plaintext highlighter-rouge">PAGE_NOCACHE</code> is one of them. The other reason why I used it is that it is the only one argument that we can use normally, by normally I mean that if you look at all other valid types they are intended to be used in complex and real world coding scenarios but now we are just understanding how it works so it’s good to use a normal type as the first example.</p><p>The explanation of code is simple, first we included the required files that had all the functions of our interest then we used the <code class="language-plaintext highlighter-rouge">VirtualAlloc</code> and assigned the memory address given by it to the <code class="language-plaintext highlighter-rouge">pointer_to_memory</code> variable then we printed it.</p><p>Do you know something is missing in the code? Think about it…. I hope you found it, it’s the <code class="language-plaintext highlighter-rouge">VirtualFree</code> function. Whenever we allocate memory which is not from the stack, we have to free it.</p><p>Now it’s time to implement the <code class="language-plaintext highlighter-rouge">VirtualFree</code> function, so here it is:</p><div class="language-c highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
</pre><td class="rouge-code"><pre><span class="cp">#include &lt;stdio.h&gt;
#include &lt;memoryapi.h&gt;
</span>
<span class="kt">int</span> <span class="nf">main</span><span class="p">(){</span>
    <span class="kt">int</span> <span class="o">*</span><span class="n">pointer_to_memory</span> <span class="o">=</span> <span class="n">VirtualAlloc</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="n">MEM_COMMIT</span><span class="p">,</span> <span class="n">PAGE_READWRITE</span><span class="p">);</span>
    <span class="n">printf</span><span class="p">(</span><span class="s">"The base address of allocated memory is: %x"</span><span class="p">,</span> <span class="n">pointer_to_memory</span><span class="p">);</span>
    <span class="n">VirtualFree</span><span class="p">(</span><span class="n">pointer_to_memory</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="n">MEM_DECOMMIT</span><span class="p">);</span>
<span class="p">}</span>
</pre></table></code></div></div><p>You shouldn’t have doubts but if you have, let me clear all of them. Let’s understand the <code class="language-plaintext highlighter-rouge">main</code> function again. First I created a integer type pointer variable which is pointing to the memory address returned by <code class="language-plaintext highlighter-rouge">VirtualAlloc</code>. We have passed four parameters to the <code class="language-plaintext highlighter-rouge">VirtualAlloc</code> function.</p><p>The first parameter is <code class="language-plaintext highlighter-rouge">NULL</code>, by passing <code class="language-plaintext highlighter-rouge">NULL</code> as a argument we are telling the function that the starting point of the memory region should be decided by the system.</p><p>The second parameter is the size of the memory region that we want to allocate in bytes.</p><p>The third parameter is the allocation type, we are specifying that we want to commit the memory. After we commit a memory region, it is available to us for our use.</p><p>The last parameter is <code class="language-plaintext highlighter-rouge">PAGE_READWRITE</code>, it means that we want the permission to read and write on this memory region.</p><p>The we are printing memory address return by <code class="language-plaintext highlighter-rouge">VirtualAlloc</code> function as a hex value.</p><p>At last, we are decommitting the memory region that we allocated.</p><p>The first parameter is the base address of the memory region that we allocated.</p><p>The second parameter is the size of memory region in bytes, we specified <code class="language-plaintext highlighter-rouge">8</code> while allocating it so the we’ll specify <code class="language-plaintext highlighter-rouge">8</code> while deallocating it.</p><p>Then we have specified the type of deallocation that we want. As we are using <code class="language-plaintext highlighter-rouge">MEM_DECOMMIT</code>, the memory region will be reserved after it gets decommitted, which means that any other function will not be able to use it after you decommit it until you use <code class="language-plaintext highlighter-rouge">VirtualFree</code> function again to release the memory region.</p><h2 id="running-the-code-example-1">Running the code example #1</h2><p>As we almost done everything, let’s compile and run the code. I suggest you to write the code by yourself and see the result. This is the result when I ran it:</p><div class="language-markdown highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>The base address of allocated memory is: <span class="sb">`61fe18`</span>
</pre></table></code></div></div><p>Cool, right? We have just used the <code class="language-plaintext highlighter-rouge">VirtualAlloc</code> function to allocate 8 bytes of memory and we freed it by ourselves. Now let’s add a string in the allocated memory and print it.</p><h2 id="example-2---virtualalloc">Example 2 - VirtualAlloc</h2><p>Now let’s assign some data to the memory that we allocated:</p><div class="language-c highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
</pre><td class="rouge-code"><pre><span class="cp">#include &lt;stdio.h&gt;
#include &lt;memoryapi.h&gt;
</span>
<span class="kt">int</span> <span class="nf">main</span><span class="p">(){</span>
    <span class="kt">int</span> <span class="o">*</span><span class="n">pointer_to_memory</span> <span class="o">=</span> <span class="n">VirtualAlloc</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="n">MEM_COMMIT</span><span class="p">,</span> <span class="n">PAGE_READWRITE</span><span class="p">);</span>
    <span class="n">printf</span><span class="p">(</span><span class="s">"The base address of allocated memory is: 0x%d</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">pointer_to_memory</span><span class="p">);</span>
    <span class="n">memmove</span><span class="p">(</span><span class="n">pointer_to_memory</span><span class="p">,</span> <span class="p">(</span><span class="k">const</span> <span class="kt">void</span><span class="o">*</span><span class="p">)</span><span class="s">"1337"</span><span class="p">,</span> <span class="mi">4</span><span class="p">);</span>
    <span class="n">printf</span><span class="p">(</span><span class="s">"The data which is stored in the memory is %s"</span><span class="p">,</span> <span class="n">pointer_to_memory</span><span class="p">);</span>
    <span class="n">VirtualFree</span><span class="p">(</span><span class="n">pointer_to_memory</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="n">MEM_DECOMMIT</span><span class="p">);</span>
<span class="p">}</span>
</pre></table></code></div></div><p>The <code class="language-plaintext highlighter-rouge">memmove</code> function is used to copy data from one destination to other. The first argument to this function is the destination memory address where you want to copy the data and the second argument is the data that will be copied and the last and third argument is the size of data. Here, we have copied 1337 to the memory location which was returned by <code class="language-plaintext highlighter-rouge">VirtualAlloc</code>. If you’re confused about the type conversion, it’s used because <code class="language-plaintext highlighter-rouge">memmove</code> takes second argument as a <code class="language-plaintext highlighter-rouge">const void</code> pointer and we can’t directly pass it a <code class="language-plaintext highlighter-rouge">char</code> array.</p><h2 id="running-the-code-example-2">Running the code example #2</h2><p>Let’s compile and run the code. This is the output that we’ll get:</p><div class="language-c highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre><td class="rouge-code"><pre><span class="n">The</span> <span class="n">base</span> <span class="n">address</span> <span class="n">of</span> <span class="n">allocated</span> <span class="n">memory</span> <span class="n">is</span><span class="o">:</span> <span class="mi">61</span><span class="n">fe18</span>
<span class="n">The</span> <span class="n">data</span> <span class="n">which</span> <span class="n">is</span> <span class="n">stored</span> <span class="n">in</span> <span class="n">the</span> <span class="n">memory</span> <span class="n">is</span> <span class="mi">1337</span>
</pre></table></code></div></div><p>More cool, Right?</p><p>This was all for this one, meet you in the next one!</p></div><div class="post-tail-wrapper text-muted"><div class="post-meta mb-3"> <i class="far fa-folder-open fa-fw mr-1"></i> <a href='/categories/programming/'>Programming</a>, <a href='/categories/windows/'>Windows</a>, <a href='/categories/windows-internals/'>Windows Internals</a>, <a href='/categories/winapi/'>WinAPI</a></div><div class="post-tags"> <i class="fa fa-tags fa-fw mr-1"></i> <a href="/tags/windows/" class="post-tag no-text-decoration" >Windows</a> <a href="/tags/windows-api-series/" class="post-tag no-text-decoration" >Windows API Series</a> <a href="/tags/virtual-memory-management/" class="post-tag no-text-decoration" >Virtual Memory Management</a></div><div class="post-tail-bottom d-flex justify-content-between align-items-center mt-3 pt-5 pb-2"><div class="license-wrapper"> This post is licensed under <a href="https://creativecommons.org/licenses/by/4.0/">CC BY 4.0</a> by the author.</div><div class="share-wrapper"> <span class="share-label text-muted mr-1">Share</span> <span class="share-icons"> <a href="https://twitter.com/intent/tweet?text=Windows API - Basics of Virtual Memory Management API. - Mr. Rc's blog&url=/posts/Windows-API-Basics-of-Virtual-Memory-Management-API/" data-toggle="tooltip" data-placement="top" title="Twitter" target="_blank" rel="noopener" aria-label="Twitter"> <i class="fa-fw fab fa-twitter"></i> </a> <a href="https://www.facebook.com/sharer/sharer.php?title=Windows API - Basics of Virtual Memory Management API. - Mr. Rc's blog&u=/posts/Windows-API-Basics-of-Virtual-Memory-Management-API/" data-toggle="tooltip" data-placement="top" title="Facebook" target="_blank" rel="noopener" aria-label="Facebook"> <i class="fa-fw fab fa-facebook-square"></i> </a> <a href="https://telegram.me/share?text=Windows API - Basics of Virtual Memory Management API. - Mr. Rc's blog&url=/posts/Windows-API-Basics-of-Virtual-Memory-Management-API/" data-toggle="tooltip" data-placement="top" title="Telegram" target="_blank" rel="noopener" aria-label="Telegram"> <i class="fa-fw fab fa-telegram"></i> </a> <i class="fa-fw fas fa-link small" onclick="copyLink()" data-toggle="tooltip" data-placement="top" title="Copy link"></i> </span></div></div></div></div></div><div id="panel-wrapper" class="col-xl-3 pl-2 text-muted topbar-down"><div class="access"><div id="access-lastmod" class="post"> <span>Recent Update</span><ul class="post-content pl-0 pb-1 ml-1 mt-2"><li><a href="/posts/WinAPI-Using-Registry-Playing-With-Env-Variables/">Windows API - Let's use the register to change our Environment!</a><li><a href="/posts/WinAPI-Environment-Variables/">Windows API - Let's Play with the Windows Environment Variables!</a></ul></div><div id="access-tags"> <span>Trending Tags</span><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/windows/">Windows</a> <a class="post-tag" href="/tags/windows-api-series/">Windows API Series</a> <a class="post-tag" href="/tags/virtual-memory-management/">Virtual Memory Management</a> <a class="post-tag" href="/tags/heap-api/">Heap API</a> <a class="post-tag" href="/tags/assembly/">Assembly</a> <a class="post-tag" href="/tags/operating-system/">Operating system</a> <a class="post-tag" href="/tags/windows-registry/">Windows Registry</a></div></div></div><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.js"></script><div id="toc-wrapper" class="pl-0 pr-4 mb-5"> <span class="pl-3 pt-2 mb-2">Contents</span><nav id="toc" data-toggle="toc"></nav></div></div></div><div class="row"><div class="col-12 col-lg-11 col-xl-8"><div id="post-extend-wrapper" class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><div id="related-posts" class="mt-5 mb-2 mb-sm-4"><h3 class="pt-2 mt-1 mb-4 ml-1" data-toc-skip>Further Reading</h3><div class="card-deck mb-4"><div class="card"> <a href="/posts/Windows-API-More-on-Virtual-Memory/"><div class="card-body"> <span class="timeago small" > Apr 18, 2021 <i class="unloaded">2021-04-18T09:03:00+05:30</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Windows API - More on Virtual Memory.</h3><div class="text-muted small"><p> In this blog, we are going to have a look at some basic memory related things that we can do with the API functions that we learnt about in last blog post along with a new function VirtualQuery. B...</p></div></div></a></div><div class="card"> <a href="/posts/WinAPI-Environment-Variables/"><div class="card-body"> <span class="timeago small" > Jun 18, 2021 <i class="unloaded">2021-06-18T09:03:00+05:30</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Windows API - Let's Play with the Windows Environment Variables!</h3><div class="text-muted small"><p> In this blog, we are going to have a look at two functions that let us manipulate the Environment Variables of our Windows Machine. There are only two functions that are related to Environment Vari...</p></div></div></a></div><div class="card"> <a href="/posts/Windows-API-Heap-Functions/"><div class="card-body"> <span class="timeago small" > Apr 26, 2021 <i class="unloaded">2021-04-26T09:03:00+05:30</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Windows API - Let's learn about heap in deep!</h3><div class="text-muted small"><p> In this blog, We are continuing our series and going to study some Windows API functions related to Heap. We’ll see how to use this functions and how they can be useful to us with code examples and...</p></div></div></a></div></div></div><div class="post-navigation d-flex justify-content-between"> <a href="/posts/What's-inside-Windows/" class="btn btn-outline-primary" prompt="Older"><p>What's inside Windows?</p></a> <a href="/posts/Windows-API-More-on-Virtual-Memory/" class="btn btn-outline-primary" prompt="Newer"><p>Windows API - More on Virtual Memory.</p></a></div></div></div></div><footer class="d-flex w-100 justify-content-center"><div class="d-flex justify-content-between align-items-center"><div class="footer-left"><p class="mb-0"> © 2022 <a href="https://twitter.com/coder_rc">Mr. Rc</a>. <span data-toggle="tooltip" data-placement="top" title="Except where otherwise noted, the blog posts on this site are licensed under the Creative Commons Attribution 4.0 International (CC BY 4.0) License by the author.">Some rights reserved.</span></p></div><div class="footer-right"><p class="mb-0"> Powered by <a href="https://jekyllrb.com" target="_blank" rel="noopener">Jekyll</a> with <a href="https://github.com/cotes2020/jekyll-theme-chirpy" target="_blank" rel="noopener">Chirpy</a> theme.</p></div></div></footer></div><div id="search-result-wrapper" class="d-flex justify-content-center unloaded"><div class="col-12 col-sm-11 post-content"><div id="search-hints"><h4 class="text-muted mb-4">Trending Tags</h4><a class="post-tag" href="/tags/windows/">Windows</a> <a class="post-tag" href="/tags/windows-api-series/">Windows API Series</a> <a class="post-tag" href="/tags/virtual-memory-management/">Virtual Memory Management</a> <a class="post-tag" href="/tags/heap-api/">Heap API</a> <a class="post-tag" href="/tags/assembly/">Assembly</a> <a class="post-tag" href="/tags/operating-system/">Operating system</a> <a class="post-tag" href="/tags/windows-registry/">Windows Registry</a></div><div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div></div></div></div><div id="mask"></div><a id="back-to-top" href="#" aria-label="back-to-top" class="btn btn-lg btn-box-shadow" role="button"> <i class="fas fa-angle-up"></i> </a> <script src="https://cdn.jsdelivr.net/npm/simple-jekyll-search@1.7.3/dest/simple-jekyll-search.min.js"></script> <script> SimpleJekyllSearch({ searchInput: document.getElementById('search-input'), resultsContainer: document.getElementById('search-results'), json: '/assets/js/data/search.json', searchResultTemplate: '<div class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-lg-4 pr-lg-4 pl-xl-0 pr-xl-0"> <a href="{url}">{title}</a><div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1"> {categories} {tags}</div><p>{snippet}</p></div>', noResultsText: '<p class="mt-5">Oops! No result founds.</p>', templateMiddleware: function(prop, value, template) { if (prop === 'categories') { if (value === '') { return `${value}`; } else { return `<div class="mr-sm-4"><i class="far fa-folder fa-fw"></i>${value}</div>`; } } if (prop === 'tags') { if (value === '') { return `${value}`; } else { return `<div><i class="fa fa-tag fa-fw"></i>${value}</div>`; } } } }); </script>
