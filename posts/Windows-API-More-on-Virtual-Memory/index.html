<!DOCTYPE html><html lang="en-US" ><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><meta name="generator" content="Jekyll v4.2.1" /><meta property="og:title" content="Windows API - More on Virtual Memory." /><meta name="author" content="Mr. Rc" /><meta property="og:locale" content="en_US" /><meta name="description" content="In this blog, we are going to have a look at some basic memory related things that we can do with the API functions that we learnt about in last blog post along with a new function VirtualQuery." /><meta property="og:description" content="In this blog, we are going to have a look at some basic memory related things that we can do with the API functions that we learnt about in last blog post along with a new function VirtualQuery." /><link rel="canonical" href="/posts/Windows-API-More-on-Virtual-Memory/" /><meta property="og:url" content="/posts/Windows-API-More-on-Virtual-Memory/" /><meta property="og:site_name" content="Mr. Rc’s blog" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2021-04-18T09:03:00+05:30" /><meta name="twitter:card" content="summary" /><meta property="twitter:title" content="Windows API - More on Virtual Memory." /><meta name="google-site-verification" content="google_meta_tag_verification" /> <script type="application/ld+json"> {"author":{"@type":"Person","name":"Mr. Rc"},"headline":"Windows API - More on Virtual Memory.","dateModified":"2021-04-18T09:03:00+05:30","datePublished":"2021-04-18T09:03:00+05:30","description":"In this blog, we are going to have a look at some basic memory related things that we can do with the API functions that we learnt about in last blog post along with a new function VirtualQuery.","url":"/posts/Windows-API-More-on-Virtual-Memory/","@type":"BlogPosting","mainEntityOfPage":{"@type":"WebPage","@id":"/posts/Windows-API-More-on-Virtual-Memory/"},"@context":"https://schema.org"}</script><title>Windows API - More on Virtual Memory. | Mr. Rc's blog</title><link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicons/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicons/favicon-16x16.png"><link rel="manifest" href="/assets/img/favicons/site.webmanifest"><link rel="shortcut icon" href="/assets/img/favicons/favicon.ico"><meta name="apple-mobile-web-app-title" content="Mr. Rc's blog"><meta name="application-name" content="Mr. Rc's blog"><meta name="msapplication-TileColor" content="#da532c"><meta name="msapplication-config" content="/assets/img/favicons/browserconfig.xml"><meta name="theme-color" content="#ffffff"><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://fonts.gstatic.com"><link rel="preconnect" href="https://www.google-analytics.com" crossorigin="use-credentials"><link rel="dns-prefetch" href="https://www.google-analytics.com"><link rel="preconnect" href="https://www.googletagmanager.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://www.googletagmanager.com"><link rel="preconnect" href="https://cdn.jsdelivr.net"><link rel="dns-prefetch" href="https://cdn.jsdelivr.net"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.0.0/dist/css/bootstrap.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.11.2/css/all.min.css"><link rel="stylesheet" href="/assets/css/style.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/magnific-popup@1.1.0/dist/magnific-popup.min.css"> <script src="https://cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script> <script data-ad-client="ca-pub-2858626085073914" async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script> <script defer src="https://cdn.jsdelivr.net/combine/npm/popper.js@1.15.0,npm/bootstrap@4/dist/js/bootstrap.min.js"></script> <script async src="https://cdn.jsdelivr.net/combine/npm/lozad/dist/lozad.min.js,npm/magnific-popup@1/dist/jquery.magnific-popup.min.js"></script> <script defer src="/assets/js/dist/post.min.js"></script> <script defer src="/app.js"></script> <script defer src="https://www.googletagmanager.com/gtag/js?id=UA-199874344-1"></script> <script> document.addEventListener("DOMContentLoaded", function(event) { window.dataLayer = window.dataLayer || []; function gtag(){dataLayer.push(arguments);} gtag('js', new Date()); gtag('config', 'UA-199874344-1'); }); </script><body data-spy="scroll" data-target="#toc"><div id="sidebar" class="d-flex flex-column align-items-end"><div class="profile-wrapper text-center"><div id="avatar"> <a href="/" alt="avatar" class="mx-auto"> <img src="https://i.ibb.co/6W31BDG/skull.jpg" alt="avatar" onerror="this.style.display='none'"> </a></div><div class="site-title mt-3"> <a href="/">Mr. Rc's blog</a></div><div class="site-subtitle font-italic">A collection of Mr. Rc's Blogs.</div></div><ul class="w-100"><li class="nav-item"> <a href="/" class="nav-link"> <i class="fa-fw fas fa-home ml-xl-3 mr-xl-3 unloaded"></i> <span>HOME</span> </a><li class="nav-item"> <a href="/categories/" class="nav-link"> <i class="fa-fw fas fa-stream ml-xl-3 mr-xl-3 unloaded"></i> <span>CATEGORIES</span> </a><li class="nav-item"> <a href="/tags/" class="nav-link"> <i class="fa-fw fas fa-tags ml-xl-3 mr-xl-3 unloaded"></i> <span>TAGS</span> </a><li class="nav-item"> <a href="/archives/" class="nav-link"> <i class="fa-fw fas fa-archive ml-xl-3 mr-xl-3 unloaded"></i> <span>ARCHIVES</span> </a><li class="nav-item"> <a href="/about/" class="nav-link"> <i class="fa-fw fas fa-info ml-xl-3 mr-xl-3 unloaded"></i> <span>ABOUT</span> </a></ul><div class="sidebar-bottom mt-auto d-flex flex-wrap justify-content-center"> <a href="https://github.com/HACKE-RC" aria-label="github" class="order-3" target="_blank" rel="noopener"> <i class="fab fa-github-alt"></i> </a> <a href="https://twitter.com/" aria-label="twitter" class="order-4" target="_blank" rel="noopener"> <i class="fab fa-twitter"></i> </a> <a href=" javascript:location.href = 'mailto:' + ['cr.retsim','gmail.com'].join('@')" aria-label="email" class="order-5" > <i class="fas fa-envelope"></i> </a> <a href="/feed.xml" aria-label="rss" class="order-6" > <i class="fas fa-rss"></i> </a> <span class="icon-border order-2"></span> <span id="mode-toggle-wrapper" class="order-1"> <i class="mode-toggle fas fa-adjust"></i> <script type="text/javascript"> class ModeToggle { static get MODE_KEY() { return "mode"; } static get DARK_MODE() { return "dark"; } static get LIGHT_MODE() { return "light"; } constructor() { if (this.hasMode) { if (this.isDarkMode) { if (!this.isSysDarkPrefer) { this.setDark(); } } else { if (this.isSysDarkPrefer) { this.setLight(); } } } var self = this; /* always follow the system prefers */ this.sysDarkPrefers.addListener(function() { if (self.hasMode) { if (self.isDarkMode) { if (!self.isSysDarkPrefer) { self.setDark(); } } else { if (self.isSysDarkPrefer) { self.setLight(); } } self.clearMode(); } self.updateMermaid(); }); } /* constructor() */ setDark() { $('html').attr(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE); } setLight() { $('html').attr(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE); } clearMode() { $('html').removeAttr(ModeToggle.MODE_KEY); sessionStorage.removeItem(ModeToggle.MODE_KEY); } get sysDarkPrefers() { return window.matchMedia("(prefers-color-scheme: dark)"); } get isSysDarkPrefer() { return this.sysDarkPrefers.matches; } get isDarkMode() { return this.mode == ModeToggle.DARK_MODE; } get isLightMode() { return this.mode == ModeToggle.LIGHT_MODE; } get hasMode() { return this.mode != null; } get mode() { return sessionStorage.getItem(ModeToggle.MODE_KEY); } /* get the current mode on screen */ get modeStatus() { if (this.isDarkMode || (!this.hasMode && this.isSysDarkPrefer) ) { return ModeToggle.DARK_MODE; } else { return ModeToggle.LIGHT_MODE; } } updateMermaid() { if (typeof mermaid !== "undefined") { let expectedTheme = (this.modeStatus === ModeToggle.DARK_MODE? "dark" : "default"); let config = { theme: expectedTheme }; /* re-render the SVG › <https://github.com/mermaid-js/mermaid/issues/311#issuecomment-332557344> */ $(".mermaid").each(function() { let svgCode = $(this).prev().children().html(); $(this).removeAttr("data-processed"); $(this).html(svgCode); }); mermaid.initialize(config); mermaid.init(undefined, ".mermaid"); } } flipMode() { if (this.hasMode) { if (this.isSysDarkPrefer) { if (this.isLightMode) { this.clearMode(); } else { this.setLight(); } } else { if (this.isDarkMode) { this.clearMode(); } else { this.setDark(); } } } else { if (this.isSysDarkPrefer) { this.setLight(); } else { this.setDark(); } } this.updateMermaid(); } /* flipMode() */ } /* ModeToggle */ let toggle = new ModeToggle(); $(".mode-toggle").click(function() { toggle.flipMode(); }); </script> </span></div></div><div id="topbar-wrapper" class="row justify-content-center topbar-down"><div id="topbar" class="col-11 d-flex h-100 align-items-center justify-content-between"> <span id="breadcrumb"> <span> <a href="/"> Posts </a> </span> <span>Windows API - More on Virtual Memory.</span> </span> <i id="sidebar-trigger" class="fas fa-bars fa-fw"></i><div id="topbar-title"> Post</div><i id="search-trigger" class="fas fa-search fa-fw"></i> <span id="search-wrapper" class="align-items-center"> <i class="fas fa-search fa-fw"></i> <input class="form-control" id="search-input" type="search" aria-label="search" autocomplete="off" placeholder="Search..."> <i class="fa fa-times-circle fa-fw" id="search-cleaner"></i> </span> <span id="search-cancel" >Cancel</span></div></div><div id="main-wrapper"><div id="main"><div class="row"><div id="post-wrapper" class="col-12 col-lg-11 col-xl-8"><div class="post pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><h1 data-toc-skip>Windows API - More on Virtual Memory.</h1><div class="post-meta text-muted d-flex flex-column"><div> <span class="semi-bold"> Mr. Rc </span> <span class="timeago " data-toggle="tooltip" data-placement="bottom" title="Sun, Apr 18, 2021, 9:03 AM +0530" prep="on" > Apr 18, 2021 <i class="unloaded">2021-04-18T09:03:00+05:30</i> </span></div><div> <span class="readtime" data-toggle="tooltip" data-placement="bottom" title="1419 words">7 min</span></div></div><div class="post-content"><p>In this blog, we are going to have a look at some basic memory related things that we can do with the API functions that we learnt about in last blog post along with a new function <code class="language-plaintext highlighter-rouge">VirtualQuery</code>.</p><p>Before we start, I want to tell you about a function from Windows API which is <code class="language-plaintext highlighter-rouge">GetLastError</code> from Windows API. It is used to get the error code of the last error that occurred and we can get more information about the error code by looking at the error code list which is available here : <a href="https://docs.microsoft.com/en-us/windows/win32/debug/system-error-codes#system-error-codes-1">System Error Codes - Win32 apps</a></p><h1 id="1-virtualquery">1. VirtualQuery</h1><p>This function is used to query the information of Virtual Memory allocated by <code class="language-plaintext highlighter-rouge">VirtualAlloc</code> and other Virtual Memory allocating functions.</p><p>This is the syntax for <code class="language-plaintext highlighter-rouge">VirtualQuery</code> function:</p><div class="language-c highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre><td class="rouge-code"><pre><span class="n">SIZE_T</span> <span class="nf">VirtualQuery</span><span class="p">(</span>
  <span class="n">LPCVOID</span>                   <span class="n">lpAddress</span><span class="p">,</span>
  <span class="n">PMEMORY_BASIC_INFORMATION</span> <span class="n">lpBuffer</span><span class="p">,</span>
  <span class="n">SIZE_T</span>                    <span class="n">dwLength</span>
<span class="p">);</span>
</pre></table></code></div></div><p>Forget about the function’s type (<code class="language-plaintext highlighter-rouge">SIZE_T</code>) for now. Let’s look at the arguments that are required…</p><p>The first argument is <code class="language-plaintext highlighter-rouge">lpAddress</code>, which I guess you already know if you are reading this blog. If you don’t know, then you can read the first part of Windows API series and learn about those things. It’s just the base address of Virtual Memory region that we allocated which is returned by <code class="language-plaintext highlighter-rouge">VirtualAlloc</code>.</p><p>The second argument is <code class="language-plaintext highlighter-rouge">lpBuffer</code>. This is a pointer to a special struct that is already defined in <code class="language-plaintext highlighter-rouge">winint.h</code> and which looks like this:</p><div class="language-c highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
</pre><td class="rouge-code"><pre><span class="k">typedef</span> <span class="k">struct</span> <span class="n">_MEMORY_BASIC_INFORMATION</span> <span class="p">{</span>
  <span class="n">PVOID</span>  <span class="n">BaseAddress</span><span class="p">;</span>
  <span class="n">PVOID</span>  <span class="n">AllocationBase</span><span class="p">;</span>
  <span class="n">DWORD</span>  <span class="n">AllocationProtect</span><span class="p">;</span>
  <span class="n">WORD</span>   <span class="n">PartitionId</span><span class="p">;</span>
  <span class="n">SIZE_T</span> <span class="n">RegionSize</span><span class="p">;</span>
  <span class="n">DWORD</span>  <span class="n">State</span><span class="p">;</span>
  <span class="n">DWORD</span>  <span class="n">Protect</span><span class="p">;</span>
  <span class="n">DWORD</span>  <span class="n">Type</span><span class="p">;</span>
<span class="p">}</span> <span class="n">MEMORY_BASIC_INFORMATION</span><span class="p">,</span> <span class="o">*</span><span class="n">PMEMORY_BASIC_INFORMATION</span><span class="p">;</span>
</pre></table></code></div></div><p>You can see this struct has some pretty useful members. We are going to use some of this to make a program that we are going to make in this blog. To define this struct in our program, we can just write <code class="language-plaintext highlighter-rouge">MEMORY_BASIC_INFORMATION info;</code> and this will define a struct with all this members. After making this struct, we will just pass the memory address of this struct in the <code class="language-plaintext highlighter-rouge">lpBuffer</code> argument.</p><p>The third argument is <code class="language-plaintext highlighter-rouge">dwLength</code>. If you have guessed this is the size of the memory region whose address we have to specify as the <code class="language-plaintext highlighter-rouge">lpAddress</code> argument, then sorry you’re wrong and I was too when I was reading about it for the first time. It is actually the <code class="language-plaintext highlighter-rouge">sizeof</code> the struct that we are going to pass into it.</p><h2 id="return-value">Return value</h2><p>Instead of returning something the function just updates the struct that we created.</p><h2 id="code-example-1">Code Example #1</h2><p>Now as we have done with understanding the things we are going to do, let’s code stuff. We are going to make a program that will give us the information about a memory region. Let me show you the code first, then I will explain:</p><div class="language-cpp highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
</pre><td class="rouge-code"><pre><span class="cp">#include &lt;Windows.h&gt;
#include &lt;stdio.h&gt;
</span>
<span class="kt">int</span> <span class="nf">main</span><span class="p">()</span>
<span class="p">{</span>
	<span class="n">MEMORY_BASIC_INFORMATION</span> <span class="n">info</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="kt">int</span> <span class="o">*</span><span class="n">vm</span> <span class="o">=</span> <span class="n">VirtualAlloc</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="n">MEM_COMMIT</span><span class="p">,</span> <span class="n">PAGE_READONLY</span><span class="p">);</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">VirtualQuery</span><span class="p">(</span><span class="n">vm</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">info</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">info</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ret</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="n">printf</span><span class="p">(</span><span class="s">"VirtualQuery failed</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
		<span class="n">printf</span><span class="p">(</span><span class="s">"The error code for the last error was %d"</span><span class="p">,</span> <span class="n">GetLastError</span><span class="p">());</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">info</span><span class="p">.</span><span class="n">AllocationProtect</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="k">case</span> <span class="n">PAGE_EXECUTE_READ</span><span class="p">:</span>
			<span class="n">printf</span><span class="p">(</span><span class="s">"Protection type : EXECUTE + READ</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">PAGE_READWRITE</span><span class="p">:</span>
			<span class="n">printf</span><span class="p">(</span><span class="s">"Protection type : READ + WRITE</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">PAGE_READONLY</span><span class="p">:</span>
			<span class="n">printf</span><span class="p">(</span><span class="s">"Protection type : READ</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="n">printf</span><span class="p">(</span><span class="s">"Not found"</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">info</span><span class="p">.</span><span class="n">State</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="k">case</span> <span class="n">MEM_COMMIT</span><span class="p">:</span>
			<span class="n">printf</span><span class="p">(</span><span class="s">"Region State : Committed"</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">MEM_FREE</span><span class="p">:</span>
			<span class="n">printf</span><span class="p">(</span><span class="s">"Region State : Free"</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">MEM_RESERVE</span><span class="p">:</span>
			<span class="n">printf</span><span class="p">(</span><span class="s">"Region State : Reserve"</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</pre></table></code></div></div><p>Don’t get scared by this code, this is actually so self-explanatory. If you have looked into the code, you have probably seen that I have used <code class="language-plaintext highlighter-rouge">Windows.h</code> instead of importing any other file which contains all those Windows API functions. That’s because we have included <code class="language-plaintext highlighter-rouge">Windows.h</code>, which contains all functions from the Windows API, all the common macros used by Windows programmers, and all the data types used by the various functions and subsystems. Let’s break down the code…</p><p>First, we have declared a variable of type <code class="language-plaintext highlighter-rouge">MEMORY_BASIC_INFORMATION</code>, which is the struct that we talked about, then we committed eight <em>bytes</em> of virtual memory which is read-only. After that, we used <code class="language-plaintext highlighter-rouge">VirtualQuery</code> function to get information about that memory region.</p><p>We gave the address of the memory region as our first parameter, then we gave the address of the info struct that will hold all the returned data from this function, then we gave it the size of our info struct.</p><p>Afterwards, we check if the function failed. If you are confused about how it is being checked, then the answer is simple, it checks if the function returned false. According to the documentation, the function returns a zero if it fails and 0 means false in C. So it’s just checking if the function is returning false. If the function fails, it will first print that the function is failed and then it will print the error code of the last error by printing the error from the <code class="language-plaintext highlighter-rouge">GetLastError</code> function and then return.</p><p>Then we have a switch-case clause where we are checking the value of <code class="language-plaintext highlighter-rouge">AllocationProtect</code> in our info struct. If you wonder how they are being checked with those constants which are defined nowhere, they are just constants which are already defined in <code class="language-plaintext highlighter-rouge">Windows.h</code>. Then we are checking the value of <code class="language-plaintext highlighter-rouge">State</code>, in our struct. Then we are just printing stuff. One thing to note is that we cannot compare the value with every type of protection type or every type of memory states, I have tried doing that but I was unsuccessful, so I am just adding the types that can be compared.</p><p>And that all our program does, Now let’s run it and check the output. This is the output:</p><div class="language-cpp highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre><td class="rouge-code"><pre><span class="n">Protection</span> <span class="n">type</span> <span class="o">:</span> <span class="n">READ</span>
<span class="n">Region</span> <span class="n">State</span> <span class="o">:</span> <span class="n">Committed</span>
</pre></table></code></div></div><p>As expected, we had hardcoded the page protection to be read-only and the page is committed. Let’s make this more interesting by looking at another more cooler example.</p><h2 id="code-example-2">Code Example #2</h2><p>So in this example, we are going to implement a functionality to get information from any memory region. This one is more fun. This is the code</p><div class="language-cpp highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
</pre><td class="rouge-code"><pre><span class="cp">#include &lt;Windows.h&gt;
#include &lt;stdio.h&gt;
</span>
<span class="kt">int</span> <span class="nf">main</span><span class="p">()</span>
<span class="p">{</span>
	<span class="n">MEMORY_BASIC_INFORMATION</span> <span class="n">info</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="k">const</span> <span class="kt">void</span> <span class="o">*</span><span class="n">location</span><span class="p">;</span>
	<span class="kt">int</span> <span class="o">*</span><span class="n">vm</span> <span class="o">=</span> <span class="n">VirtualAlloc</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="n">MEM_COMMIT</span><span class="p">,</span> <span class="n">PAGE_READONLY</span><span class="p">);</span>
	<span class="n">printf</span><span class="p">(</span><span class="s">"Address of memory returned by VirtualAlloc is %lu</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">vm</span><span class="p">);</span>
	<span class="n">printf</span><span class="p">(</span><span class="s">"Enter the memory address that you want to query: "</span><span class="p">);</span>
	<span class="n">scanf</span><span class="p">(</span><span class="s">"%lu"</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">location</span><span class="p">);</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">VirtualQuery</span><span class="p">(</span><span class="n">location</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">info</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">info</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ret</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="n">printf</span><span class="p">(</span><span class="s">"VirtualQuery failed</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
		<span class="n">printf</span><span class="p">(</span><span class="s">"The error code for the last error was %d"</span><span class="p">,</span> <span class="n">GetLastError</span><span class="p">());</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">printf</span><span class="p">(</span><span class="s">"Protection type : "</span><span class="p">);</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">info</span><span class="p">.</span><span class="n">AllocationProtect</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="k">case</span> <span class="n">PAGE_EXECUTE_READ</span><span class="p">:</span>
			<span class="n">printf</span><span class="p">(</span><span class="s">"EXECUTE + READ</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">PAGE_READWRITE</span><span class="p">:</span>
			<span class="n">printf</span><span class="p">(</span><span class="s">"READ + WRITE</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">PAGE_READONLY</span><span class="p">:</span>
			<span class="n">printf</span><span class="p">(</span><span class="s">"READ</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="n">printf</span><span class="p">(</span><span class="s">"Unknown</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">printf</span><span class="p">(</span><span class="s">"Region State : "</span><span class="p">);</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">info</span><span class="p">.</span><span class="n">State</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="k">case</span> <span class="n">MEM_COMMIT</span><span class="p">:</span>
			<span class="n">printf</span><span class="p">(</span><span class="s">"Committed"</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">MEM_FREE</span><span class="p">:</span>
			<span class="n">printf</span><span class="p">(</span><span class="s">"Free"</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">MEM_RESERVE</span><span class="p">:</span>
			<span class="n">printf</span><span class="p">(</span><span class="s">"Reserve"</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="n">printf</span><span class="p">(</span><span class="s">"Unknown"</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</pre></table></code></div></div><p>Not so much changed, let me explain. The code is almost same as the first code but here we first printed the memory address that we allocated using <code class="language-plaintext highlighter-rouge">VirtuaAlloc</code> and then we asked the user for a memory address. Instead of directly querying the memory address returned by <code class="language-plaintext highlighter-rouge">VirtualAlloc</code>, We first printed it and then asked for that memory address. By doing this, we can verify that the results of <code class="language-plaintext highlighter-rouge">VirtualQuery</code> by looking at what we hardcoded. Also, you can give this program any other memory address and it’ll query it’s information. Here is the output of the code:</p><div class="language-cpp highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre><td class="rouge-code"><pre><span class="n">Address</span> <span class="n">of</span> <span class="n">memory</span> <span class="n">returned</span> <span class="n">by</span> <span class="n">VirtualAlloc</span> <span class="n">is</span> <span class="mi">1572864</span>
<span class="n">Enter</span> <span class="n">the</span> <span class="n">memory</span> <span class="n">address</span> <span class="n">that</span> <span class="n">you</span> <span class="n">want</span> <span class="n">to</span> <span class="n">query</span><span class="o">:</span> <span class="mi">1572864</span> 
<span class="n">Protection</span> <span class="n">type</span> <span class="o">:</span> <span class="n">READ</span>  
<span class="n">Region</span> <span class="n">State</span> <span class="o">:</span> <span class="n">Committed</span>
</pre></table></code></div></div><p>And as we expected, we hardcoded the protection type as READ-ONLY and Region state as Committed and it gave us correct information. Coding this was fun and I also recommend you to make something with all the Memory API related functions that we learnt about.</p><p>I hope you liked this one, meet you in the next one!</p></div><div class="post-tail-wrapper text-muted"><div class="post-meta mb-3"> <i class="far fa-folder-open fa-fw mr-1"></i> <a href='/categories/programming/'>Programming</a>, <a href='/categories/windows/'>Windows</a>, <a href='/categories/windows-internals/'>Windows Internals</a>, <a href='/categories/winapi/'>WinAPI</a></div><div class="post-tags"> <i class="fa fa-tags fa-fw mr-1"></i> <a href="/tags/windows/" class="post-tag no-text-decoration" >Windows</a> <a href="/tags/windows-api-series/" class="post-tag no-text-decoration" >Windows API Series</a> <a href="/tags/virtual-memory-management/" class="post-tag no-text-decoration" >Virtual Memory Management</a></div><div class="post-tail-bottom d-flex justify-content-between align-items-center mt-3 pt-5 pb-2"><div class="license-wrapper"> This post is licensed under <a href="https://creativecommons.org/licenses/by/4.0/">CC BY 4.0</a> by the author.</div><div class="share-wrapper"> <span class="share-label text-muted mr-1">Share</span> <span class="share-icons"> <a href="https://twitter.com/intent/tweet?text=Windows API - More on Virtual Memory. - Mr. Rc's blog&url=/posts/Windows-API-More-on-Virtual-Memory/" data-toggle="tooltip" data-placement="top" title="Twitter" target="_blank" rel="noopener" aria-label="Twitter"> <i class="fa-fw fab fa-twitter"></i> </a> <a href="https://www.facebook.com/sharer/sharer.php?title=Windows API - More on Virtual Memory. - Mr. Rc's blog&u=/posts/Windows-API-More-on-Virtual-Memory/" data-toggle="tooltip" data-placement="top" title="Facebook" target="_blank" rel="noopener" aria-label="Facebook"> <i class="fa-fw fab fa-facebook-square"></i> </a> <a href="https://telegram.me/share?text=Windows API - More on Virtual Memory. - Mr. Rc's blog&url=/posts/Windows-API-More-on-Virtual-Memory/" data-toggle="tooltip" data-placement="top" title="Telegram" target="_blank" rel="noopener" aria-label="Telegram"> <i class="fa-fw fab fa-telegram"></i> </a> <i class="fa-fw fas fa-link small" onclick="copyLink()" data-toggle="tooltip" data-placement="top" title="Copy link"></i> </span></div></div></div></div></div><div id="panel-wrapper" class="col-xl-3 pl-2 text-muted topbar-down"><div class="access"><div id="access-lastmod" class="post"> <span>Recent Update</span><ul class="post-content pl-0 pb-1 ml-1 mt-2"><li><a href="/posts/WinAPI-Using-Registry-Playing-With-Env-Variables/">Windows API - Let's use the register to change our Environment!</a><li><a href="/posts/WinAPI-Environment-Variables/">Windows API - Let's Play with the Windows Environment Variables!</a></ul></div><div id="access-tags"> <span>Trending Tags</span><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/windows/">Windows</a> <a class="post-tag" href="/tags/windows-api-series/">Windows API Series</a> <a class="post-tag" href="/tags/virtual-memory-management/">Virtual Memory Management</a> <a class="post-tag" href="/tags/heap-api/">Heap API</a> <a class="post-tag" href="/tags/assembly/">Assembly</a> <a class="post-tag" href="/tags/operating-system/">Operating system</a> <a class="post-tag" href="/tags/windows-registry/">Windows Registry</a></div></div></div><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.js"></script><div id="toc-wrapper" class="pl-0 pr-4 mb-5"> <span class="pl-3 pt-2 mb-2">Contents</span><nav id="toc" data-toggle="toc"></nav></div></div></div><div class="row"><div class="col-12 col-lg-11 col-xl-8"><div id="post-extend-wrapper" class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><div id="related-posts" class="mt-5 mb-2 mb-sm-4"><h3 class="pt-2 mt-1 mb-4 ml-1" data-toc-skip>Further Reading</h3><div class="card-deck mb-4"><div class="card"> <a href="/posts/Windows-API-Basics-of-Virtual-Memory-Management-API/"><div class="card-body"> <span class="timeago small" > Apr 15, 2021 <i class="unloaded">2021-04-15T09:03:00+05:30</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Windows API - Basics of Virtual Memory Management API.</h3><div class="text-muted small"><p> The Virtual Memory Manager in Windows (WMM) is available for user mode programs and can be used by the Win32 APIs to allocate memory and free them in the user space. From this blog, I am going to ...</p></div></div></a></div><div class="card"> <a href="/posts/WinAPI-Environment-Variables/"><div class="card-body"> <span class="timeago small" > Jun 18, 2021 <i class="unloaded">2021-06-18T09:03:00+05:30</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Windows API - Let's Play with the Windows Environment Variables!</h3><div class="text-muted small"><p> In this blog, we are going to have a look at two functions that let us manipulate the Environment Variables of our Windows Machine. There are only two functions that are related to Environment Vari...</p></div></div></a></div><div class="card"> <a href="/posts/Windows-API-Heap-Functions/"><div class="card-body"> <span class="timeago small" > Apr 26, 2021 <i class="unloaded">2021-04-26T09:03:00+05:30</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Windows API - Let's learn about heap in deep!</h3><div class="text-muted small"><p> In this blog, We are continuing our series and going to study some Windows API functions related to Heap. We’ll see how to use this functions and how they can be useful to us with code examples and...</p></div></div></a></div></div></div><div class="post-navigation d-flex justify-content-between"> <a href="/posts/Windows-API-Basics-of-Virtual-Memory-Management-API/" class="btn btn-outline-primary" prompt="Older"><p>Windows API - Basics of Virtual Memory Management API.</p></a> <a href="/posts/Windows-API-Heap-Functions/" class="btn btn-outline-primary" prompt="Newer"><p>Windows API - Let's learn about heap in deep!</p></a></div></div></div></div><footer class="d-flex w-100 justify-content-center"><div class="d-flex justify-content-between align-items-center"><div class="footer-left"><p class="mb-0"> © 2022 <a href="https://twitter.com/coder_rc">Mr. Rc</a>. <span data-toggle="tooltip" data-placement="top" title="Except where otherwise noted, the blog posts on this site are licensed under the Creative Commons Attribution 4.0 International (CC BY 4.0) License by the author.">Some rights reserved.</span></p></div><div class="footer-right"><p class="mb-0"> Powered by <a href="https://jekyllrb.com" target="_blank" rel="noopener">Jekyll</a> with <a href="https://github.com/cotes2020/jekyll-theme-chirpy" target="_blank" rel="noopener">Chirpy</a> theme.</p></div></div></footer></div><div id="search-result-wrapper" class="d-flex justify-content-center unloaded"><div class="col-12 col-sm-11 post-content"><div id="search-hints"><h4 class="text-muted mb-4">Trending Tags</h4><a class="post-tag" href="/tags/windows/">Windows</a> <a class="post-tag" href="/tags/windows-api-series/">Windows API Series</a> <a class="post-tag" href="/tags/virtual-memory-management/">Virtual Memory Management</a> <a class="post-tag" href="/tags/heap-api/">Heap API</a> <a class="post-tag" href="/tags/assembly/">Assembly</a> <a class="post-tag" href="/tags/operating-system/">Operating system</a> <a class="post-tag" href="/tags/windows-registry/">Windows Registry</a></div><div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div></div></div></div><div id="mask"></div><a id="back-to-top" href="#" aria-label="back-to-top" class="btn btn-lg btn-box-shadow" role="button"> <i class="fas fa-angle-up"></i> </a> <script src="https://cdn.jsdelivr.net/npm/simple-jekyll-search@1.7.3/dest/simple-jekyll-search.min.js"></script> <script> SimpleJekyllSearch({ searchInput: document.getElementById('search-input'), resultsContainer: document.getElementById('search-results'), json: '/assets/js/data/search.json', searchResultTemplate: '<div class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-lg-4 pr-lg-4 pl-xl-0 pr-xl-0"> <a href="{url}">{title}</a><div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1"> {categories} {tags}</div><p>{snippet}</p></div>', noResultsText: '<p class="mt-5">Oops! No result founds.</p>', templateMiddleware: function(prop, value, template) { if (prop === 'categories') { if (value === '') { return `${value}`; } else { return `<div class="mr-sm-4"><i class="far fa-folder fa-fw"></i>${value}</div>`; } } if (prop === 'tags') { if (value === '') { return `${value}`; } else { return `<div><i class="fa fa-tag fa-fw"></i>${value}</div>`; } } } }); </script>
